<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>皮克敏函數探險隊</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --pikmin-red: #e53935;
            --pikmin-yellow: #fdd835;
            --pikmin-blue: #1e88e5;
            --earth-brown: #795548;
            --grass-green: #558b2f;
            --ui-light: #f1f8e9;
        }

        /* === 基礎設定 === */
        body {
            font-family: 'Nunito', Arial, sans-serif;
            /* 背景：從泥土到草地的漸層 */
            background: linear-gradient(to bottom, var(--earth-brown) 20%, var(--grass-green) 100%);
            margin: 0;
            padding: 0;
            color: #333;
            overflow: hidden; /* 禁止捲動 */
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            touch-action: none; /* 優化觸控 */
        }

        /* === 頂部資訊列 (HUD) === */
        .hud {
            display: flex;
            justify-content: space-between;
            width: 95%;
            padding: 10px 0;
            z-index: 10;
        }
        .hud-item {
            background: rgba(255, 255, 255, 0.95);
            padding: 8px 15px;
            border-radius: 25px; /* 圓潤造型 */
            text-align: center;
            font-size: 14px;
            font-weight: 900;
            box-shadow: 0 4px rgba(0,0,0,0.1);
            border: 2px solid var(--grass-green);
        }
        .hud-item span { display: block; font-size: 20px; color: var(--pikmin-red); }
        .hud-item.score span { color: var(--pikmin-yellow); text-shadow: 1px 1px 0 #f57f17;}

        /* === 題目區 === */
        .question-box {
            background: #c5e1a5; /* 嫩葉綠 */
            border: 4px solid #fff;
            border-radius: 20px;
            padding: 12px;
            margin: 5px 0;
            text-align: center;
            width: 90%;
            font-weight: 900;
            color: #33691e;
            box-shadow: 0 4px rgba(0,0,0,0.1);
        }
        .highlight {
            background: #fff;
            padding: 4px 10px;
            border-radius: 10px;
            color: var(--pikmin-blue);
            display: inline-block;
            border: 2px solid #aed581;
        }

        /* === 遊戲畫布區 === */
        .game-area {
            position: relative;
            background: #fff;
            border: 5px solid #fff;
            border-radius: 0 0 25px 25px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
            margin-bottom: 5px;
            overflow: hidden;
        }
        canvas {
            background-color: #fbe9e7; /* 淡淡的泥土底色 */
            display: block;
        }

        /* === 底部鍵盤區 === */
        .keypad-container {
            flex-grow: 1;
            width: 100%;
            background-color: rgba(255,255,255,0.9);
            padding-top: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            border-top: 6px solid var(--earth-brown);
            border-radius: 30px 30px 0 0;
        }

        /* 輸入框：氣泡造型 */
        #displayInput {
            width: 220px;
            height: 50px;
            background: #fff;
            color: var(--pikmin-red);
            font-size: 28px;
            font-weight: 900;
            border: 4px solid var(--pikmin-yellow);
            border-radius: 30px;
            margin-bottom: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
        }

        /* 按鈕網格 */
        .keypad {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            width: 92%;
            max-width: 450px;
        }
        /* 按鈕：像果實一樣的圓形 */
        .key {
            background: #fff;
            border: none;
            box-shadow: 0 5px #cfd8dc;
            height: 55px;
            font-size: 22px;
            font-family: 'Nunito', sans-serif;
            font-weight: 900;
            border-radius: 50%; 
            cursor: pointer;
            color: #546e7a;
            transition: all 0.1s;
        }
        .key:active { transform: translateY(3px); box-shadow: 0 2px #cfd8dc; }
        
        /* 功能鍵 */
        .key-enter {
            grid-column: span 2;
            border-radius: 30px;
            background: var(--pikmin-red); /* 紅色負責戰鬥 */
            color: white;
            box-shadow: 0 5px #c62828;
        }
        .key-enter:active { box-shadow: 0 2px #c62828; }

        .key-del { background: #546e7a; color: white; box-shadow: 0 5px #37474f; }
        .key-minus { background: var(--pikmin-blue); color: white; box-shadow: 0 5px #1565c0; }

        /* === 遮罩與開始按鈕 === */
        #overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(85, 139, 47, 0.95); /* 深綠色半透明 */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            text-align: center;
            color: white;
        }
        #overlay h1 {
            color: var(--pikmin-yellow);
            font-size: 36px;
            text-shadow: 2px 2px 0 #33691e;
            margin-bottom: 10px;
        }
        .btn-start {
            margin-top: 25px;
            padding: 15px 40px;
            font-size: 22px;
            font-weight: 900;
            font-family: 'Nunito', sans-serif;
            background: var(--pikmin-red);
            color: #fff;
            border: 4px solid #fff;
            border-radius: 40px;
            cursor: pointer;
            box-shadow: 0 6px rgba(0,0,0,0.2);
        }
        .btn-start:active { transform: translateY(3px); box-shadow: 0 3px rgba(0,0,0,0.2); }

        /* 訊息提示 */
        #message {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            font-weight: 900;
            color: #fff;
            padding: 12px 25px;
            border-radius: 15px;
            pointer-events: none;
            display: none;
            z-index: 50;
            white-space: nowrap;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>

    <div class="hud">
        <div class="hud-item score">波可(Poko)<br><span id="scoreDisplay">0</span></div>
        <div class="hud-item">失誤<br><span id="strikeDisplay">0</span>/3</div>
        <div class="hud-item">時間<br><span id="timeDisplay">180</span></div>
    </div>

    <div class="question-box">
        <div style="font-size:14px; margin-bottom:5px; opacity:0.8;">隊長指令</div>
        <span id="eqDisplay" class="highlight">y = ?</span>
        <span style="margin: 0 10px;">目標位置</span>
        <span id="targetDisplay" class="highlight">x = ?</span>
    </div>

    <div class="game-area">
        <canvas id="gameCanvas" width="340" height="240"></canvas>
        <div id="message"></div>
    </div>

    <div class="keypad-container">
        <div id="displayInput">?</div>
        <div class="keypad">
            <button class="key" onclick="inputNum('1')">1</button>
            <button class="key" onclick="inputNum('2')">2</button>
            <button class="key" onclick="inputNum('3')">3</button>
            <button class="key key-minus" onclick="inputNum('-')">-</button>

            <button class="key" onclick="inputNum('4')">4</button>
            <button class="key" onclick="inputNum('5')">5</button>
            <button class="key" onclick="inputNum('6')">6</button>
            <button class="key key-del" onclick="inputNum('C')">←</button>

            <button class="key" onclick="inputNum('7')">7</button>
            <button class="key" onclick="inputNum('8')">8</button>
            <button class="key" onclick="inputNum('9')">9</button>
            <button class="key" onclick="inputNum('0')">0</button>
            
            <button class="key key-enter" id="actionBtn" onclick="submitAnswer()">投擲皮克敏!</button>
            <button class="key key-enter" id="nextBtn" onclick="nextLevel()" style="display:none; background:var(--pikmin-blue); box-shadow: 0 5px #1565c0;">尋找下個目標</button>
        </div>
    </div>

    <div id="overlay">
        <h1>皮克敏<br>函數探險隊</h1>
        <p style="font-size:18px; font-weight:bold;">計算高度，指揮皮克敏進攻！</p>
        <p style="opacity: 0.8; margin-top: 5px;">(限時3分鐘，連續失誤3次結束)</p>
        <button class="btn-start" onclick="startGame()">開始探險</button>
    </div>

<script>
    // 取得元素
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const displayInput = document.getElementById('displayInput');
    const msgDiv = document.getElementById('message');
    const scoreDisplay = document.getElementById('scoreDisplay');
    const strikeDisplay = document.getElementById('strikeDisplay');
    const timeDisplay = document.getElementById('timeDisplay');
    
    // 遊戲參數
    let scale = 15;
    let centerX = 170; // 340 / 2
    let centerY = 120; // 240 / 2
    
    // 遊戲狀態
    let score = 0;
    let strikes = 0;
    let timeLeft = 180;
    let timerInterval = null;
    let isGameActive = false;
    
    // 題目參數
    let currentInput = "";
    let slope = 0, intercept = 0, targetX = 0, correctY = 0;

    // --- 遊戲流程 ---

    function startGame() {
        document.getElementById('overlay').style.display = 'none';
        score = 0;
        strikes = 0;
        timeLeft = 180;
        isGameActive = true;
        
        updateUI();
        
        // 計時器
        if(timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(function() {
            if(!isGameActive) return;
            timeLeft--;
            timeDisplay.innerText = timeLeft;
            if(timeLeft <= 0) gameOver("探險時間結束");
        }, 1000);

        nextLevel();
    }

    function nextLevel() {
        isGameActive = true;
        currentInput = "";
        displayInput.innerText = "?";
        msgDiv.style.display = 'none';
        
        // 按鈕狀態重置
        document.getElementById('actionBtn').style.display = 'block';
        document.getElementById('nextBtn').style.display = 'none';

        generateQuestion();
        drawScene(null);
    }

    function generateQuestion() {
        // 隨機出題
        slope = Math.floor(Math.random() * 5) - 2; // -2 ~ 2
        intercept = Math.floor(Math.random() * 9) - 4; // -4 ~ 4
        targetX = Math.floor(Math.random() * 9) - 4; // -4 ~ 4
        
        // 避免太無聊的題目 (y=0)
        if(slope === 0 && Math.random() > 0.5) slope = 1;

        correctY = slope * targetX + intercept;
        
        // 組合字串
        let sign = intercept >= 0 ? "+ " : "- ";
        let txt = "y = " + slope + "x " + sign + Math.abs(intercept);
        
        if (slope === 0) txt = "y = " + intercept;
        else if (slope === 1) txt = "y = x " + sign + Math.abs(intercept);
        else if (slope === -1) txt = "y = -x " + sign + Math.abs(intercept);
        else if (intercept === 0) txt = "y = " + slope + "x";

        document.getElementById('eqDisplay').innerText = txt;
        document.getElementById('targetDisplay').innerText = "x = " + targetX;
    }

    function inputNum(key) {
        if (!isGameActive) return;
        
        if (key === 'C') {
            currentInput = currentInput.slice(0, -1);
        } else if (key === '-') {
            if (currentInput === "") currentInput = "-";
            else if (currentInput === "-") currentInput = "";
        } else {
            if (currentInput.length < 4) currentInput += key;
        }
        displayInput.innerText = currentInput === "" ? "?" : currentInput;
    }

    function submitAnswer() {
        if (currentInput === "" || currentInput === "-") return;
        
        let userVal = parseInt(currentInput);
        isGameActive = false; // 鎖定操作
        
        drawScene(userVal); // 繪製結果

        if (userVal === correctY) {
            score += 100;
            showMsg("命中! 開花啦!", "#558b2f"); // 綠色背景提示
        } else {
            strikes++;
            showMsg("沒丟中...嗚嗚", "#c62828"); // 紅色背景提示
        }
        updateUI();

        // 判斷是否遊戲結束
        if (strikes >= 3) {
            setTimeout(function() { gameOver("皮克敏全軍覆沒..."); }, 1000);
        } else {
            document.getElementById('actionBtn').style.display = 'none';
            document.getElementById('nextBtn').style.display = 'block';
        }
    }

    function showMsg(text, bgColor) {
        msgDiv.innerText = text;
        msgDiv.style.backgroundColor = bgColor;
        msgDiv.style.display = 'block';
    }

    function updateUI() {
        scoreDisplay.innerText = score;
        strikeDisplay.innerText = strikes;
        timeDisplay.innerText = timeLeft;
    }

    function gameOver(reason) {
        isGameActive = false;
        clearInterval(timerInterval);
        document.querySelector('#overlay h1').innerText = reason;
        document.querySelector('#overlay p').innerHTML = "最終波可數: " + score;
        document.querySelector('.btn-start').innerText = "再次挑戰";
        document.getElementById('overlay').style.display = 'flex';
    }

    // --- 繪圖功能 (穩定版：只用基礎圖形組合) ---

    function drawScene(userY) {
        // 清空背景
        ctx.fillStyle = "#fbe9e7";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // 畫淡色網格
        ctx.strokeStyle = "rgba(121, 85, 72, 0.2)"; // 淡棕色
        ctx.lineWidth = 1;
        for(let x = 0; x <= canvas.width; x += scale) {
            ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, canvas.height); ctx.stroke();
        }
        for(let y = 0; y <= canvas.height; y += scale) {
            ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(canvas.width, y); ctx.stroke();
        }

        // 畫座標軸 (深棕色)
        ctx.strokeStyle = "#5d4037";
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(0, centerY); ctx.lineTo(canvas.width, centerY); // X軸
        ctx.moveTo(centerX, 0); ctx.lineTo(centerX, canvas.height); // Y軸
        ctx.stroke();

        // 畫目標掃描線
        let px = centerX + targetX * scale;
        ctx.strokeStyle = "rgba(229, 57, 53, 0.5)"; // 紅色半透明
        ctx.setLineDash([5, 5]);
        ctx.beginPath(); ctx.moveTo(px, 0); ctx.lineTo(px, canvas.height); ctx.stroke();
        ctx.setLineDash([]);

        // 畫敵人 (簡化版紅色恰比 - 用基礎圓形組合)
        ctx.fillStyle = "#d32f2f"; // 身體紅
        ctx.beginPath(); ctx.arc(px, centerY, 12, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = "#fff"; // 眼睛白
        ctx.beginPath(); ctx.arc(px-5, centerY-4, 4, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(px+5, centerY-4, 4, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = "#000"; // 眼珠黑
        ctx.beginPath(); ctx.arc(px-5, centerY-4, 2, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(px+5, centerY-4, 2, 0, Math.PI*2); ctx.fill();


        // 如果玩家已經輸入答案
        if (userY !== null) {
            let py = centerY - userY * scale;
            let isCorrect = (userY === correctY);

            // 畫軌跡線
            ctx.lineWidth = 3;
            ctx.beginPath();
            let x1 = -20; let y1 = slope * x1 + intercept;
            let x2 = 20; let y2 = slope * x2 + intercept;
            
            if (isCorrect) {
                // 答對：畫出綠色藤蔓軌跡
                ctx.strokeStyle = "#558b2f"; 
                ctx.moveTo(centerX + x1 * scale, centerY - y1 * scale);
                ctx.lineTo(centerX + x2 * scale, centerY - y2 * scale);
                ctx.stroke();
                
                // 畫命中點：紅色皮克敏 + 黃色花朵
                // 皮克敏頭
                ctx.fillStyle = "#e53935"; 
                ctx.beginPath(); ctx.arc(px, py, 7, 0, Math.PI*2); ctx.fill();
                // 眼睛
                ctx.fillStyle = "#fff";
                ctx.beginPath(); ctx.arc(px-2, py-1, 2, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(px+2, py-1, 2, 0, Math.PI*2); ctx.fill();
                
                // 頭上的花 (黃色圓形)
                ctx.fillStyle = "#fdd835";
                ctx.beginPath(); ctx.arc(px, py-12, 5, 0, Math.PI*2); ctx.fill();
                // 花梗
                ctx.strokeStyle = "#558b2f"; ctx.lineWidth=2;
                ctx.beginPath(); ctx.moveTo(px, py-7); ctx.lineTo(px, py-12); ctx.stroke();

            } else {
                // 答錯：畫出灰色虛線軌跡
                ctx.strokeStyle = "#90a4ae";
                ctx.setLineDash([3, 3]);
                ctx.beginPath(); ctx.moveTo(0, py); ctx.lineTo(px, py); ctx.stroke();
                ctx.setLineDash([]);

                // 畫失敗點：藍色皮克敏 (憂鬱)
                ctx.fillStyle = "#1e88e5";
                ctx.beginPath(); ctx.arc(px, py, 7, 0, Math.PI*2); ctx.fill();
                // 眼睛 (瞇瞇眼表示難過)
                ctx.strokeStyle = "#fff"; ctx.lineWidth = 2;
                ctx.beginPath(); ctx.moveTo(px-4, py); ctx.lineTo(px-1, py); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(px+1, py); ctx.lineTo(px+4, py); ctx.stroke();
                
                // 標記正確位置 (綠色發光圈)
                let trueY = centerY - correctY * scale;
                ctx.strokeStyle = "#76ff03";
                ctx.lineWidth = 3;
                ctx.beginPath(); ctx.arc(px, trueY, 10, 0, Math.PI*2); ctx.stroke();
            }
        }
    }

    // 初始化畫面
    drawScene(null);

</script>
</body>
</html>
