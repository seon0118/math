<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>çš®å…‹æ•å‡½æ•¸å¤§é€²æ“Šï¼šç´«è‰²å¤§åŠ›å£«ç‰ˆ</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --pikmin-red: #ff3d00;
            --pikmin-yellow: #ffea00;
            --pikmin-blue: #2979ff;
            --pikmin-purple: #9c27b0; /* ç´«è‰²çš®å…‹æ• */
            --leaf-green: #64dd17;
            --earth-brown: #5d4037;
            --bg-top: #8d6e63;
            --bg-bot: #33691e;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Nunito', Arial, sans-serif;
            background: linear-gradient(to bottom, var(--bg-top) 0%, var(--bg-bot) 100%);
            margin: 0;
            padding: 0;
            color: #333;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            justify-content: center;
        }

        .app-container {
            width: 100%;
            max-width: 600px;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        /* HUD */
        .hud {
            display: flex;
            justify-content: space-between;
            width: 95%;
            padding: 10px 0;
            z-index: 10;
        }
        .hud-item {
            background: rgba(255, 255, 255, 0.9);
            padding: 5px 10px;
            border-radius: 20px;
            text-align: center;
            font-weight: 900;
            box-shadow: 0 4px rgba(0,0,0,0.2);
            border: 2px solid #aed581;
            flex: 1;
            margin: 0 5px;
            font-size: 14px;
        }
        .hud-item span { display: block; font-size: 18px; color: var(--pikmin-red); }
        
        /* é—œå¡æ¨™ç±¤ */
        .level-badge {
            position: absolute;
            top: 60px;
            background: var(--pikmin-purple); /* æ”¹æˆç´«è‰²æ¨™ç±¤ */
            color: #fff;
            padding: 5px 15px;
            border-radius: 15px;
            font-weight: 900;
            box-shadow: 0 3px rgba(0,0,0,0.2);
            z-index: 5;
            font-size: 14px;
            border: 2px solid #fff;
        }

        /* é¡Œç›®å€ */
        .question-box {
            background: #dcedc8;
            border: 4px solid #fff;
            border-radius: 20px;
            padding: 10px;
            margin-top: 35px;
            margin-bottom: 5px;
            text-align: center;
            width: 95%;
            font-weight: 900;
            color: #33691e;
            box-shadow: 0 4px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .highlight {
            background: #fff;
            padding: 2px 8px;
            border-radius: 10px;
            color: var(--pikmin-purple); /* é¡Œç›®é‡é»è‰²ä¹Ÿæ”¹ç´« */
            border: 2px solid #aed581;
            font-size: 20px;
            margin: 0 5px;
        }

        /* ç•«å¸ƒ */
        .game-area {
            position: relative;
            background: #fff;
            border: 5px solid #fff;
            border-radius: 0 0 25px 25px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
            width: 95%;
            flex-shrink: 1;
            margin-bottom: 10px;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        canvas {
            background-color: #f1f8e9;
            display: block;
            width: 100%;
        }

        /* æ§åˆ¶å€ */
        .control-panel {
            flex-grow: 1;
            width: 100%;
            background-color: rgba(255,255,255,0.95);
            padding: 10px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            border-top: 6px solid var(--earth-brown);
            border-radius: 30px 30px 0 0;
            overflow-y: auto;
        }

        .key {
            background: #fff;
            border: none;
            box-shadow: 0 4px #b0bec5;
            font-size: 20px;
            font-weight: 900;
            border-radius: 50%;
            cursor: pointer;
            color: #455a64;
            width: 100%; height: 100%;
        }
        .key:active { transform: translateY(2px); box-shadow: 0 1px #b0bec5; }
        
        /* ç¢ºèªéµæ”¹æˆç´«è‰² */
        .key-enter { grid-column: span 2; background: var(--pikmin-purple); color: white; border-radius: 30px; box-shadow: 0 4px #7b1fa2;}
        .key-enter:active { box-shadow: 0 2px #7b1fa2; }

        /* Level 1 */
        #level1-controls { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; }
        #displayInput {
            width: 60%; height: 50px;
            background: #fff; color: var(--pikmin-purple);
            font-size: 28px; font-weight: 900;
            border: 3px solid var(--pikmin-purple);
            border-radius: 25px; margin-bottom: 10px;
            display: flex; justify-content: center; align-items: center;
        }
        .keypad { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; width: 90%; height: 100%; max-height: 280px; }

        /* Level 2 */
        #level2-controls { display: none; width: 100%; flex-direction: column; align-items: center; padding: 10px; height: 100%; }
        .option-btn {
            width: 95%; margin-bottom: 12px; padding: 15px;
            font-size: 18px; font-weight: 900; color: white;
            border: none; border-radius: 25px; cursor: pointer;
            box-shadow: 0 4px rgba(0,0,0,0.2);
            display: flex; justify-content: space-between; align-items: center;
        }
        .opt-red { background-color: var(--pikmin-red); }
        .opt-yellow { background-color: var(--pikmin-yellow); color: #333; }
        .opt-blue { background-color: var(--pikmin-blue); }

        /* é®ç½© */
        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(51, 105, 30, 0.98);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 100; text-align: center; color: white;
        }
        .btn-start {
            margin-top: 25px; padding: 15px 40px;
            font-size: 22px; font-weight: 900;
            background: var(--pikmin-purple); color: #fff;
            border: 4px solid #fff; border-radius: 40px; cursor: pointer;
            box-shadow: 0 5px rgba(0,0,0,0.3);
        }

        #message {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 24px; font-weight: 900; color: #fff;
            padding: 15px 30px; border-radius: 20px; display: none; z-index: 50;
            white-space: nowrap; box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            border: 3px solid #fff;
        }
    </style>
</head>
<body>

<div class="app-container">
    <div class="hud">
        <div class="hud-item score">Poko<br><span id="scoreDisplay">0</span></div>
        <div class="hud-item">å¤±èª¤<br><span id="strikeDisplay">0</span>/3</div>
        <div class="hud-item">æ™‚é–“<br><span id="timeDisplay">--</span></div>
    </div>

    <div id="levelBadge" class="level-badge">LEVEL 1</div>

    <div class="question-box">
        <div id="qText" style="font-size:12px; margin-bottom:2px; opacity:0.8;"></div>
        <div id="qContent"></div>
    </div>

    <div class="game-area" id="canvasContainer">
        <canvas id="gameCanvas"></canvas>
        <div id="message"></div>
    </div>

    <div class="control-panel">
        <div id="level1-controls">
            <div id="displayInput">?</div>
            <div class="keypad">
                <button class="key" onclick="inputNum('1')">1</button>
                <button class="key" onclick="inputNum('2')">2</button>
                <button class="key" onclick="inputNum('3')">3</button>
                <button class="key" style="background:var(--pikmin-blue); color:white;" onclick="inputNum('-')">-</button>
                <button class="key" onclick="inputNum('4')">4</button>
                <button class="key" onclick="inputNum('5')">5</button>
                <button class="key" onclick="inputNum('6')">6</button>
                <button class="key" style="background:#546e7a; color:white;" onclick="inputNum('C')">â†</button>
                <button class="key" onclick="inputNum('7')">7</button>
                <button class="key" onclick="inputNum('8')">8</button>
                <button class="key" onclick="inputNum('9')">9</button>
                <button class="key" onclick="inputNum('0')">0</button>
                <button class="key key-enter" id="l1-submit" onclick="submitLevel1()">ç™¼å°„ç´«è‰²çš®å…‹æ•</button>
                <button class="key key-enter" id="l1-next" onclick="nextLevel1Question()" style="display:none; background:var(--pikmin-blue);">å°‹æ‰¾ä¸‹éš»æ€ªç‰©</button>
            </div>
        </div>

        <div id="level2-controls">
            <div style="font-size:16px; margin-bottom:15px; color:#33691e; font-weight:bold;">é¸æ“‡æ­£ç¢ºçš„è·¯å¾‘é€²æ”»ï¼š</div>
            <button class="option-btn opt-red" onclick="checkLevel2(0)">
                <span class="opt-icon">ğŸ”´</span> <span id="opt-0-text">Option A</span>
            </button>
            <button class="option-btn opt-yellow" onclick="checkLevel2(1)">
                <span class="opt-icon">ğŸŸ¡</span> <span id="opt-1-text">Option B</span>
            </button>
            <button class="option-btn opt-blue" onclick="checkLevel2(2)">
                <span class="opt-icon">ğŸ”µ</span> <span id="opt-2-text">Option C</span>
            </button>
            <button class="option-btn" id="l2-next" onclick="nextLevel2Question()" style="display:none; background:#558b2f; justify-content:center;">ä¸‹ä¸€é—œ â–¶</button>
        </div>
    </div>
</div>

<div id="overlay">
    <h1 id="ov-title" style="color:#ffea00; margin-bottom:10px; font-size:36px; text-shadow: 2px 2px #33691e;">çš®å…‹æ•<br>å‡½æ•¸å¤§é€²æ“Š</h1>
    <p id="ov-desc" style="font-size:18px; margin-bottom:20px;">ä½¿ç”¨ç´«è‰²çš®å…‹æ•çš„åŠ›é‡ä¾†è¨ˆç®—ï¼</p>
    <button id="ov-btn" class="btn-start" onclick="initLevel1()">é–‹å§‹æ¢éšª</button>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const canvasContainer = document.getElementById('canvasContainer');
    const msgDiv = document.getElementById('message');
    const overlay = document.getElementById('overlay');
    
    // éŠæˆ²ç‹€æ…‹
    let currentLevel = 1; 
    let score = 0;
    let strikes = 0;
    let timeLeft = 0;
    let timerInterval = null;
    let isGameActive = false;
    
    // ç¹ªåœ–åƒæ•¸
    let scale = 15;
    let centerX = 170;
    let centerY = 120;
    
    // é¡Œç›®è³‡æ–™
    let l1_slope, l1_intercept, l1_targetX, l1_correctY, l1_input = "";
    let l2_slope, l2_intercept, l2_options = [], l2_correctIndex = 0;

    // RWD
    function resizeCanvas() {
        const containerWidth = canvasContainer.clientWidth;
        canvas.width = containerWidth;
        canvas.height = containerWidth * 0.75;
        centerX = canvas.width / 2;
        centerY = canvas.height / 2;
        scale = canvas.width / 22; 
        
        if (currentLevel === 1 && isGameActive) drawLevel1Scene(null);
        else if (currentLevel === 2 && isGameActive) drawLevel2Scene(false);
    }
    window.addEventListener('resize', resizeCanvas);

    // --- è¼”åŠ©å‡½å¼ ---
    function showMsg(text, color) {
        msgDiv.innerText = text;
        msgDiv.style.backgroundColor = color;
        msgDiv.style.display = 'block';
    }

    function updateHUD() {
        document.getElementById('scoreDisplay').innerText = score;
        document.getElementById('strikeDisplay').innerText = strikes;
        document.getElementById('timeDisplay').innerText = timeLeft;
    }

    function startTimer(seconds, onFinish) {
        if (timerInterval) clearInterval(timerInterval);
        timeLeft = seconds;
        updateHUD();
        timerInterval = setInterval(() => {
            if(!isGameActive) return;
            timeLeft--;
            updateHUD();
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                onFinish();
            }
        }, 1000);
    }

    function gameOver(reason) {
        isGameActive = false;
        clearInterval(timerInterval);
        overlay.style.display = 'flex';
        document.getElementById('ov-title').innerText = "ä»»å‹™çµæŸ";
        document.getElementById('ov-desc').innerText = reason + "\næœ€çµ‚ Poko: " + score;
        document.getElementById('ov-btn').innerText = "é‡æ–°æŒ‘æˆ°";
        document.getElementById('ov-btn').onclick = initLevel1;
    }

    // --- ç¹ªåœ–ç²¾éˆ (Sprites) ---
    
    // ç•«çš®å…‹æ•
    function drawPikminSprite(x, y, color, type) {
        ctx.save();
        ctx.translate(x, y);

        // è‘‰å­/èŠ±æ¢—
        ctx.beginPath();
        ctx.moveTo(0, -6); ctx.lineTo(0, -14);
        ctx.strokeStyle = "#64dd17"; ctx.lineWidth = 2; ctx.stroke();

        // è‘‰å­/èŠ±
        if(type === 'flower') {
            ctx.fillStyle = "#fff";
            for(let i=0; i<5; i++) {
                ctx.beginPath();
                ctx.ellipse(0, -14, 3, 5, i*(Math.PI*2/5), 0, Math.PI*2);
                ctx.fill();
            }
            ctx.fillStyle = "#ffea00"; ctx.beginPath(); ctx.arc(0, -14, 2, 0, Math.PI*2); ctx.fill();
        } else {
            // è‘‰å­
            ctx.fillStyle = "#64dd17";
            ctx.beginPath(); ctx.ellipse(0, -14, 4, 2, Math.PI/4, 0, Math.PI*2); ctx.fill();
        }

        // é ­ (çš®å…‹æ•æœ¬é«”)
        ctx.fillStyle = color;
        ctx.beginPath();
        // å¦‚æœæ˜¯ç´«è‰²ï¼Œç¨å¾®ç•«èƒ–ä¸€é»
        if (color === '#9c27b0') {
             ctx.ellipse(0, 0, 8.5, 8.5, 0, 0, Math.PI*2); 
        } else {
             ctx.ellipse(0, 0, 7, 8, 0, 0, Math.PI*2); 
        }
        ctx.fill();

        // ç´«è‰²çš®å…‹æ•çš„ç‰¹è‰²ï¼šé ­ä¸Šæœ‰å¹¾æ ¹æ¯› (ç°¡å–®ç·šæ¢)
        if (color === '#9c27b0') {
            ctx.strokeStyle = "rgba(0,0,0,0.3)";
            ctx.lineWidth = 1;
            ctx.beginPath(); ctx.moveTo(-3, -7); ctx.lineTo(-3, -10); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(0, -8); ctx.lineTo(0, -11); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(3, -7); ctx.lineTo(3, -10); ctx.stroke();
        }
        
        // çœ¼ç›
        ctx.fillStyle = "white";
        ctx.beginPath(); ctx.arc(-2.5, -1, 2.5, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(2.5, -1, 2.5, 0, Math.PI*2); ctx.fill();
        
        // çœ¼ç 
        ctx.fillStyle = "black";
        ctx.beginPath(); ctx.arc(-2.5, -1, 1, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(2.5, -1, 1, 0, Math.PI*2); ctx.fill();

        // é¼»å­/å˜´å·´
        if (color === '#9c27b0') { // ç´«è‰²çš®å…‹æ•ä¹Ÿæœ‰é¡ä¼¼çš„é¼»å­/å˜´
             // ç°¡å–®ç•«å€‹ç·šæ¢è¡¨ç¤º
        }

        ctx.restore();
    }

    // ç•«åŸç”Ÿç”Ÿç‰© (æ°æ¯” Bulborb)
    function drawBulborb(x, y) {
        ctx.save();
        ctx.translate(x, y);

        // èº«é«” (ç´…è‰²èƒŒéƒ¨)
        ctx.fillStyle = "#d50000";
        ctx.beginPath(); ctx.arc(0, 0, 14, 0, Math.PI*2); ctx.fill();
        
        // ç™½æ–‘
        ctx.fillStyle = "white";
        ctx.beginPath(); ctx.arc(-5, -6, 3, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(6, -2, 4, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(-2, 6, 2, 0, Math.PI*2); ctx.fill();

        // è‡‰ (ç±³è‰²)
        ctx.fillStyle = "#ffe0b2";
        ctx.beginPath(); ctx.arc(-8, 5, 8, 0, Math.PI*2); ctx.fill();

        // çœ¼ç›
        ctx.fillStyle = "white";
        ctx.beginPath(); ctx.arc(-6, -6, 4, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(4, -6, 4, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = "black";
        ctx.beginPath(); ctx.arc(-6, -6, 1.5, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(4, -6, 1.5, 0, Math.PI*2); ctx.fill();

        ctx.restore();
    }

    function drawGrid() {
        ctx.strokeStyle = "rgba(0,0,0,0.1)"; ctx.lineWidth=1;
        for(let x=centerX; x<=canvas.width; x+=scale) { ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,canvas.height); ctx.stroke(); }
        for(let x=centerX; x>=0; x-=scale) { ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,canvas.height); ctx.stroke(); }
        for(let y=centerY; y<=canvas.height; y+=scale) { ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(canvas.width,y); ctx.stroke(); }
        for(let y=centerY; y>=0; y-=scale) { ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(canvas.width,y); ctx.stroke(); }
        
        ctx.strokeStyle = "#5d4037"; ctx.lineWidth=2;
        ctx.beginPath(); ctx.moveTo(0,centerY); ctx.lineTo(canvas.width,centerY); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(centerX,0); ctx.lineTo(centerX,canvas.height); ctx.stroke();
    }

    // --- Level 1 ---
    function initLevel1() {
        currentLevel = 1; score = 0; strikes = 0;
        overlay.style.display = 'none';
        document.getElementById('levelBadge').innerText = "LEVEL 1: ç´«è‰²å¤§é€²æ“Š";
        document.getElementById('levelBadge').style.background = "#9c27b0"; 
        document.getElementById('level1-controls').style.display = 'flex';
        document.getElementById('level2-controls').style.display = 'none';
        resizeCanvas();
        isGameActive = true;
        startTimer(120, finishLevel1);
        nextLevel1Question();
    }

    function finishLevel1() {
        isGameActive = false; clearInterval(timerInterval);
        overlay.style.display = 'flex';
        document.getElementById('ov-title').innerText = "ç¬¬ä¸€é—œ é€šé!";
        document.getElementById('ov-desc').innerText = "ç›®å‰ Poko: " + score;
        document.getElementById('ov-btn').innerText = "å‰å¾€è˜‘è‡æˆ°å ´";
        document.getElementById('ov-btn').onclick = initLevel2;
    }

    function nextLevel1Question() {
        isGameActive = true; l1_input = "";
        document.getElementById('displayInput').innerText = "?";
        msgDiv.style.display = 'none';
        document.getElementById('l1-submit').style.display = 'grid';
        document.getElementById('l1-next').style.display = 'none';

        l1_slope = Math.floor(Math.random() * 5) - 2; if(l1_slope===0) l1_slope=1;
        l1_intercept = Math.floor(Math.random() * 9) - 4;
        l1_targetX = Math.floor(Math.random() * 9) - 4;
        l1_correctY = l1_slope * l1_targetX + l1_intercept;

        let sign = l1_intercept >= 0 ? "+ " : "- ";
        let eq = `y = ${l1_slope}x ${sign} ${Math.abs(l1_intercept)}`;
        if(l1_slope===0) eq=`y=${l1_intercept}`;
        else if(l1_slope===1) eq=`y=x ${sign} ${Math.abs(l1_intercept)}`;
        else if(l1_slope===-1) eq=`y=-x ${sign} ${Math.abs(l1_intercept)}`;
        else if(l1_intercept===0) eq=`y=${l1_slope}x`;

        document.getElementById('qText').innerText = "ç™¼ç¾åŸç”Ÿç”Ÿç‰©ï¼";
        document.getElementById('qContent').innerHTML = `<span class="highlight">${eq}</span> ç›®æ¨™ <span class="highlight">x=${l1_targetX}</span>`;
        drawLevel1Scene(null);
    }

    function inputNum(key) {
        if(!isGameActive || currentLevel !== 1) return;
        if (key === 'C') l1_input = l1_input.slice(0, -1);
        else if (key === '-') {
            if (l1_input === "") l1_input = "-"; else if (l1_input === "-") l1_input = "";
        } else { if (l1_input.length < 4) l1_input += key; }
        document.getElementById('displayInput').innerText = l1_input === "" ? "?" : l1_input;
    }

    function submitLevel1() {
        if (l1_input === "" || l1_input === "-") return;
        isGameActive = false;
        let val = parseInt(l1_input);
        drawLevel1Scene(val);

        if (val === l1_correctY) {
            score += 100; showMsg("å‘½ä¸­! å£“æ‰å®ƒ!", "#9c27b0");
        } else {
            strikes++; showMsg("å¤±èª¤...", "#d50000");
        }
        updateHUD();

        if (strikes >= 3) {
            setTimeout(() => gameOver("çš®å…‹æ•å—å‚·éå¤šæ’¤é€€"), 1000);
        } else {
            document.getElementById('l1-submit').style.display = 'none';
            document.getElementById('l1-next').style.display = 'grid';
        }
    }

    function drawLevel1Scene(userY) {
        ctx.fillStyle = "#f1f8e9"; ctx.fillRect(0,0,canvas.width,canvas.height);
        drawGrid();

        let px = centerX + l1_targetX * scale;
        
        // ç›®æ¨™ç·š
        ctx.strokeStyle = "rgba(213, 0, 0, 0.3)";
        ctx.setLineDash([5,5]); ctx.beginPath(); ctx.moveTo(px,0); ctx.lineTo(px,canvas.height); ctx.stroke(); ctx.setLineDash([]);
        
        // ç•«åŸç”Ÿç”Ÿç‰© (ç›®æ¨™)
        drawBulborb(px, centerY);

        if (userY !== null) {
            let py = centerY - userY * scale;
            let isCorrect = (userY === l1_correctY);
            
            ctx.lineWidth = 3;
            // è»Œè·¡é¡è‰²
            ctx.strokeStyle = isCorrect ? "#9c27b0" : "#b0bec5";
            ctx.beginPath();
            let xStart = -20; let yStart = l1_slope*xStart + l1_intercept;
            let xEnd = 20; let yEnd = l1_slope*xEnd + l1_intercept;
            
            if(isCorrect) {
                // ç•«æ­£ç¢ºè»Œè·¡
                ctx.moveTo(centerX+xStart*scale, centerY-yStart*scale);
                ctx.lineTo(centerX+xEnd*scale, centerY-yEnd*scale);
                ctx.stroke();
                
                // ç´«è‰²çš®å…‹æ•æ”»æ“Š (æ²’æœ‰åº•ä¸‹çš„åœ“é»ï¼Œç›´æ¥ç•«è§’è‰²)
                drawPikminSprite(px, py, "#9c27b0", "flower");
            } else {
                // éŒ¯èª¤è»Œè·¡
                ctx.moveTo(0, py); ctx.lineTo(px, py); ctx.stroke();
                // å¤±æ•—çš„çš®å…‹æ• (è‘‰å­ç‹€æ…‹ï¼Œç´«è‰²)
                drawPikminSprite(px, py, "#9c27b0", "leaf");
                
                // æ­£ç¢ºä½ç½®æç¤º (åŠé€æ˜ç¶ è‰²)
                ctx.globalAlpha = 0.5;
                drawPikminSprite(px, centerY - l1_correctY * scale, "#64dd17", "flower");
                ctx.globalAlpha = 1.0;
            }
        }
    }

    // --- Level 2 ---
    function initLevel2() {
        currentLevel = 2; strikes = 0;
        overlay.style.display = 'none';
        document.getElementById('levelBadge').innerText = "LEVEL 2: è˜‘è‡è¨ä¼æˆ°";
        document.getElementById('levelBadge').style.background = "#ffea00";
        document.getElementById('levelBadge').style.color = "#333";
        document.getElementById('level1-controls').style.display = 'none';
        document.getElementById('level2-controls').style.display = 'flex';
        resizeCanvas();
        isGameActive = true;
        startTimer(180, finishLevel2);
        nextLevel2Question();
    }

    function finishLevel2() {
        isGameActive = false; clearInterval(timerInterval);
        gameOver("å®Œå…¨é€šé—œï¼");
        document.getElementById('ov-title').innerText = "ä»»å‹™å¤§æˆåŠŸ!";
        document.getElementById('ov-desc').innerText = "ä½ æ˜¯æ•¸å­¸å¤§å¸«ï¼\næœ€çµ‚ Poko: " + score;
    }

    function nextLevel2Question() {
        isGameActive = true; msgDiv.style.display = 'none';
        let btns = document.querySelectorAll('.option-btn');
        btns.forEach(b => { b.style.display = 'flex'; b.disabled = false; b.style.opacity = "1"; });
        document.getElementById('l2-next').style.display = 'none';

        l2_slope = Math.floor(Math.random() * 5) - 2; 
        l2_intercept = Math.floor(Math.random() * 7) - 3; 

        let correctEq = formatEq(l2_slope, l2_intercept);
        let wrong1, wrong2;
        do { wrong1 = formatEq(Math.floor(Math.random()*5)-2, Math.floor(Math.random()*7)-3); } while (wrong1 === correctEq);
        do { wrong2 = formatEq(Math.floor(Math.random()*5)-2, Math.floor(Math.random()*7)-3); } while (wrong2 === correctEq || wrong2 === wrong1);

        l2_options = [correctEq, wrong1, wrong2];
        l2_correctIndex = Math.floor(Math.random() * 3);
        [l2_options[0], l2_options[l2_correctIndex]] = [l2_options[l2_correctIndex], l2_options[0]];

        document.getElementById('opt-0-text').innerText = l2_options[0];
        document.getElementById('opt-1-text').innerText = l2_options[1];
        document.getElementById('opt-2-text').innerText = l2_options[2];

        document.getElementById('qText').innerText = "å·¨å¤§è˜‘è‡å‡ºç¾ï¼";
        document.getElementById('qContent').innerHTML = "è§€å¯Ÿè·¯å¾‘ï¼Œé¸æ“‡æ­£ç¢ºçš„éšŠä¼ï¼";

        drawLevel2Scene(false);
    }

    function formatEq(m, b) {
        let sign = b >= 0 ? "+ " : "- ";
        let txt = `y = ${m}x ${sign} ${Math.abs(b)}`;
        if(m===0) txt = `y = ${b}`;
        else if(m===1) txt = `y = x ${sign} ${Math.abs(b)}`;
        else if(m===-1) txt = `y = -x ${sign} ${Math.abs(b)}`;
        else if(b===0) txt = `y = ${m}x`;
        return txt;
    }

    function checkLevel2(idx) {
        if(!isGameActive) return; isGameActive = false;
        let isCorrect = (idx === l2_correctIndex);
        drawLevel2Scene(true, isCorrect); 

        if(isCorrect) {
            score += 150; showMsg("å¤§æˆåŠŸ! (+150)", "#9c27b0");
        } else {
            strikes++; showMsg("è·¯å¾‘éŒ¯èª¤...", "#d50000");
        }
        updateHUD();

        let btns = document.querySelectorAll('.option-btn');
        btns.forEach((b, i) => { 
            if(i !== 3) { b.disabled = true; if(i !== idx) b.style.opacity = "0.3"; }
        });

        if (strikes >= 3) {
            setTimeout(() => gameOver("ä»»å‹™å¤±æ•—..."), 1000);
        } else {
            document.getElementById('l2-next').style.display = 'flex';
        }
    }

    function drawLevel2Scene(showResult, isCorrect) {
        ctx.fillStyle = "#f3e5f5"; ctx.fillRect(0,0,canvas.width,canvas.height);
        drawGrid();

        // é¡Œç›®ç·š
        ctx.lineWidth = 3;
        ctx.strokeStyle = "#558b2f";
        ctx.beginPath();
        let x1 = -15; let y1 = l2_slope*x1 + l2_intercept;
        let x2 = 15; let y2 = l2_slope*x2 + l2_intercept;
        ctx.moveTo(centerX+x1*scale, centerY-y1*scale);
        ctx.lineTo(centerX+x2*scale, centerY-y2*scale);
        ctx.stroke();

        // ç•«è˜‘è‡
        let mushX = 3; let mushY = l2_slope * mushX + l2_intercept;
        if(Math.abs(mushY) > 6) { mushX = -3; mushY = l2_slope * mushX + l2_intercept; }
        let px = centerX + mushX * scale;
        let py = centerY - mushY * scale;

        // ç•«è˜‘è‡åœ–æ¡ˆ
        ctx.save(); ctx.translate(px, py);
        if(showResult && isCorrect) ctx.globalAlpha = 0.5; // è¢«æ‰“æ•—
        ctx.fillStyle = "#eee"; ctx.fillRect(-8, 0, 16, 25);
        ctx.fillStyle = "#9c27b0"; ctx.beginPath(); ctx.arc(0, 0, 25, Math.PI, 0); ctx.fill();
        ctx.fillStyle = "#e1bee7"; 
        ctx.beginPath(); ctx.arc(-10, -10, 5, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(10, -5, 4, 0, Math.PI*2); ctx.fill();
        ctx.restore();

        if(showResult && isCorrect) {
            // æ­£ç¢ºæ™‚ï¼Œç•«å¹¾éš»ç´…è‰²çš®å…‹æ•æ¬é‹
            drawPikminSprite(px-20, py+10, "#ff3d00", "flower");
            drawPikminSprite(px+20, py+10, "#ff3d00", "flower");
        }
    }

    resizeCanvas();
</script>
</body>
</html>
