<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>函數大冒險 - 8-bit Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #5c94fc; /* Mario Sky Blue */
            --ground-color: #c84c0c; /* Ground Brick */
            --pipe-green: #00aa00;
            --box-yellow: #f8b800;
        }

        body {
            font-family: 'Press Start 2P', cursive;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            color: white;
            overflow: hidden; /* 禁止捲動 */
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
        }

        /* 頂部資訊列 (HUD) */
        .hud {
            display: flex;
            justify-content: space-between;
            width: 95%;
            padding: 10px 0;
            font-size: 12px; /* 平板上字體調整 */
            text-shadow: 2px 2px #000;
        }
        .hud-item span { color: #ffeb3b; }

        /* 遊戲主畫面容器 */
        .game-area {
            position: relative;
            background: #fff;
            border: 4px solid #000;
            box-shadow: 5px 5px 0px rgba(0,0,0,0.5);
            margin-bottom: 10px;
        }
        
        canvas {
            background-color: #f8f9fa; /* 讓格線清楚的白底 */
            display: block;
        }

        /* 題目顯示區 (像磚塊) */
        .question-box {
            background-color: #e86a17;
            border: 4px solid #000;
            padding: 10px;
            margin-bottom: 5px;
            text-align: center;
            box-shadow: inset -4px -4px rgba(0,0,0,0.3);
            text-shadow: 2px 2px #000;
            width: 90%;
            font-size: 14px;
            line-height: 1.5;
        }
        .highlight { color: #fff; background: #000; padding: 2px 5px; }

        /* 虛擬鍵盤區 */
        .keypad-container {
            flex-grow: 1;
            width: 100%;
            background-color: #000;
            padding-top: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* 輸入顯示框 */
        #displayInput {
            width: 80%;
            height: 40px;
            background-color: #000;
            color: #00e5ff;
            font-family: 'Press Start 2P', cursive;
            font-size: 20px;
            text-align: center;
            border: 4px solid #fff;
            margin-bottom: 10px;
            pointer-events: none; /* 禁止跳出原生鍵盤 */
        }

        /* 按鈕網格 */
        .keypad {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            width: 95%;
            max-width: 500px;
        }

        .key {
            background-color: #fff;
            color: #000;
            border: 4px solid #555;
            box-shadow: 0 4px #222;
            height: 50px;
            font-family: 'Press Start 2P';
            font-size: 18px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            user-select: none;
        }
        .key:active { transform: translateY(4px); box-shadow: 0 0 #222; }
        
        .key-enter {
            grid-column: span 2;
            background-color: var(--pipe-green);
            color: white;
            border-color: #004400;
        }
        .key-del { background-color: #d32f2f; color: white; border-color: #8b0000; }
        .key-minus { background-color: #ffeb3b; color: black; }

        /* Game Over 遮罩 */
        #overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            text-align: center;
        }
        .btn-start {
            margin-top: 20px;
            padding: 15px 20px;
            font-family: 'Press Start 2P';
            background: var(--box-yellow);
            border: 4px solid #fff;
            cursor: pointer;
            font-size: 16px;
            animation: blink 1s infinite;
        }
        @keyframes blink { 0% {opacity: 1;} 50% {opacity: 0.5;} 100% {opacity: 1;} }

        /* 訊息提示 */
        #message {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            text-shadow: 3px 3px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
            pointer-events: none;
            display: none;
            z-index: 50;
        }
    </style>
</head>
<body>

    <div class="hud">
        <div class="hud-item">MARIO<br><span id="scoreDisplay">000000</span></div>
        <div class="hud-item">STRIKES<br><span id="strikeDisplay">0</span>/3</div>
        <div class="hud-item">TIME<br><span id="timeDisplay">180</span></div>
    </div>

    <div class="question-box">
        武器: <span id="eqDisplay" class="highlight">y = 2x + 1</span> <br>
        敵人: <span id="targetDisplay" class="highlight">x = 3</span>
    </div>

    <div class="game-area">
        <canvas id="gameCanvas" width="340" height="240"></canvas>
        <div id="message"></div>
    </div>

    <div class="keypad-container">
        <div id="displayInput">?</div>

        <div class="keypad">
            <button class="key" onclick="pressKey('1')">1</button>
            <button class="key" onclick="pressKey('2')">2</button>
            <button class="key" onclick="pressKey('3')">3</button>
            <button class="key key-minus" onclick="pressKey('-')">-</button>

            <button class="key" onclick="pressKey('4')">4</button>
            <button class="key" onclick="pressKey('5')">5</button>
            <button class="key" onclick="pressKey('6')">6</button>
            <button class="key key-del" onclick="pressKey('C')">⬅</button>

            <button class="key" onclick="pressKey('7')">7</button>
            <button class="key" onclick="pressKey('8')">8</button>
            <button class="key" onclick="pressKey('9')">9</button>
            <button class="key" onclick="pressKey('0')">0</button>
            
            <button class="key key-enter" onclick="submitAnswer()">FIRE!</button>
            <button class="key" id="nextBtn" onclick="nextLevel()" style="display:none; background:#5c94fc; color:white;">NEXT</button>
        </div>
    </div>

    <div id="overlay">
        <h1 style="color: #ffeb3b; text-shadow: 4px 4px #c84c0c;">WORLD 1-1</h1>
        <p>FUNCTION SNIPER</p>
        <br>
        <p style="font-size: 10px; color: #ccc;">3 MINS TIME LIMIT</p>
        <button class="btn-start" onclick="startGame()">PRESS START</button>
    </div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const displayInput = document.getElementById('displayInput');
    const msgDiv = document.getElementById('message');
    
    // 遊戲變數
    let scale = 15; // 縮放比例
    let centerX = canvas.width / 2;
    let centerY = canvas.height / 2;
    let slope = 0, intercept = 0, targetX = 0, correctY = 0;
    
    let score = 0;
    let strikes = 0;
    let timeLeft = 180;
    let timerInterval = null;
    let isGameActive = false;
    let currentInput = "";

    // === 鍵盤邏輯 ===
    function pressKey(key) {
        if (!isGameActive) return;

        if (key === 'C') {
            currentInput = currentInput.slice(0, -1);
        } else if (key === '-') {
            // 負號只能在第一位
            if (currentInput === "") currentInput = "-";
            else if (currentInput === "-") currentInput = ""; // 切換
        } else {
            // 限制長度
            if (currentInput.length < 5) currentInput += key;
        }
        updateInputDisplay();
    }

    function updateInputDisplay() {
        displayInput.innerText = currentInput === "" ? "?" : currentInput;
    }

    // === 遊戲核心 ===
    function startGame() {
        document.getElementById('overlay').style.display = 'none';
        score = 0;
        strikes = 0;
        timeLeft = 180;
        isGameActive = true;
        
        updateHUD();
        
        if(timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            timeLeft--;
            updateHUD();
            if(timeLeft <= 0) gameOver("TIME UP");
        }, 1000);

        nextLevel();
    }

    function nextLevel() {
        isGameActive = true;
        currentInput = "";
        updateInputDisplay();
        msgDiv.style.display = 'none';
        
        // 切換按鈕
        document.querySelector('.key-enter').style.display = 'flex';
        document.getElementById('nextBtn').style.display = 'none';

        generateQuestion();
        drawScene(null); // null 代表還沒射擊
    }

    function generateQuestion() {
        slope = Math.floor(Math.random() * 5) - 2; // -2 ~ 2
        intercept = Math.floor(Math.random() * 9) - 4; // -4 ~ 4
        targetX = Math.floor(Math.random() * 11) - 5; // -5 ~ 5
        
        // 避免太簡單
        if(slope === 0 && Math.random() > 0.5) slope = 1;

        correctY = slope * targetX + intercept;
        
        // 顯示算式
        let sign = intercept >= 0 ? "+ " : "- ";
        let txt = `y = ${slope}x ${sign} ${Math.abs(intercept)}`;
        if (slope === 0) txt = `y = ${intercept}`;
        else if (slope === 1) txt = `y = x ${sign} ${Math.abs(intercept)}`;
        else if (slope === -1) txt = `y = -x ${sign} ${Math.abs(intercept)}`;
        else if (intercept === 0) txt = `y = ${slope}x`;
        
        document.getElementById('eqDisplay').innerText = txt;
        document.getElementById('targetDisplay').innerText = `x = ${targetX}`;
    }

    function submitAnswer() {
        if (currentInput === "" || currentInput === "-") return;
        
        let userVal = parseInt(currentInput);
        isGameActive = false; // 鎖定輸入

        drawScene(userVal); // 畫出結果

        if (userVal === correctY) {
            score += 100;
            strikes = 0; // 連續錯誤重置? 題目說「連續打錯」才算，所以這裡歸零
            showMsg("100 PTS!", "#ffeb3b");
        } else {
            strikes++;
            showMsg("MISS!", "#d32f2f");
        }
        
        updateHUD();

        if (strikes >= 3) {
            setTimeout(() => gameOver("GAME OVER"), 1000);
        } else {
            // 切換成 Next 按鈕
            document.querySelector('.key-enter').style.display = 'none';
            document.getElementById('nextBtn').style.display = 'flex';
        }
    }

    function showMsg(text, color) {
        msgDiv.innerText = text;
        msgDiv.style.color = color;
        msgDiv.style.display = 'block';
    }

    function updateHUD() {
        document.getElementById('scoreDisplay').innerText = score.toString().padStart(6, '0');
        document.getElementById('timeDisplay').innerText = timeLeft;
        document.getElementById('strikeDisplay').innerText = strikes;
    }

    function gameOver(reason) {
        clearInterval(timerInterval);
        document.querySelector('#overlay h1').innerText = reason;
        document.querySelector('#overlay p').innerText = `SCORE: ${score}`;
        document.querySelector('.btn-start').innerText = "TRY AGAIN";
        document.getElementById('overlay').style.display = 'flex';
    }

    // === 繪圖 ===
    function drawScene(userY) {
        // 清空
        ctx.fillStyle = "#fff"; // 畫布背景
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // 畫網格
        ctx.strokeStyle = "#e0e0e0";
        ctx.lineWidth = 1;
        for(let x=0; x<=canvas.width; x+=scale) {
            ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,canvas.height); ctx.stroke();
        }
        for(let y=0; y<=canvas.height; y+=scale) {
            ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(canvas.width,y); ctx.stroke();
        }

        // 畫軸
        ctx.strokeStyle = "#000"; // 黑色粗線
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(0, centerY); ctx.lineTo(canvas.width, centerY);
        ctx.moveTo(centerX, 0); ctx.lineTo(centerX, canvas.height);
        ctx.stroke();

        // 畫敵人 (目標線)
        let pixelTargetX = centerX + targetX * scale;
        ctx.strokeStyle = "rgba(255,0,0,0.5)";
        ctx.setLineDash([4, 4]);
        ctx.beginPath(); ctx.moveTo(pixelTargetX, 0); ctx.lineTo(pixelTargetX, canvas.height); ctx.stroke();
        ctx.setLineDash([]);

        // 畫敵人圖示 (Goomba 風格的方塊)
        // 我們不知道高度在哪，所以只能在 X 軸上標記
        ctx.fillStyle = "#8b4513"; // Brown
        ctx.fillRect(pixelTargetX - 6, centerY - 6, 12, 12);

        // 如果已經射擊，畫出軌跡
        if (userY !== null) {
            let isCorrect = (userY === correctY);
            let pixelY = centerY - userY * scale;

            // 函數線
            ctx.strokeStyle = isCorrect ? "#00aa00" : "#888"; // 對是綠色，錯是灰色
            ctx.lineWidth = 3;
            ctx.beginPath();
            let x1 = -15, y1 = slope*x1+intercept;
            let x2 = 15, y2 = slope*x2+intercept;
            
            // 錯的時候畫射歪的線
            if(!isCorrect) {
                // 為了視覺簡單，錯的時候我們只畫"子彈軌跡"到那個錯誤點
                ctx.strokeStyle = "#d32f2f";
                ctx.beginPath();
                ctx.moveTo(0, pixelY); // 簡單從左邊射入
                ctx.lineTo(pixelTargetX, pixelY);
            } else {
                ctx.moveTo(centerX+x1*scale, centerY-y1*scale);
                ctx.lineTo(centerX+x2*scale, centerY-y2*scale);
            }
            ctx.stroke();

            // 爆炸點 / 命中點
            ctx.beginPath();
            ctx.arc(pixelTargetX, pixelY, 8, 0, Math.PI*2);
            ctx.fillStyle = isCorrect ? "#ffeb3b" : "#555"; // 對是金色(金幣)，錯是深色
            ctx.fill();
            
            // 如果錯了，顯示正確位置的綠色圈圈
            if (!isCorrect) {
                let trueY = centerY - correctY * scale;
                ctx.beginPath();
                ctx.arc(pixelTargetX, trueY, 8, 0, Math.PI*2);
                ctx.strokeStyle = "#00aa00";
                ctx.stroke();
            }
        }
    }

    // 初始化
    drawScene(null);

</script>
</body>
</html>
