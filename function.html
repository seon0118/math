<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>函數狙擊手 - 菁英版</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #222; 
            --hud-color: #00e5ff;
            --scope-bg: rgba(0, 20, 0, 0.3);
        }

        body {
            font-family: 'Press Start 2P', cursive;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            color: white;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            touch-action: none; /* 防止平板雙擊縮放 */
        }

        /* 震動特效動畫 */
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }

        .shake-effect {
            animation: shake 0.3s;
            animation-iteration-count: 1;
        }

        /* 槍火閃光 */
        #flash-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: white;
            opacity: 0;
            pointer-events: none;
            z-index: 200;
            transition: opacity 0.1s;
        }

        /* 頂部資訊列 */
        .hud {
            display: flex;
            justify-content: space-between;
            width: 95%;
            padding: 10px 0;
            font-size: 12px;
            color: var(--hud-color);
            text-shadow: 0 0 5px var(--hud-color);
            z-index: 10;
        }

        /* 遊戲區域 */
        .game-wrapper {
            position: relative;
            margin-bottom: 5px;
            border: 4px solid #444;
            box-shadow: 0 0 15px rgba(0, 229, 255, 0.2);
        }

        canvas {
            background-color: #000;
            display: block;
        }

        /* 題目顯示 (像抬頭顯示器) */
        .info-panel {
            background: rgba(0, 50, 50, 0.8);
            border: 2px solid var(--hud-color);
            color: #fff;
            padding: 8px;
            margin-bottom: 5px;
            text-align: center;
            width: 90%;
            font-size: 14px;
            text-shadow: 2px 2px #000;
        }
        .target-hl { color: #ffeb3b; }

        /* 虛擬鍵盤 */
        .keypad-container {
            flex-grow: 1;
            width: 100%;
            background-color: #111;
            padding-top: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            border-top: 2px solid #444;
        }

        /* 輸入框 */
        #displayInput {
            width: 80%;
            height: 50px;
            background-color: #000;
            color: #ff4444; /* 雷射紅 */
            font-family: 'Press Start 2P', cursive;
            font-size: 24px;
            border: 2px solid #555;
            margin-bottom: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            text-shadow: 0 0 8px red;
            letter-spacing: 5px;
        }

        .keypad {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            width: 95%;
            max-width: 500px;
        }

        .key {
            background: #333;
            color: #fff;
            border: 1px solid #555;
            box-shadow: 0 3px #000;
            height: 45px;
            font-family: 'Press Start 2P';
            font-size: 16px;
            cursor: pointer;
            border-radius: 4px;
        }
        .key:active { transform: translateY(2px); box-shadow: 0 1px #000; background: #555;}
        
        .key-enter {
            grid-column: span 2;
            background: #b71c1c; /* 暗紅色發射鈕 */
            color: white;
            border-color: #d32f2f;
        }
        .key-next {
            background: #2e7d32; /* 綠色下一關 */
            grid-column: span 2;
        }

        /* 遮罩層 */
        #overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 300;
            text-align: center;
        }
        .btn-start {
            margin-top: 20px;
            padding: 15px 30px;
            font-family: 'Press Start 2P';
            background: var(--hud-color);
            border: none;
            color: #000;
            cursor: pointer;
            font-size: 16px;
            animation: pulse 1s infinite;
        }
        @keyframes pulse { 0% {transform: scale(1);} 50% {transform: scale(1.05);} 100% {transform: scale(1);} }

    </style>
</head>
<body>

    <div id="flash-overlay"></div>

    <div class="hud">
        <div>SCORE: <span id="scoreDisplay">0</span></div>
        <div>STRIKES: <span id="strikeDisplay">0</span>/3</div>
        <div>TIME: <span id="timeDisplay">180</span></div>
    </div>

    <div class="info-panel">
        MISSION: <span id="eqDisplay" class="target-hl">y = 2x + 1</span> <br>
        TARGET X: <span id="targetDisplay" class="target-hl">3</span>
    </div>

    <div class="game-wrapper" id="gameWrapper">
        <canvas id="gameCanvas" width="350" height="250"></canvas>
    </div>

    <div class="keypad-container">
        <div id="displayInput">?</div>

        <div class="keypad">
            <button class="key" onclick="pressKey('1')">1</button>
            <button class="key" onclick="pressKey('2')">2</button>
            <button class="key" onclick="pressKey('3')">3</button>
            <button class="key" onclick="pressKey('-')">-</button>

            <button class="key" onclick="pressKey('4')">4</button>
            <button class="key" onclick="pressKey('5')">5</button>
            <button class="key" onclick="pressKey('6')">6</button>
            <button class="key" onclick="pressKey('C')">C</button>

            <button class="key" onclick="pressKey('7')">7</button>
            <button class="key" onclick="pressKey('8')">8</button>
            <button class="key" onclick="pressKey('9')">9</button>
            <button class="key" onclick="pressKey('0')">0</button>
            
            <button class="key key-enter" id="fireBtn" onclick="initiateAiming()">LOCK & FIRE</button>
            <button class="key key-next" id="nextBtn" onclick="nextLevel()" style="display:none;">NEXT TARGET</button>
        </div>
    </div>

    <div id="overlay">
        <h1 style="color: var(--hud-color); line-height: 1.5;">SNIPER MATH<br>ELITE</h1>
        <p style="font-size: 10px; color: #888;">CALCULATE Y TO ELIMINATE TARGET</p>
        <button class="btn-start" onclick="startGame()">START MISSION</button>
    </div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const displayInput = document.getElementById('displayInput');
    const gameWrapper = document.getElementById('gameWrapper');
    const flashOverlay = document.getElementById('flash-overlay');

    // 遊戲參數
    let scale = 15; 
    let centerX = canvas.width / 2;
    let centerY = canvas.height / 2;
    
    // 狀態
    let gameState = 'IDLE'; // IDLE, AIMING, FIRED, GAMEOVER
    let slope = 0, intercept = 0, targetX = 0, correctY = 0;
    let currentInput = "";
    
    // 狙擊鏡動畫參數
    let scopeX = centerX;
    let scopeY = centerY;
    let targetScopeY = 0;
    let scopeRadius = 60;
    let aimProgress = 0; // 0 到 1

    // 積分與時間
    let score = 0;
    let strikes = 0;
    let timeLeft = 180;
    let timerInterval = null;

    // === 主循環 (Animation Loop) ===
    function gameLoop() {
        // 清除畫布
        ctx.fillStyle = "#000";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // 1. 繪製背景 (普通視圖)
        drawGrid(ctx, scale, 0.3); // 暗淡的網格
        drawTargetLine(ctx, scale);
        
        // 2. 狀態處理
        if (gameState === 'AIMING') {
            // 平滑移動狙擊鏡
            aimProgress += 0.05;
            if (aimProgress >= 1) {
                aimProgress = 1;
                fireShot(); // 移動到位後自動擊發
            }
            // 插值計算目前鏡頭位置
            let startY = -50; // 從上面飛進來
            let destY = centerY - parseInt(currentInput) * scale;
            let destX = centerX + targetX * scale;
            
            // 使用 Ease Out 效果
            let ease = 1 - Math.pow(1 - aimProgress, 3);
            scopeY = startY + (destY - startY) * ease;
            scopeX = centerX + (destX - centerX) * ease; // 如果要讓鏡頭從中間移過去
            
            drawScope(scopeX, scopeY);
            
        } else if (gameState === 'FIRED') {
            // 停留在射擊位置
            let destY = centerY - parseInt(currentInput) * scale;
            let destX = centerX + targetX * scale;
            drawScope(destX, destY);
            drawBulletHole(destX, destY);
            drawFunctionLine(); // 畫出綠色軌跡線
        }

        requestAnimationFrame(gameLoop);
    }

    // === 繪圖函數 ===

    // 畫網格
    function drawGrid(context, gridSize, opacity) {
        context.strokeStyle = `rgba(0, 229, 255, ${opacity})`; // Cyberpunk blue
        context.lineWidth = 1;
        context.beginPath();
        for(let x=0; x<=canvas.width; x+=gridSize) {
            context.moveTo(x,0); context.lineTo(x,canvas.height);
        }
        for(let y=0; y<=canvas.height; y+=gridSize) {
            context.moveTo(0,y); context.lineTo(canvas.width,y);
        }
        context.stroke();

        // 畫軸
        context.strokeStyle = `rgba(255, 255, 255, ${opacity + 0.3})`;
        context.lineWidth = 2;
        context.beginPath();
        context.moveTo(0, centerY); context.lineTo(canvas.width, centerY);
        context.moveTo(centerX, 0); context.lineTo(centerX, canvas.height);
        context.stroke();
    }

    // 畫目標線 (紅色虛線)
    function drawTargetLine(context, gridSize) {
        let px = centerX + targetX * gridSize;
        context.strokeStyle = "rgba(255, 0, 0, 0.5)";
        context.setLineDash([5, 5]);
        context.lineWidth = 2;
        context.beginPath();
        context.moveTo(px, 0); context.lineTo(px, canvas.height);
        context.stroke();
        context.setLineDash([]);
        
        // 畫目標圖標
        context.fillStyle = "red";
        context.font = "10px Arial";
        context.fillText("TARGET", px - 20, 20);
    }

    // 畫狙擊鏡 (核心功能：放大效果)
    function drawScope(x, y) {
        ctx.save();
        
        // 1. 建立圓形剪裁區域 (鏡頭內部)
        ctx.beginPath();
        ctx.arc(x, y, scopeRadius, 0, Math.PI * 2);
        ctx.clip();

        // 2. 填滿鏡頭背景 (略亮)
        ctx.fillStyle = "#001100";
        ctx.fill();

        // 3. 繪製「放大版」的網格與內容
        // 技巧：移動原點到鏡頭中心 -> 放大 -> 移回反向位置
        ctx.translate(x, y);
        ctx.scale(2.0, 2.0); // 放大 2 倍
        ctx.translate(-x, -y);

        // 在鏡頭內重畫清晰的網格
        drawGrid(ctx, scale, 0.8); 
        drawTargetLine(ctx, scale);

        // 如果是射擊後，在鏡頭內也要畫出線
        if (gameState === 'FIRED') {
            drawFunctionLine();
        }

        ctx.restore(); // 結束剪裁與變形

        // 4. 畫鏡頭的邊框與十字準心 (在剪裁區之外)
        ctx.strokeStyle = "#000";
        ctx.lineWidth = 5;
        ctx.beginPath();
        ctx.arc(x, y, scopeRadius, 0, Math.PI * 2);
        ctx.stroke();

        // 鏡頭玻璃反光感
        ctx.strokeStyle = "rgba(100, 255, 100, 0.5)";
        ctx.lineWidth = 2;
        ctx.stroke();

        // 十字準心
        ctx.strokeStyle = "red";
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(x - scopeRadius, y); ctx.lineTo(x + scopeRadius, y);
        ctx.moveTo(x, y - scopeRadius); ctx.lineTo(x, y + scopeRadius);
        ctx.stroke();
        
        // 距離數據 (裝飾)
        ctx.fillStyle = "#00e5ff";
        ctx.font = "10px Arial";
        ctx.fillText(`Y:${parseInt(currentInput)}`, x + 10, y + scopeRadius + 15);
    }

    function drawFunctionLine() {
        let userY = parseInt(currentInput);
        let isCorrect = (userY === correctY);
        
        ctx.strokeStyle = isCorrect ? "#00ff00" : "#555";
        ctx.lineWidth = 2;
        ctx.beginPath();
        
        // 為了讓線在放大鏡裡看起來正確，我們畫整條長線
        let x1 = -20; let y1 = slope * x1 + intercept;
        let x2 = 20; let y2 = slope * x2 + intercept;
        
        // 如果答錯，畫一條歪掉的線穿過彈孔
        if (!isCorrect) {
            // 這裡簡單處理：只畫射擊點
        } else {
            ctx.moveTo(centerX + x1 * scale, centerY - y1 * scale);
            ctx.lineTo(centerX + x2 * scale, centerY - y2 * scale);
            ctx.stroke();
        }
    }

    function drawBulletHole(x, y) {
        ctx.beginPath();
        ctx.arc(x, y, 5, 0, Math.PI*2);
        ctx.fillStyle = "#fff";
        ctx.fill();
        
        // 如果答錯，標記正確位置
        if (parseInt(currentInput) !== correctY) {
             let trueY = centerY - correctY * scale;
             ctx.beginPath();
             ctx.arc(x, trueY, 5, 0, Math.PI*2);
             ctx.strokeStyle = "#00ff00";
             ctx.lineWidth = 2;
             ctx.stroke();
        }
    }

    // === 遊戲邏輯控制 ===

    function pressKey(key) {
        if (gameState !== 'IDLE') return;

        if (key === 'C') currentInput = "";
        else if (key === '-') {
            if (currentInput === "") currentInput = "-";
            else if (currentInput === "-") currentInput = "";
        } else {
            if (currentInput.length < 4) currentInput += key;
        }
        displayInput.innerText = currentInput === "" ? "?" : currentInput;
    }

    function initiateAiming() {
        if (currentInput === "" || currentInput === "-" || gameState !== 'IDLE') return;
        
        // 進入瞄準狀態
        gameState = 'AIMING';
        aimProgress = 0;
        
        // 鎖定按鈕
        document.getElementById('fireBtn').style.display = 'none';
    }

    function fireShot() {
        gameState = 'FIRED';
        let userVal = parseInt(currentInput);
        let isCorrect = (userVal === correctY);

        // 1. 視覺特效：槍火閃光
        flashOverlay.style.opacity = 0.8;
        setTimeout(() => { flashOverlay.style.opacity = 0; }, 100);

        // 2. 視覺特效：震動
        gameWrapper.classList.add('shake-effect');
        setTimeout(() => { gameWrapper.classList.remove('shake-effect'); }, 500);

        // 3. 結算
        if (isCorrect) {
            score += 100;
            displayInput.style.color = "#00ff00";
            displayInput.style.borderColor = "#00ff00";
            displayInput.innerText = "HIT!";
        } else {
            strikes++;
            displayInput.style.color = "#ff0000";
            displayInput.innerText = "MISS";
        }
        updateHUD();

        // 4. 顯示下一關按鈕
        if (strikes >= 3) {
            setTimeout(() => { endGame("MISSION FAILED"); }, 1500);
        } else {
            document.getElementById('nextBtn').style.display = 'grid'; // 顯示綠色按鈕
        }
    }

    function nextLevel() {
        gameState = 'IDLE';
        currentInput = "";
        displayInput.innerText = "?";
        displayInput.style.color = "#ff4444";
        displayInput.style.borderColor = "#555";
        
        document.getElementById('fireBtn').style.display = 'grid';
        document.getElementById('nextBtn').style.display = 'none';

        generateQuestion();
    }

    function generateQuestion() {
        slope = Math.floor(Math.random() * 5) - 2; 
        intercept = Math.floor(Math.random() * 9) - 4;
        targetX = Math.floor(Math.random() * 9) - 4; // -4 ~ 4
        
        if(slope === 0 && Math.random() > 0.5) slope = 1;
        correctY = slope * targetX + intercept;
        
        let sign = intercept >= 0 ? "+ " : "- ";
        let txt = `y = ${slope}x ${sign} ${Math.abs(intercept)}`;
        if (slope === 0) txt = `y = ${intercept}`;
        else if (slope === 1) txt = `y = x ${sign} ${Math.abs(intercept)}`;
        else if (slope === -1) txt = `y = -x ${sign} ${Math.abs(intercept)}`;
        else if (intercept === 0) txt = `y = ${slope}x`;
        
        document.getElementById('eqDisplay').innerText = txt;
        document.getElementById('targetDisplay').innerText = `x = ${targetX}`;
    }

    function startGame() {
        document.getElementById('overlay').style.display = 'none';
        score = 0; strikes = 0; timeLeft = 180;
        updateHUD();
        
        if(timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            timeLeft--;
            updateHUD();
            if(timeLeft <= 0) endGame("TIME EXPIRED");
        }, 1000);

        nextLevel();
        requestAnimationFrame(gameLoop); // 啟動繪圖循環
    }

    function updateHUD() {
        document.getElementById('scoreDisplay').innerText = score;
        document.getElementById('strikeDisplay').innerText = strikes;
        document.getElementById('timeDisplay').innerText = timeLeft;
    }

    function endGame(reason) {
        clearInterval(timerInterval);
        gameState = 'GAMEOVER';
        document.querySelector('#overlay h1').innerHTML = reason;
        document.querySelector('#overlay button').innerText = "RETRY MISSION";
        document.getElementById('overlay').style.display = 'flex';
    }

    // 啟動繪圖 (先畫一次靜態背景)
    drawGrid(ctx, scale, 0.3);
    
</script>
</body>
</html>
