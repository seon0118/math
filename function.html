<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ç¥ç§˜å‡½æ•¸ç‹™æ“Šæ‰‹ - ç©åˆ†æŒ‘æˆ°ç‰ˆ</title>
    <style>
        body {
            font-family: 'å¾®è»Ÿæ­£é»‘é«”', sans-serif;
            text-align: center;
            background-color: #222;
            color: white;
            margin: 0;
            padding: 10px;
        }
        h1 { margin: 5px 0; color: #ffcc00; font-size: 24px; }
        
        /* éŠæˆ²ç‹€æ…‹åˆ— */
        .status-bar {
            display: flex;
            justify-content: center;
            gap: 20px;
            background-color: #333;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            width: 80%;
            margin-left: auto;
            margin-right: auto;
        }
        .status-item { font-size: 1.2em; font-weight: bold; }
        .timer { color: #00e5ff; }
        .score { color: #ffeb3b; }
        .strikes { color: #ff4444; }

        .game-container {
            display: inline-block;
            background-color: #fff;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            position: relative;
        }
        canvas {
            background-color: #f0f0f0;
            border: 2px solid #333;
            cursor: crosshair;
        }
        .controls {
            margin-top: 15px;
            font-size: 1.2em;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        .hud-info {
            display: flex;
            justify-content: space-around;
            width: 100%;
            margin-bottom: 5px;
            color: #333; /* æ”¹æ·±è‰²ä»¥é©æ‡‰ç™½è‰²èƒŒæ™¯å€å¡Š */
            font-size: 1.3em;
            font-weight: bold;
        }
        input {
            font-size: 1.2em;
            width: 80px;
            padding: 5px;
            text-align: center;
            border: 2px solid #555;
            border-radius: 5px;
        }
        button {
            font-size: 1.1em;
            padding: 8px 20px;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            transition: 0.2s;
        }
        .btn-fire { background-color: #ff4444; }
        .btn-fire:hover { background-color: #cc0000; }
        .btn-next { background-color: #4CAF50; }
        .btn-next:hover { background-color: #388E3C; }
        .btn-start { background-color: #2196F3; font-size: 1.5em; padding: 15px 40px; margin-top: 20px;}
        
        button:disabled { background-color: #ccc; cursor: not-allowed; }

        #message {
            margin-top: 10px;
            font-weight: bold;
            height: 30px;
            color: #333;
            font-size: 1.1em;
        }
        
        /* é®ç½©å±¤ (é–‹å§‹/çµæŸç•«é¢) */
        #overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0,0,0,0.85);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }
        .overlay-content h2 { font-size: 2.5em; margin-bottom: 10px; color: #fff;}
        .overlay-content p { font-size: 1.2em; color: #ddd; margin-bottom: 20px;}
        .math-expr { font-family: 'Times New Roman', serif; font-style: italic; color: #0056b3;}
    </style>
</head>
<body>

    <h1>ğŸ¯ ç¥ç§˜å‡½æ•¸ç‹™æ“Šæ‰‹ - ç©åˆ†æŒ‘æˆ°</h1>
    
    <div class="status-bar">
        <div class="status-item timer">â±ï¸ æ™‚é–“: <span id="timeDisplay">180</span>s</div>
        <div class="status-item score">ğŸ† åˆ†æ•¸: <span id="scoreDisplay">0</span></div>
        <div class="status-item strikes">âŒ é€£çºŒå¤±èª¤: <span id="strikeDisplay">0</span>/3</div>
    </div>

    <div class="game-container">
        <div id="overlay">
            <div class="overlay-content">
                <h2 id="overlayTitle">æº–å‚™å¥½äº†å—ï¼Ÿ</h2>
                <p id="overlayDesc">é™æ™‚ 3 åˆ†é˜ï¼Œé€£çºŒç­”éŒ¯ 3 é¡Œå³å¤±æ•—ï¼</p>
                <button class="btn-start" onclick="startGame()">é–‹å§‹éŠæˆ²</button>
            </div>
        </div>

        <div class="hud-info">
            <div id="equation-display">æ­¦å™¨: y = ?</div>
            <div id="target-display">ç›®æ¨™: x = ?</div>
        </div>

        <canvas id="gameCanvas" width="600" height="400"></canvas>
        
        <div class="controls">
            <span>é«˜åº¦ (y) = </span>
            <input type="number" id="inputY" placeholder="?" step="1">
            <button id="fireBtn" class="btn-fire" onclick="fire()">ç™¼å°„</button>
            <button id="nextBtn" class="btn-next" onclick="nextLevel()" style="display:none;">ä¸‹ä¸€é¡Œ</button>
        </div>
        <div id="message"></div>
    </div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    // UI å…ƒä»¶
    const inputY = document.getElementById('inputY');
    const messageDiv = document.getElementById('message');
    const fireBtn = document.getElementById('fireBtn');
    const nextBtn = document.getElementById('nextBtn');
    const timeDisplay = document.getElementById('timeDisplay');
    const scoreDisplay = document.getElementById('scoreDisplay');
    const strikeDisplay = document.getElementById('strikeDisplay');
    const overlay = document.getElementById('overlay');
    const overlayTitle = document.getElementById('overlayTitle');
    const overlayDesc = document.getElementById('overlayDesc');

    // éŠæˆ²åƒæ•¸
    let scale = 20; 
    let centerX = canvas.width / 2;
    let centerY = canvas.height / 2;

    // å…¨å±€ç‹€æ…‹
    let timerInterval = null;
    let timeLeft = 180;
    let score = 0;
    let consecutiveStrikes = 0;
    let isGameActive = false;

    // ç•¶å‰é¡Œç›®è®Šæ•¸
    let slope = 0, intercept = 0, targetX = 0, correctY = 0;

    // === éŠæˆ²æµç¨‹æ§åˆ¶ ===

    // é–‹å§‹æ–°éŠæˆ² (é‡ç½®æ‰€æœ‰ç©åˆ†èˆ‡æ™‚é–“)
    function startGame() {
        score = 0;
        timeLeft = 180;
        consecutiveStrikes = 0;
        isGameActive = true;
        
        updateUI();
        overlay.style.display = 'none'; // éš±è—é®ç½©
        
        // å•Ÿå‹•è¨ˆæ™‚å™¨
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(gameTick, 1000);

        nextLevel(); // å‡ºç¬¬ä¸€é¡Œ
    }

    // æ¯ä¸€ç§’åŸ·è¡Œä¸€æ¬¡
    function gameTick() {
        if (!isGameActive) return;
        timeLeft--;
        timeDisplay.innerText = timeLeft;
        
        if (timeLeft <= 0) {
            endGame("æ™‚é–“åˆ°ï¼");
        }
    }

    // éŠæˆ²çµæŸ
    function endGame(reason) {
        isGameActive = false;
        clearInterval(timerInterval);
        
        overlayTitle.innerText = reason;
        overlayDesc.innerText = `æœ€çµ‚åˆ†æ•¸: ${score} åˆ†`;
        overlay.style.display = 'flex'; // é¡¯ç¤ºé®ç½©
        
        // æŒ‰éˆ•æ–‡å­—æ”¹ç‚ºé‡æ–°é–‹å§‹
        document.querySelector('.btn-start').innerText = "å†ç©ä¸€æ¬¡";
    }

    // === é—œå¡é‚è¼¯ ===

    // ç”¢ç”Ÿä¸‹ä¸€é¡Œ
    function nextLevel() {
        if (!isGameActive) return;

        // é‡ç½®è¼¸å…¥å€
        inputY.value = '';
        inputY.disabled = false;
        fireBtn.style.display = 'block';
        fireBtn.disabled = false;
        nextBtn.style.display = 'none';
        messageDiv.innerHTML = "è«‹è¨ˆç®—ä¸¦è¼¸å…¥ y å€¼...";
        messageDiv.style.color = "#333";

        // éš¨æ©Ÿå‡ºé¡Œ
        generateQuestion();
        drawScene();
    }

    function generateQuestion() {
        // æ–œç‡ (-3 ~ 3)
        slope = Math.floor(Math.random() * 7) - 3; 
        if(slope === 0 && Math.random() > 0.7) slope = 1; // é™ä½å¸¸æ•¸å‡½æ•¸æ©Ÿç‡

        // æˆªè· (-5 ~ 5)
        intercept = Math.floor(Math.random() * 11) - 5;

        // ç›®æ¨™ x (-8 ~ 8)
        targetX = Math.floor(Math.random() * 17) - 8;
        
        correctY = slope * targetX + intercept;

        // æ ¼å¼åŒ–é¡¯ç¤º
        let sign = intercept >= 0 ? "+ " : "- ";
        let bVal = Math.abs(intercept);
        let equationText = `y = ${slope}x ${sign} ${bVal}`;
        if (slope === 0) equationText = `y = ${intercept}`; 
        else if (slope === 1) equationText = `y = x ${sign} ${bVal}`;
        else if (slope === -1) equationText = `y = -x ${sign} ${bVal}`;
        else if (intercept === 0) equationText = `y = ${slope}x`;

        document.getElementById('equation-display').innerHTML = `æ­¦å™¨: <span class="math-expr">${equationText}</span>`;
        document.getElementById('target-display').innerHTML = `ç›®æ¨™: <span class="math-expr">x = ${targetX}</span>`;
    }

    // === æ ¸å¿ƒäº’å‹• ===

    function fire() {
        if (!isGameActive) return;
        
        let valStr = inputY.value;
        if (valStr === '') { alert("è«‹è¼¸å…¥æ•¸å­—"); return; }
        
        let userVal = parseFloat(valStr);
        inputY.disabled = true;
        fireBtn.disabled = true;

        // ç¹ªè£½çµæœ
        drawScene(); // æ¸…ç©ºé‡ç•«
        drawTrajectory(userVal); // ç•«è»Œè·¡

        if (userVal === correctY) {
            // ç­”å°
            score += 100;
            consecutiveStrikes = 0; // é‡ç½®é€£éŒ¯è¨ˆæ•¸
            messageDiv.innerHTML = "ğŸ‰ å‘½ä¸­ç›®æ¨™ï¼ (+100åˆ†)";
            messageDiv.style.color = "green";
        } else {
            // ç­”éŒ¯
            consecutiveStrikes++;
            messageDiv.innerHTML = `ğŸ’¥ æ²’æ‰“ä¸­... æ­£ç¢ºæ˜¯ y=${correctY}`;
            messageDiv.style.color = "red";
            
            // æ¨™ç¤ºæ­£ç¢ºä½ç½®
            drawCorrectPoint();
        }

        updateUI();

        // æª¢æŸ¥æ˜¯å¦å¤±æ•—
        if (consecutiveStrikes >= 3) {
            setTimeout(() => { endGame("ä»»å‹™å¤±æ•—ï¼šé€£çºŒå¤±èª¤ 3 æ¬¡"); }, 1000);
        } else {
            // é¡¯ç¤ºä¸‹ä¸€é¡ŒæŒ‰éˆ•
            fireBtn.style.display = 'none';
            nextBtn.style.display = 'block';
            nextBtn.focus(); // è®“å­¸ç”Ÿå¯ä»¥ç›´æ¥æŒ‰ Enter é€²ä¸‹ä¸€é¡Œ
        }
    }

    function updateUI() {
        scoreDisplay.innerText = score;
        strikeDisplay.innerText = `${consecutiveStrikes}`;
        timeDisplay.innerText = timeLeft;
    }

    // === ç¹ªåœ–ç›¸é—œ ===

    function drawGrid() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        ctx.strokeStyle = "#e0e0e0";
        ctx.lineWidth = 1;
        // ç¶²æ ¼
        for(let x = 0; x <= canvas.width; x += scale) {
            ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, canvas.height); ctx.stroke();
        }
        for(let y = 0; y <= canvas.height; y += scale) {
            ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(canvas.width, y); ctx.stroke();
        }

        // è»¸
        ctx.strokeStyle = "#444";
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(0, centerY); ctx.lineTo(canvas.width, centerY);
        ctx.moveTo(centerX, 0); ctx.lineTo(centerX, canvas.height);
        ctx.stroke();
        
        // æ¨™è¨˜
        ctx.fillStyle = "#666";
        ctx.font = "14px Arial";
        ctx.fillText("O", centerX + 2, centerY + 15);
        ctx.fillText("x", canvas.width - 15, centerY - 5);
        ctx.fillText("y", centerX + 5, 15);
    }

    function drawScene() {
        drawGrid();
        // ç•«æ•µäººæç¤ºç·š
        let pixelX = centerX + targetX * scale;
        ctx.strokeStyle = "rgba(255, 0, 0, 0.3)";
        ctx.setLineDash([5, 5]);
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(pixelX, 0); ctx.lineTo(pixelX, canvas.height);
        ctx.stroke();
        ctx.setLineDash([]);
        
        ctx.fillStyle = "#d32f2f";
        ctx.fillText(`x=${targetX}`, pixelX - 10, centerY + 20);
    }

    function drawTrajectory(userY) {
        let pixelX = centerX + targetX * scale;
        let pixelY = centerY - userY * scale;

        // ç•«å‡½æ•¸ç·š (è‹¥ç­”å°æ˜¯ç¶ ç·šï¼Œç­”éŒ¯æ˜¯ç°ç·š)
        let isCorrect = (userY === correctY);
        ctx.strokeStyle = isCorrect ? "#4CAF50" : "#999"; 
        ctx.lineWidth = 3;
        
        // å»¶ä¼¸ç·šæ®µ
        let x1 = -20; let y1 = slope * x1 + intercept;
        let x2 = 20; let y2 = slope * x2 + intercept;
        
        // å¦‚æœç­”éŒ¯ï¼Œé€™æ¢ç·šæ‡‰è©²è¦æ­ªæ‰å»å°æº–ä½¿ç”¨è€…çš„éŒ¯èª¤é»
        // é€™è£¡çš„é‚è¼¯ï¼š
        // ç­”å° -> ç•«åŸæœ¬çš„å‡½æ•¸ç·š
        // ç­”éŒ¯ -> ç•«ä¸€æ¢é€šé (targetX, userY) çš„éŒ¯èª¤ç·š (ç‚ºäº†è¦–è¦ºæ•ˆæœï¼Œæˆ‘å€‘ç°¡å–®ç•«ä¸€æ¢é€šéè©²é»çš„è™›æ“¬ç·šï¼Œæˆ–è€…åªç•«æ‰“æ“Šé»)
        
        ctx.beginPath();
        if (isCorrect) {
            // ç•«å‡ºå®Œç¾çš„æ­£ç¢ºè»Œè·¡
            ctx.moveTo(centerX + x1 * scale, centerY - y1 * scale);
            ctx.lineTo(centerX + x2 * scale, centerY - y2 * scale);
        } else {
            // ç­”éŒ¯æ™‚ï¼Œç•«ä¸€æ¢å¾ç•«é¢å·¦å´å°„å‘éŒ¯èª¤é»çš„è»Œè·¡
            ctx.moveTo(0, pixelY); // ç°¡å–®ç¤ºæ„æ°´å¹³å°„å…¥ï¼Œæˆ–æ˜¯å¾åŸé»å°„å…¥
            ctx.lineTo(pixelX, pixelY);
        }
        ctx.stroke();

        // ç•«å½ˆè‘—é»
        ctx.beginPath();
        ctx.arc(pixelX, pixelY, 8, 0, Math.PI * 2);
        ctx.fillStyle = isCorrect ? "#4CAF50" : "#ff4444";
        ctx.fill();
    }

    function drawCorrectPoint() {
        let pixelX = centerX + targetX * scale;
        let pixelCorrectY = centerY - correctY * scale;
        
        ctx.beginPath();
        ctx.arc(pixelX, pixelCorrectY, 8, 0, Math.PI * 2);
        ctx.strokeStyle = "#4CAF50"; // ç¶ è‰²ç©ºå¿ƒåœ“è¡¨ç¤ºæ­£ç¢ºä½ç½®
        ctx.lineWidth = 2;
        ctx.stroke();
    }

    // éµç›¤æ”¯æ´
    inputY.addEventListener("keyup", function(event) {
        if (event.key === "Enter") {
            if (!inputY.disabled) fire();
            else if (nextBtn.style.display !== 'none') nextLevel();
        }
    });

    // åˆå§‹ç•«é¢
    drawGrid();

</script>
</body>
</html>
