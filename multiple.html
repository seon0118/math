import React, { useState, useEffect } from 'react';
import { Trophy, Star, RefreshCw, ArrowRight, CheckCircle, XCircle } from 'lucide-react';

export default function MultipleJudgmentGame() {
  const [currentLevel, setCurrentLevel] = useState(1);
  const [currentQuestion, setCurrentQuestion] = useState(1);
  const [score, setScore] = useState(0);
  const [currentNumber, setCurrentNumber] = useState('');
  const [currentMultiple, setCurrentMultiple] = useState(2);
  const [gameStatus, setGameStatus] = useState('playing'); // 'playing', 'completed', 'levelComplete'
  const [feedback, setFeedback] = useState('');
  const [showFeedback, setShowFeedback] = useState(false);
  const [totalScore, setTotalScore] = useState(0);
  const [timeLeft, setTimeLeft] = useState(10);
  const [timerActive, setTimerActive] = useState(false);

  // 遊戲設定
  const gameConfig = {
    1: { digits: 3, questionsPerLevel: 6 },
    2: { digits: 4, questionsPerLevel: 6 },
    3: { digits: 6, questionsPerLevel: 6 }
  };

  const multiples = [2, 4, 5, 8, 10, 11];

  // 產生指定位數的隨機數字
  const generateRandomNumber = (digits) => {
    const min = Math.pow(10, digits - 1);
    const max = Math.pow(10, digits) - 1;
    return Math.floor(Math.random() * (max - min + 1)) + min;
  };

  // 產生新題目
  const generateNewQuestion = () => {
    const config = gameConfig[currentLevel];
    const newNumber = generateRandomNumber(config.digits);
    const randomMultiple = multiples[Math.floor(Math.random() * multiples.length)];
    
    setCurrentNumber(newNumber.toString());
    setCurrentMultiple(randomMultiple);
    setShowFeedback(false);
    setFeedback('');
    setTimeLeft(10);
    setTimerActive(true);
  };

  // 計時器效果
  useEffect(() => {
    let interval;
    if (timerActive && timeLeft > 0 && !showFeedback) {
      interval = setInterval(() => {
        setTimeLeft(time => time - 1);
      }, 1000);
    } else if (timeLeft === 0 && !showFeedback) {
      // 時間到，自動判定為錯誤
      setTimerActive(false);
      setFeedback(`時間到！${currentNumber} ${parseInt(currentNumber) % currentMultiple === 0 ? '是' : '不是'} ${currentMultiple} 的倍數`);
      setShowFeedback(true);
      
      setTimeout(() => {
        if (currentQuestion < gameConfig[currentLevel].questionsPerLevel) {
          setCurrentQuestion(currentQuestion + 1);
          generateNewQuestion();
        } else {
          if (currentLevel < 3) {
            setGameStatus('levelComplete');
          } else {
            setGameStatus('completed');
          }
        }
      }, 2000);
    }
    return () => clearInterval(interval);
  }, [timerActive, timeLeft, showFeedback]);

  // 檢查答案
  const checkAnswer = (userAnswer) => {
    if (showFeedback || !timerActive) return; // 防止重複點擊
    
    setTimerActive(false);
    const number = parseInt(currentNumber);
    const isCorrect = (number % currentMultiple === 0) === userAnswer;
    
    if (isCorrect) {
      setScore(score + 1);
      setTotalScore(totalScore + 1);
      setFeedback('正確！');
    } else {
      setFeedback(`錯誤！${currentNumber} ${number % currentMultiple === 0 ? '是' : '不是'} ${currentMultiple} 的倍數`);
    }
    
    setShowFeedback(true);
    
    // 延遲後進入下一題或下一關
    setTimeout(() => {
      if (currentQuestion < gameConfig[currentLevel].questionsPerLevel) {
        setCurrentQuestion(currentQuestion + 1);
        generateNewQuestion();
      } else {
        // 關卡完成
        if (currentLevel < 3) {
          setGameStatus('levelComplete');
        } else {
          setGameStatus('completed');
        }
      }
    }, 2000);
  };

  // 進入下一關
  const nextLevel = () => {
    setCurrentLevel(currentLevel + 1);
    setCurrentQuestion(1);
    setScore(0);
    setGameStatus('playing');
    generateNewQuestion();
  };

  // 重新開始遊戲
  const restartGame = () => {
    setCurrentLevel(1);
    setCurrentQuestion(1);
    setScore(0);
    setTotalScore(0);
    setGameStatus('playing');
    setTimerActive(false);
    generateNewQuestion();
  };

  // 初始化遊戲
  useEffect(() => {
    generateNewQuestion();
  }, []);

  // 獲取關卡顏色
  const getLevelColor = (level) => {
    const colors = {
      1: 'bg-green-500',
      2: 'bg-blue-500',
      3: 'bg-purple-500'
    };
    return colors[level] || 'bg-gray-500';
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-indigo-100 to-purple-200 p-4">
      <div className="max-w-2xl mx-auto">
        {/* 標題 */}
        <div className="text-center mb-6">
          <h1 className="text-4xl font-bold text-gray-800 mb-2">倍數判斷闖關遊戲</h1>
          <div className="flex justify-center items-center gap-4 mb-4">
            <div className="flex items-center gap-2">
              <Star className="text-yellow-500" size={20} />
              <span className="text-lg font-semibold">總分: {totalScore}</span>
            </div>
            <div className="flex items-center gap-2">
              <Trophy className="text-purple-500" size={20} />
              <span className="text-lg font-semibold">第 {currentLevel} 關</span>
            </div>
          </div>
        </div>

        {/* 關卡進度 */}
        <div className="flex justify-center mb-6">
          {[1, 2, 3].map((level) => (
            <div
              key={level}
              className={`w-12 h-12 rounded-full flex items-center justify-center mx-2 text-white font-bold ${
                level === currentLevel
                  ? getLevelColor(level)
                  : level < currentLevel
                  ? 'bg-green-400'
                  : 'bg-gray-300'
              }`}
            >
              {level}
            </div>
          ))}
        </div>

        {/* 遊戲區域 */}
        <div className="bg-white rounded-xl shadow-lg p-8">
          {gameStatus === 'playing' && (
            <>
              {/* 題目資訊 */}
              <div className="text-center mb-6">
                <div className="text-sm text-gray-600 mb-2">
                  第 {currentLevel} 關 - 第 {currentQuestion} 題 / {gameConfig[currentLevel].questionsPerLevel} 題
                </div>
                <div className="text-sm text-gray-600 mb-4">
                  本關分數: {score} / {gameConfig[currentLevel].questionsPerLevel}
                </div>
                <div className="w-full bg-gray-200 rounded-full h-2 mb-4">
                  <div
                    className={`h-2 rounded-full ${getLevelColor(currentLevel)}`}
                    style={{
                      width: `${(currentQuestion / gameConfig[currentLevel].questionsPerLevel) * 100}%`
                    }}
                  ></div>
                </div>
                
                {/* 計時器 */}
                <div className="mb-4">
                  <div className={`text-3xl font-bold mb-2 ${
                    timeLeft <= 3 ? 'text-red-500 animate-pulse' : 
                    timeLeft <= 5 ? 'text-orange-500' : 'text-green-500'
                  }`}>
                    {timeLeft} 秒
                  </div>
                  <div className="w-full bg-gray-200 rounded-full h-3">
                    <div
                      className={`h-3 rounded-full transition-all duration-1000 ${
                        timeLeft <= 3 ? 'bg-red-500' : 
                        timeLeft <= 5 ? 'bg-orange-500' : 'bg-green-500'
                      }`}
                      style={{
                        width: `${(timeLeft / 10) * 100}%`
                      }}
                    ></div>
                  </div>
                </div>
              </div>

              {/* 題目 */}
              <div className="text-center mb-8">
                <div className="text-6xl font-mono font-bold text-gray-800 mb-4 p-4 bg-gray-50 rounded-lg">
                  {currentNumber}
                </div>
                <div className="text-2xl text-gray-700 mb-6">
                  這個數字是 <span className="font-bold text-blue-600">{currentMultiple}</span> 的倍數嗎？
                </div>

                {/* 答案按鈕 */}
                {!showFeedback && (
                  <div className="flex justify-center gap-6">
                    <button
                      onClick={() => checkAnswer(true)}
                      disabled={!timerActive}
                      className="bg-green-500 hover:bg-green-600 disabled:bg-gray-400 text-white font-bold py-4 px-8 rounded-lg text-xl transition-colors"
                    >
                      <CheckCircle className="inline mr-2" size={24} />
                      是
                    </button>
                    <button
                      onClick={() => checkAnswer(false)}
                      disabled={!timerActive}
                      className="bg-red-500 hover:bg-red-600 disabled:bg-gray-400 text-white font-bold py-4 px-8 rounded-lg text-xl transition-colors"
                    >
                      <XCircle className="inline mr-2" size={24} />
                      不是
                    </button>
                  </div>
                )}

                {/* 答案反饋 */}
                {showFeedback && (
                  <div className={`text-xl font-bold p-4 rounded-lg ${
                    feedback.includes('正確') ? 'bg-green-100 text-green-800' : 
                    feedback.includes('時間到') ? 'bg-orange-100 text-orange-800' :
                    'bg-red-100 text-red-800'
                  }`}>
                    {feedback}
                  </div>
                )}
              </div>
            </>
          )}

          {/* 關卡完成畫面 */}
          {gameStatus === 'levelComplete' && (
            <div className="text-center">
              <Trophy className="mx-auto text-yellow-500 mb-4" size={64} />
              <h2 className="text-3xl font-bold text-gray-800 mb-4">第 {currentLevel} 關完成！</h2>
              <div className="text-xl text-gray-600 mb-6">
                本關分數: {score} / {gameConfig[currentLevel].questionsPerLevel}
              </div>
              <button
                onClick={nextLevel}
                className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg text-xl transition-colors"
              >
                <ArrowRight className="inline mr-2" size={20} />
                進入第 {currentLevel + 1} 關
              </button>
            </div>
          )}

          {/* 遊戲完成畫面 */}
          {gameStatus === 'completed' && (
            <div className="text-center">
              <div className="text-6xl mb-4">🎉</div>
              <h2 className="text-3xl font-bold text-gray-800 mb-4">恭喜完成所有關卡！</h2>
              <div className="text-xl text-gray-600 mb-6">
                總分: {totalScore} / 18
              </div>
              <div className="text-lg text-gray-600 mb-6">
                最終關卡分數: {score} / {gameConfig[currentLevel].questionsPerLevel}
              </div>
              <button
                onClick={restartGame}
                className="bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg text-xl transition-colors"
              >
                <RefreshCw className="inline mr-2" size={20} />
                重新開始
              </button>
            </div>
          )}
        </div>

        {/* 遊戲說明 */}
        <div className="mt-6 bg-white rounded-lg p-4 text-sm text-gray-600">
          <h3 className="font-bold mb-2">遊戲規則：</h3>
          <ul className="space-y-1">
            <li>• 第一關：3位數，6題</li>
            <li>• 第二關：4位數，6題</li>
            <li>• 第三關：6位數，6題</li>
            <li>• 每題限時 10 秒作答</li>
            <li>• 每題隨機選擇倍數：2, 4, 5, 8, 10, 11</li>
            <li>• 判斷數字是否為指定倍數</li>
          </ul>
        </div>
      </div>
    </div>
  );
}
