<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•™å¸«æ•¸å­¸è§£é¡ŒéŠæˆ²ç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .header h1 {
            color: #4a5568;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #718096;
            font-size: 1.1em;
        }

        .nav-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #718096;
            transition: all 0.3s ease;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .nav-tab:hover:not(.active) {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }

        .tab-content {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
        }

        .btn.secondary {
            background: linear-gradient(135deg, #48bb78, #38a169);
        }

        .btn.danger {
            background: linear-gradient(135deg, #f56565, #e53e3e);
        }

        .file-upload {
            position: relative;
            display: inline-block;
            cursor: pointer;
            width: 100%;
        }

        .file-upload input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-upload-label {
            display: block;
            padding: 12px;
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            text-align: center;
            color: #718096;
            transition: all 0.3s ease;
        }

        .file-upload:hover .file-upload-label {
            border-color: #667eea;
            color: #667eea;
        }

        .image-preview {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            margin-top: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .question-item {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
        }

        .question-item h4 {
            color: #4a5568;
            margin-bottom: 10px;
        }

        .delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #f56565;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 16px;
        }

        .game-area {
            text-align: center;
        }

        .question-display {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            min-height: 200px;
        }

        .question-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .answer-input {
            width: 100%;
            max-width: 400px;
            padding: 15px;
            font-size: 18px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .game-stats {
            display: flex;
            justify-content: space-around;
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 14px;
            color: #718096;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e2e8f0;
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s ease;
        }

        .feedback {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
            text-align: center;
        }

        .feedback.correct {
            background: #c6f6d5;
            color: #22543d;
            border: 2px solid #48bb78;
        }

        .feedback.incorrect {
            background: #fed7d7;
            color: #742a2a;
            border: 2px solid #f56565;
        }

        .completion-screen {
            text-align: center;
            padding: 40px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 15px;
        }

        .completion-title {
            font-size: 2.5em;
            margin-bottom: 20px;
        }

        .completion-stats {
            font-size: 1.2em;
            margin-bottom: 30px;
        }

        .sample-file {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .sample-file h4 {
            color: #4a5568;
            margin-bottom: 15px;
        }

        .sample-code {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .tab-content {
                padding: 20px;
            }
            
            .game-stats {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“š æ•™å¸«æ•¸å­¸è§£é¡ŒéŠæˆ²ç³»çµ±</h1>
            <p>å‰µå»ºäº’å‹•å¼æ•¸å­¸é¡Œç›®ï¼Œæ”¯æ´åœ–ç‰‡ä¸Šå‚³èˆ‡éŠæˆ²å­˜æª”åŠŸèƒ½</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('create')">å‰µå»ºé¡Œç›®</button>
            <button class="nav-tab" onclick="switchTab('manage')">ç®¡ç†é¡Œç›®</button>
            <button class="nav-tab" onclick="switchTab('game')">éŠæˆ²æ¨¡å¼</button>
            <button class="nav-tab" onclick="switchTab('import')">åŒ¯å…¥é¡Œç›®</button>
            <button class="nav-tab" onclick="switchTab('save')">å­˜æª”ç®¡ç†</button>
        </div>

        <!-- å‰µå»ºé¡Œç›®æ¨™ç±¤ -->
        <div id="createTab" class="tab-content active">
            <h2>å‰µå»ºæ–°é¡Œç›®</h2>
            <form id="questionForm">
                <div class="form-group">
                    <label for="questionText">é¡Œç›®å…§å®¹ï¼š</label>
                    <textarea id="questionText" placeholder="è¼¸å…¥æ•¸å­¸é¡Œç›®..." required></textarea>
                </div>

                <div class="form-group">
                    <label for="questionImage">ä¸Šå‚³åœ–ç‰‡ï¼ˆå¯é¸ï¼‰ï¼š</label>
                    <div class="file-upload">
                        <input type="file" id="questionImage" accept="image/*" onchange="previewImage(this)">
                        <label for="questionImage" class="file-upload-label">
                            ğŸ“¸ é»æ“Šä¸Šå‚³åœ–ç‰‡æˆ–æ‹–æ‹½åœ–ç‰‡åˆ°æ­¤è™•
                        </label>
                    </div>
                    <img id="imagePreview" class="image-preview hidden" alt="åœ–ç‰‡é è¦½">
                </div>

                <div class="form-group">
                    <label for="correctAnswer">æ­£ç¢ºç­”æ¡ˆï¼š</label>
                    <input type="text" id="correctAnswer" placeholder="è¼¸å…¥æ­£ç¢ºç­”æ¡ˆ..." required>
                </div>

                <div class="form-group">
                    <label for="difficulty">é›£åº¦ç­‰ç´šï¼š</label>
                    <select id="difficulty">
                        <option value="1">ç°¡å–®</option>
                        <option value="2">æ™®é€š</option>
                        <option value="3">å›°é›£</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="explanation">è§£é¡Œèªªæ˜ï¼ˆå¯é¸ï¼‰ï¼š</label>
                    <textarea id="explanation" placeholder="è¼¸å…¥è§£é¡Œæ­¥é©Ÿæˆ–èªªæ˜..."></textarea>
                </div>

                <button type="submit" class="btn">æ·»åŠ é¡Œç›®</button>
                <button type="button" class="btn secondary" onclick="clearForm()">æ¸…ç©ºè¡¨å–®</button>
            </form>
        </div>

        <!-- ç®¡ç†é¡Œç›®æ¨™ç±¤ -->
        <div id="manageTab" class="tab-content">
            <h2>é¡Œç›®ç®¡ç†</h2>
            <div style="margin-bottom: 20px;">
                <button class="btn secondary" onclick="exportQuestions()">åŒ¯å‡ºé¡Œç›®</button>
                <button class="btn danger" onclick="clearAllQuestions()">æ¸…ç©ºæ‰€æœ‰é¡Œç›®</button>
                <span style="margin-left: 20px; color: #718096;">
                    ç›®å‰é¡Œç›®æ•¸é‡ï¼š<span id="questionCount">0</span>
                </span>
            </div>
            <div id="questionList"></div>
        </div>

        <!-- éŠæˆ²æ¨¡å¼æ¨™ç±¤ -->
        <div id="gameTab" class="tab-content">
            <div id="gameSetup">
                <h2>éŠæˆ²è¨­å®š</h2>
                <div class="form-group">
                    <label for="gameMode">éŠæˆ²æ¨¡å¼ï¼š</label>
                    <select id="gameMode">
                        <option value="all">æ‰€æœ‰é¡Œç›®</option>
                        <option value="difficulty">æŒ‰é›£åº¦ç¯©é¸</option>
                        <option value="random">éš¨æ©Ÿæ¨¡å¼</option>
                    </select>
                </div>
                <div class="form-group" id="difficultyFilter" style="display: none;">
                    <label for="selectedDifficulty">é¸æ“‡é›£åº¦ï¼š</label>
                    <select id="selectedDifficulty">
                        <option value="1">ç°¡å–®</option>
                        <option value="2">æ™®é€š</option>
                        <option value="3">å›°é›£</option>
                    </select>
                </div>
                <div class="form-group" id="randomCount" style="display: none;">
                    <label for="randomQuestionCount">é¡Œç›®æ•¸é‡ï¼š</label>
                    <input type="number" id="randomQuestionCount" value="5" min="1" max="20">
                </div>
                <button class="btn" onclick="startGame()">é–‹å§‹éŠæˆ²</button>
            </div>

            <div id="gamePlay" class="hidden">
                <div class="game-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="currentQuestion">1</div>
                        <div class="stat-label">ç›®å‰é¡Œç›®</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalQuestions">10</div>
                        <div class="stat-label">ç¸½é¡Œç›®æ•¸</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="correctCount">0</div>
                        <div class="stat-label">ç­”å°é¡Œæ•¸</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="timer">00:00</div>
                        <div class="stat-label">éŠæˆ²æ™‚é–“</div>
                    </div>
                </div>

                <div class="progress-bar">
                    <div class="progress-fill" id="gameProgress"></div>
                </div>

                <div class="question-display">
                    <div id="currentQuestionText"></div>
                    <img id="currentQuestionImage" class="question-image hidden" alt="é¡Œç›®åœ–ç‰‡">
                </div>

                <input type="text" id="gameAnswer" class="answer-input" placeholder="è¼¸å…¥ç­”æ¡ˆ..." onkeypress="handleKeyPress(event)">
                
                <div>
                    <button class="btn" onclick="submitAnswer()">æäº¤ç­”æ¡ˆ</button>
                    <button class="btn secondary" onclick="skipQuestion()">è·³éé¡Œç›®</button>
                    <button class="btn danger" onclick="endGame()">çµæŸéŠæˆ²</button>
                </div>

                <div id="gameFeedback" class="feedback hidden"></div>
            </div>

            <div id="gameComplete" class="completion-screen hidden">
                <h2 class="completion-title">ğŸ‰ éŠæˆ²å®Œæˆï¼</h2>
                <div class="completion-stats" id="finalStats"></div>
                <button class="btn" onclick="restartGame()">é‡æ–°é–‹å§‹</button>
                <button class="btn secondary" onclick="saveGameResult()">ä¿å­˜æˆç¸¾</button>
            </div>
        </div>

        <!-- åŒ¯å…¥é¡Œç›®æ¨™ç±¤ -->
        <div id="importTab" class="tab-content">
            <h2>åŒ¯å…¥é¡Œç›®</h2>
            
            <div class="form-group">
                <label for="importFile">é¸æ“‡é¡Œç›®æª”æ¡ˆï¼š</label>
                <div class="file-upload">
                    <input type="file" id="importFile" accept=".json" onchange="handleFileImport(this)">
                    <label for="importFile" class="file-upload-label">
                        ğŸ“ é¸æ“‡ JSON æª”æ¡ˆ
                    </label>
                </div>
            </div>

            <div class="sample-file">
                <h4>ç¯„ä¾‹æª”æ¡ˆæ ¼å¼ï¼š</h4>
                <div class="sample-code">
[
  {
    "question": "è¨ˆç®— 2 + 3 = ?",
    "answer": "5",
    "difficulty": 1,
    "explanation": "é€™æ˜¯åŸºæœ¬çš„åŠ æ³•é‹ç®—",
    "image": ""
  },
  {
    "question": "è§£æ–¹ç¨‹å¼ï¼š2x + 5 = 15",
    "answer": "5",
    "difficulty": 2,
    "explanation": "ç§»é …å¾—åˆ° 2x = 10ï¼Œæ‰€ä»¥ x = 5",
    "image": ""
  },
  {
    "question": "è¨ˆç®—åœ“å½¢é¢ç©ï¼ŒåŠå¾‘ = 3",
    "answer": "28.27",
    "difficulty": 3,
    "explanation": "ä½¿ç”¨å…¬å¼ A = Ï€rÂ²ï¼ŒA = Ï€ Ã— 3Â² â‰ˆ 28.27",
    "image": ""
  }
]
                </div>
            </div>

            <button class="btn secondary" onclick="downloadSampleFile()">ä¸‹è¼‰ç¯„ä¾‹æª”æ¡ˆ</button>
        </div>

        <!-- å­˜æª”ç®¡ç†æ¨™ç±¤ -->
        <div id="saveTab" class="tab-content">
            <h2>å­˜æª”ç®¡ç†</h2>
            
            <div style="margin-bottom: 20px;">
                <button class="btn" onclick="saveCurrentState()">ä¿å­˜ç›®å‰ç‹€æ…‹</button>
                <button class="btn secondary" onclick="loadGameState()">è¼‰å…¥å­˜æª”</button>
                <button class="btn danger" onclick="clearAllSaves()">æ¸…ç©ºæ‰€æœ‰å­˜æª”</button>
            </div>

            <div id="saveList"></div>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let questions = [];
        let gameState = {
            currentQuestionIndex: 0,
            correctAnswers: 0,
            gameQuestions: [],
            startTime: null,
            timerInterval: null,
            isGameActive: false
        };

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadQuestions();
            updateQuestionCount();
            loadSaveList();
            
            // éŠæˆ²æ¨¡å¼é¸æ“‡äº‹ä»¶ç›£è½
            document.getElementById('gameMode').addEventListener('change', function() {
                const mode = this.value;
                document.getElementById('difficultyFilter').style.display = mode === 'difficulty' ? 'block' : 'none';
                document.getElementById('randomCount').style.display = mode === 'random' ? 'block' : 'none';
            });

            // è¡¨å–®æäº¤äº‹ä»¶
            document.getElementById('questionForm').addEventListener('submit', function(e) {
                e.preventDefault();
                addQuestion();
            });
        });

        // æ¨™ç±¤åˆ‡æ›
        function switchTab(tabName) {
            // éš±è—æ‰€æœ‰æ¨™ç±¤å…§å®¹
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰æ¨™ç±¤çš„ active é¡
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // é¡¯ç¤ºé¸ä¸­çš„æ¨™ç±¤
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
            
            // æ›´æ–°ç›¸é—œå…§å®¹
            if (tabName === 'manage') {
                displayQuestions();
            } else if (tabName === 'save') {
                loadSaveList();
            }
        }

        // åœ–ç‰‡é è¦½
        function previewImage(input) {
            const preview = document.getElementById('imagePreview');
            
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                };
                
                reader.readAsDataURL(input.files[0]);
            } else {
                preview.classList.add('hidden');
            }
        }

        // æ·»åŠ é¡Œç›®
        function addQuestion() {
            const questionText = document.getElementById('questionText').value;
            const imageFile = document.getElementById('questionImage').files[0];
            const correctAnswer = document.getElementById('correctAnswer').value;
            const difficulty = parseInt(document.getElementById('difficulty').value);
            const explanation = document.getElementById('explanation').value;

            const question = {
                id: Date.now(),
                question: questionText,
                answer: correctAnswer.toLowerCase(),
                difficulty: difficulty,
                explanation: explanation,
                image: ''
            };

            if (imageFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    question.image = e.target.result;
                    questions.push(question);
                    saveQuestions();
                    updateQuestionCount();
                    clearForm();
                    alert('é¡Œç›®æ·»åŠ æˆåŠŸï¼');
                };
                reader.readAsDataURL(imageFile);
            } else {
                questions.push(question);
                saveQuestions();
                updateQuestionCount();
                clearForm();
                alert('é¡Œç›®æ·»åŠ æˆåŠŸï¼');
            }
        }

        // æ¸…ç©ºè¡¨å–®
        function clearForm() {
            document.getElementById('questionForm').reset();
            document.getElementById('imagePreview').classList.add('hidden');
        }

        // ä¿å­˜é¡Œç›®åˆ°æœ¬åœ°å­˜å„²
        function saveQuestions() {
            const questionsData = JSON.stringify(questions);
            // ä½¿ç”¨è®Šæ•¸æ¨¡æ“¬å­˜å„²
            window.questionsStorage = questionsData;
        }

        // è¼‰å…¥é¡Œç›®
        function loadQuestions() {
            try {
                const questionsData = window.questionsStorage;
                if (questionsData) {
                    questions = JSON.parse(questionsData);
                }
            } catch (error) {
                console.error('è¼‰å…¥é¡Œç›®å¤±æ•—:', error);
                questions = [];
            }
        }

        // æ›´æ–°é¡Œç›®æ•¸é‡é¡¯ç¤º
        function updateQuestionCount() {
            document.getElementById('questionCount').textContent = questions.length;
        }

        // é¡¯ç¤ºé¡Œç›®åˆ—è¡¨
        function displayQuestions() {
            const container = document.getElementById('questionList');
            container.innerHTML = '';

            if (questions.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #718096;">å°šæœªæœ‰ä»»ä½•é¡Œç›®</p>';
                return;
            }

            questions.forEach((question, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question-item';
                
                const difficultyText = ['', 'ç°¡å–®', 'æ™®é€š', 'å›°é›£'][question.difficulty];
                
                questionDiv.innerHTML = `
                    <button class="delete-btn" onclick="deleteQuestion(${question.id})">&times;</button>
                    <h4>é¡Œç›® ${index + 1} (${difficultyText})</h4>
                    <p><strong>é¡Œç›®ï¼š</strong>${question.question}</p>
                    ${question.image ? `<img src="${question.image}" alt="é¡Œç›®åœ–ç‰‡" style="max-width: 150px; margin: 10px 0; border-radius: 5px;">` : ''}
                    <p><strong>ç­”æ¡ˆï¼š</strong>${question.answer}</p>
                    ${question.explanation ? `<p><strong>èªªæ˜ï¼š</strong>${question.explanation}</p>` : ''}
                `;
                
                container.appendChild(questionDiv);
            });
        }

        // åˆªé™¤é¡Œç›®
        function deleteQuestion(id) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹é¡Œç›®å—ï¼Ÿ')) {
                questions = questions.filter(q => q.id !== id);
                saveQuestions();
                updateQuestionCount();
                displayQuestions();
            }
        }

        // æ¸…ç©ºæ‰€æœ‰é¡Œç›®
        function clearAllQuestions() {
            if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰é¡Œç›®å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) {
                questions = [];
                saveQuestions();
                updateQuestionCount();
                displayQuestions();
            }
        }

        // åŒ¯å‡ºé¡Œç›®
        function exportQuestions() {
            if (questions.length === 0) {
                alert('æ²’æœ‰é¡Œç›®å¯ä»¥åŒ¯å‡ºï¼');
                return;
            }

            const dataStr = JSON.stringify(questions, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = 'math_questions.json';
            link.click();
        }

        // è™•ç†æª”æ¡ˆåŒ¯å…¥
        function handleFileImport(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedQuestions = JSON.parse(e.target.result);
                    
                    if (!Array.isArray(importedQuestions)) {
                        throw new Error('æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼šå¿…é ˆæ˜¯é™£åˆ—æ ¼å¼');
                    }

                    // é©—è­‰é¡Œç›®æ ¼å¼
                    const validQuestions = importedQuestions.filter(q => 
                        q.question && q.answer && q.difficulty
                    ).map(q => ({
                        id: Date.now() + Math.random(),
                        question: q.question,
                        answer: q.answer.toString().toLowerCase(),
                        difficulty: parseInt(q.difficulty) || 1,
                        explanation: q.explanation || '',
                        image: q.image || ''
                    }));

                    if (validQuestions.length === 0) {
                        throw new Error('æ²’æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„é¡Œç›®');
                    }

                    questions = questions.concat(validQuestions);
                    saveQuestions();
                    updateQuestionCount();
                    
                    alert(`æˆåŠŸåŒ¯å…¥ ${validQuestions.length} é“é¡Œç›®ï¼`);
                    
                } catch (error) {
                    alert('åŒ¯å…¥å¤±æ•—ï¼š' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // ä¸‹è¼‰ç¯„ä¾‹æª”æ¡ˆ
        function downloadSampleFile() {
            const sampleData = [
                {
                    "question": "è¨ˆç®— 2 + 3 = ?",
                    "answer": "5",
                    "difficulty": 1,
                    "explanation": "é€™æ˜¯åŸºæœ¬çš„åŠ æ³•é‹ç®—",
                    "image": ""
                },
                {
                    "question": "è§£æ–¹ç¨‹å¼ï¼š2x + 5 = 15",
                    "answer": "5",
                    "difficulty": 2,
                    "explanation": "ç§»é …å¾—åˆ° 2x = 10ï¼Œæ‰€ä»¥ x = 5",
                    "image": ""
                },
                {
                    "question": "è¨ˆç®—åœ“å½¢é¢ç©ï¼ŒåŠå¾‘ = 3 (Ï€ â‰ˆ 3.14)",
                    "answer": "28.26",
                    "difficulty": 3,
                    "explanation": "ä½¿ç”¨å…¬å¼ A = Ï€rÂ²ï¼ŒA = 3.14 Ã— 3Â² = 28.26",
                    "image": ""
                }
            ];

            const dataStr = JSON.stringify(sampleData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = 'sample_math_questions.json';
            link.click();
        }

        // éŠæˆ²ç›¸é—œåŠŸèƒ½
        function startGame() {
            if (questions.length === 0) {
                alert('è«‹å…ˆæ·»åŠ é¡Œç›®æ‰èƒ½é–‹å§‹éŠæˆ²ï¼');
                return;
            }

            const gameMode = document.getElementById('gameMode').value;
            let gameQuestions = [];

            switch (gameMode) {
                case 'all':
                    gameQuestions = [...questions];
                    break;
                case 'difficulty':
                    const selectedDifficulty = parseInt(document.getElementById('selectedDifficulty').value);
                    gameQuestions = questions.filter(q => q.difficulty === selectedDifficulty);
                    break;
                case 'random':
                    const count = parseInt(document.getElementById('randomQuestionCount').value);
                    gameQuestions = shuffleArray([...questions]).slice(0, Math.min(count, questions.length));
                    break;
            }

            if (gameQuestions.length === 0) {
                alert('æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„é¡Œç›®ï¼');
                return;
            }

            // åˆå§‹åŒ–éŠæˆ²ç‹€æ…‹
            gameState = {
                currentQuestionIndex: 0,
                correctAnswers: 0,
                gameQuestions: shuffleArray(gameQuestions),
                startTime: Date.now(),
                timerInterval: null,
                isGameActive: true
            };

            // é¡¯ç¤ºéŠæˆ²ç•Œé¢
            document.getElementById('gameSetup').classList.add('hidden');
            document.getElementById('gamePlay').classList.remove('hidden');
            document.getElementById('gameComplete').classList.add('hidden');

            // æ›´æ–°éŠæˆ²çµ±è¨ˆ
            document.getElementById('totalQuestions').textContent = gameState.gameQuestions.length;
            document.getElementById('correctCount').textContent = '0';

            // é–‹å§‹è¨ˆæ™‚å™¨
            startTimer();

            // è¼‰å…¥ç¬¬ä¸€å€‹é¡Œç›®
            loadCurrentQuestion();
        }

        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function startTimer() {
            gameState.timerInterval = setInterval(() => {
                if (gameState.isGameActive) {
                    const elapsed = Math.floor((Date.now() - gameState.startTime) / 1000);
                    const minutes = Math.floor(elapsed / 60);
                    const seconds = elapsed % 60;
                    document.getElementById('timer').textContent = 
                        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
            }, 1000);
        }

        function stopTimer() {
            if (gameState.timerInterval) {
                clearInterval(gameState.timerInterval);
                gameState.timerInterval = null;
            }
        }

        function loadCurrentQuestion() {
            const question = gameState.gameQuestions[gameState.currentQuestionIndex];
            
            // æ›´æ–°é¡Œç›®ç·¨è™Ÿ
            document.getElementById('currentQuestion').textContent = gameState.currentQuestionIndex + 1;
            
            // æ›´æ–°é€²åº¦æ¢
            const progress = ((gameState.currentQuestionIndex + 1) / gameState.gameQuestions.length) * 100;
            document.getElementById('gameProgress').style.width = progress + '%';
            
            // é¡¯ç¤ºé¡Œç›®
            document.getElementById('currentQuestionText').textContent = question.question;
            
            // é¡¯ç¤ºåœ–ç‰‡ï¼ˆå¦‚æœæœ‰ï¼‰
            const imageElement = document.getElementById('currentQuestionImage');
            if (question.image) {
                imageElement.src = question.image;
                imageElement.classList.remove('hidden');
            } else {
                imageElement.classList.add('hidden');
            }
            
            // æ¸…ç©ºç­”æ¡ˆè¼¸å…¥æ¡†
            document.getElementById('gameAnswer').value = '';
            document.getElementById('gameAnswer').focus();
            
            // æ¸…ç©ºåé¥‹
            document.getElementById('gameFeedback').classList.add('hidden');
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                submitAnswer();
            }
        }

        function submitAnswer() {
            const userAnswer = document.getElementById('gameAnswer').value.trim().toLowerCase();
            const correctAnswer = gameState.gameQuestions[gameState.currentQuestionIndex].answer;
            const feedback = document.getElementById('gameFeedback');
            
            if (!userAnswer) {
                alert('è«‹è¼¸å…¥ç­”æ¡ˆï¼');
                return;
            }

            feedback.classList.remove('hidden');
            
            if (userAnswer === correctAnswer) {
                gameState.correctAnswers++;
                document.getElementById('correctCount').textContent = gameState.correctAnswers;
                feedback.textContent = 'âœ… ç­”å°äº†ï¼';
                feedback.className = 'feedback correct';
                
                // é¡¯ç¤ºè§£é¡Œèªªæ˜ï¼ˆå¦‚æœæœ‰ï¼‰
                const explanation = gameState.gameQuestions[gameState.currentQuestionIndex].explanation;
                if (explanation) {
                    feedback.textContent += ` è§£ç­”ï¼š${explanation}`;
                }
            } else {
                feedback.textContent = `âŒ ç­”éŒ¯äº†ï¼æ­£ç¢ºç­”æ¡ˆæ˜¯ï¼š${correctAnswer}`;
                feedback.className = 'feedback incorrect';
                
                // é¡¯ç¤ºè§£é¡Œèªªæ˜ï¼ˆå¦‚æœæœ‰ï¼‰
                const explanation = gameState.gameQuestions[gameState.currentQuestionIndex].explanation;
                if (explanation) {
                    feedback.textContent += ` è§£ç­”ï¼š${explanation}`;
                }
            }

            // å»¶é²å¾Œé€²å…¥ä¸‹ä¸€é¡Œ
            setTimeout(() => {
                nextQuestion();
            }, 3000);
        }

        function nextQuestion() {
            if (gameState.currentQuestionIndex < gameState.gameQuestions.length - 1) {
                gameState.currentQuestionIndex++;
                loadCurrentQuestion();
            } else {
                completeGame();
            }
        }

        function skipQuestion() {
            if (confirm('ç¢ºå®šè¦è·³éé€™å€‹é¡Œç›®å—ï¼Ÿ')) {
                nextQuestion();
            }
        }

        function endGame() {
            if (confirm('ç¢ºå®šè¦çµæŸéŠæˆ²å—ï¼Ÿ')) {
                gameState.isGameActive = false;
                completeGame();
            }
        }

        function completeGame() {
            gameState.isGameActive = false;
            stopTimer();
            
            // è¨ˆç®—çµ±è¨ˆæ•¸æ“š
            const totalQuestions = gameState.currentQuestionIndex + 1;
            const correctAnswers = gameState.correctAnswers;
            const accuracy = Math.round((correctAnswers / totalQuestions) * 100);
            const elapsed = Math.floor((Date.now() - gameState.startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            
            // é¡¯ç¤ºå®Œæˆç•«é¢
            document.getElementById('gamePlay').classList.add('hidden');
            document.getElementById('gameComplete').classList.remove('hidden');
            
            // æ›´æ–°çµ±è¨ˆè³‡è¨Š
            document.getElementById('finalStats').innerHTML = `
                <p>âœ… ç­”å°é¡Œæ•¸: ${correctAnswers} / ${totalQuestions}</p>
                <p>ğŸ“Š æº–ç¢ºç‡: ${accuracy}%</p>
                <p>â±ï¸ ç¸½æ™‚é–“: ${minutes}åˆ†${seconds}ç§’</p>
                <p>ğŸ¯ å¹³å‡æ¯é¡Œæ™‚é–“: ${Math.round(elapsed / totalQuestions)}ç§’</p>
            `;
        }

        function restartGame() {
            document.getElementById('gameComplete').classList.add('hidden');
            document.getElementById('gameSetup').classList.remove('hidden');
        }

        // å­˜æª”ç®¡ç†åŠŸèƒ½
        function saveCurrentState() {
            const saveData = {
                timestamp: new Date().toLocaleString(),
                questions: questions,
                gameResults: gameState.isGameActive ? null : {
                    correctAnswers: gameState.correctAnswers,
                    totalQuestions: gameState.currentQuestionIndex + 1,
                    accuracy: Math.round((gameState.correctAnswers / (gameState.currentQuestionIndex + 1)) * 100),
                    timeSpent: Math.floor((Date.now() - gameState.startTime) / 1000)
                }
            };

            const saves = getSaves();
            saves.push(saveData);
            window.gameSaves = JSON.stringify(saves);
            
            loadSaveList();
            alert('ç‹€æ…‹ä¿å­˜æˆåŠŸï¼');
        }

        function getSaves() {
            try {
                return window.gameSaves ? JSON.parse(window.gameSaves) : [];
            } catch (error) {
                return [];
            }
        }

        function loadSaveList() {
            const saves = getSaves();
            const container = document.getElementById('saveList');
            container.innerHTML = '';

            if (saves.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #718096;">æ²’æœ‰ä¿å­˜çš„è¨˜éŒ„</p>';
                return;
            }

            saves.forEach((save, index) => {
                const saveDiv = document.createElement('div');
                saveDiv.className = 'question-item';
                saveDiv.innerHTML = `
                    <button class="delete-btn" onclick="deleteSave(${index})">&times;</button>
                    <h4>å­˜æª” ${index + 1}</h4>
                    <p><strong>ä¿å­˜æ™‚é–“ï¼š</strong>${save.timestamp}</p>
                    <p><strong>é¡Œç›®æ•¸é‡ï¼š</strong>${save.questions.length}</p>
                    ${save.gameResults ? `
                        <p><strong>éŠæˆ²æˆç¸¾ï¼š</strong>${save.gameResults.correctAnswers}/${save.gameResults.totalQuestions} (${save.gameResults.accuracy}%)</p>
                        <p><strong>éŠæˆ²æ™‚é–“ï¼š</strong>${Math.floor(save.gameResults.timeSpent / 60)}åˆ†${save.gameResults.timeSpent % 60}ç§’</p>
                    ` : ''}
                    <button class="btn" onclick="loadSave(${index})" style="margin-top: 10px;">è¼‰å…¥æ­¤å­˜æª”</button>
                `;
                container.appendChild(saveDiv);
            });
        }

        function loadSave(index) {
            const saves = getSaves();
            if (saves[index]) {
                questions = saves[index].questions;
                saveQuestions();
                updateQuestionCount();
                alert('å­˜æª”è¼‰å…¥æˆåŠŸï¼');
                switchTab('manage');
            }
        }

        function deleteSave(index) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å­˜æª”å—ï¼Ÿ')) {
                const saves = getSaves();
                saves.splice(index, 1);
                window.gameSaves = JSON.stringify(saves);
                loadSaveList();
            }
        }

        function clearAllSaves() {
            if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰å­˜æª”å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) {
                window.gameSaves = JSON.stringify([]);
                loadSaveList();
            }
        }

        function loadGameState() {
            const saves = getSaves();
            if (saves.length === 0) {
                alert('æ²’æœ‰å¯è¼‰å…¥çš„å­˜æª”ï¼');
                return;
            }
            
            // è¼‰å…¥æœ€æ–°çš„å­˜æª”
            const latestSave = saves[saves.length - 1];
            questions = latestSave.questions;
            saveQuestions();
            updateQuestionCount();
            alert('éŠæˆ²ç‹€æ…‹è¼‰å…¥æˆåŠŸï¼');
        }

        function saveGameResult() {
            if (!gameState.isGameActive && gameState.correctAnswers !== undefined) {
                const resultData = {
                    timestamp: new Date().toLocaleString(),
                    questions: [],
                    gameResults: {
                        correctAnswers: gameState.correctAnswers,
                        totalQuestions: gameState.currentQuestionIndex + 1,
                        accuracy: Math.round((gameState.correctAnswers / (gameState.currentQuestionIndex + 1)) * 100),
                        timeSpent: Math.floor((Date.now() - gameState.startTime) / 1000)
                    }
                };

                const saves = getSaves();
                saves.push(resultData);
                window.gameSaves = JSON.stringify(saves);
                
                alert('éŠæˆ²æˆç¸¾ä¿å­˜æˆåŠŸï¼');
            } else {
                alert('æ²’æœ‰å¯ä¿å­˜çš„éŠæˆ²æˆç¸¾ï¼');
            }
        }