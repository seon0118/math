import React, { useState, useEffect } from 'react';
import { Trophy, Star, RefreshCw, ArrowRight, CheckCircle, XCircle } from 'lucide-react';

export default function MultipleJudgmentGame() {
  const [currentLevel, setCurrentLevel] = useState(1);
  const [currentQuestion, setCurrentQuestion] = useState(1);
  const [score, setScore] = useState(0);
  const [currentNumber, setCurrentNumber] = useState('');
  const [currentMultiple, setCurrentMultiple] = useState(2);
  const [gameStatus, setGameStatus] = useState('playing'); // 'playing', 'completed', 'levelComplete'
  const [feedback, setFeedback] = useState('');
  const [showFeedback, setShowFeedback] = useState(false);
  const [totalScore, setTotalScore] = useState(0);
  const [timeLeft, setTimeLeft] = useState(10);
  const [timerActive, setTimerActive] = useState(false);

  // éŠæˆ²è¨­å®š
  const gameConfig = {
    1: { digits: 3, questionsPerLevel: 6 },
    2: { digits: 4, questionsPerLevel: 6 },
    3: { digits: 6, questionsPerLevel: 6 }
  };

  const multiples = [2, 4, 5, 8, 10, 11];

  // ç”¢ç”ŸæŒ‡å®šä½æ•¸çš„éš¨æ©Ÿæ•¸å­—
  const generateRandomNumber = (digits) => {
    const min = Math.pow(10, digits - 1);
    const max = Math.pow(10, digits) - 1;
    return Math.floor(Math.random() * (max - min + 1)) + min;
  };

  // ç”¢ç”Ÿæ–°é¡Œç›®
  const generateNewQuestion = () => {
    const config = gameConfig[currentLevel];
    const newNumber = generateRandomNumber(config.digits);
    const randomMultiple = multiples[Math.floor(Math.random() * multiples.length)];
    
    setCurrentNumber(newNumber.toString());
    setCurrentMultiple(randomMultiple);
    setShowFeedback(false);
    setFeedback('');
    setTimeLeft(10);
    setTimerActive(true);
  };

  // è¨ˆæ™‚å™¨æ•ˆæœ
  useEffect(() => {
    let interval;
    if (timerActive && timeLeft > 0 && !showFeedback) {
      interval = setInterval(() => {
        setTimeLeft(time => time - 1);
      }, 1000);
    } else if (timeLeft === 0 && !showFeedback) {
      // æ™‚é–“åˆ°ï¼Œè‡ªå‹•åˆ¤å®šç‚ºéŒ¯èª¤
      setTimerActive(false);
      setFeedback(`æ™‚é–“åˆ°ï¼${currentNumber} ${parseInt(currentNumber) % currentMultiple === 0 ? 'æ˜¯' : 'ä¸æ˜¯'} ${currentMultiple} çš„å€æ•¸`);
      setShowFeedback(true);
      
      setTimeout(() => {
        if (currentQuestion < gameConfig[currentLevel].questionsPerLevel) {
          setCurrentQuestion(currentQuestion + 1);
          generateNewQuestion();
        } else {
          if (currentLevel < 3) {
            setGameStatus('levelComplete');
          } else {
            setGameStatus('completed');
          }
        }
      }, 2000);
    }
    return () => clearInterval(interval);
  }, [timerActive, timeLeft, showFeedback]);

  // æª¢æŸ¥ç­”æ¡ˆ
  const checkAnswer = (userAnswer) => {
    if (showFeedback || !timerActive) return; // é˜²æ­¢é‡è¤‡é»æ“Š
    
    setTimerActive(false);
    const number = parseInt(currentNumber);
    const isCorrect = (number % currentMultiple === 0) === userAnswer;
    
    if (isCorrect) {
      setScore(score + 1);
      setTotalScore(totalScore + 1);
      setFeedback('æ­£ç¢ºï¼');
    } else {
      setFeedback(`éŒ¯èª¤ï¼${currentNumber} ${number % currentMultiple === 0 ? 'æ˜¯' : 'ä¸æ˜¯'} ${currentMultiple} çš„å€æ•¸`);
    }
    
    setShowFeedback(true);
    
    // å»¶é²å¾Œé€²å…¥ä¸‹ä¸€é¡Œæˆ–ä¸‹ä¸€é—œ
    setTimeout(() => {
      if (currentQuestion < gameConfig[currentLevel].questionsPerLevel) {
        setCurrentQuestion(currentQuestion + 1);
        generateNewQuestion();
      } else {
        // é—œå¡å®Œæˆ
        if (currentLevel < 3) {
          setGameStatus('levelComplete');
        } else {
          setGameStatus('completed');
        }
      }
    }, 2000);
  };

  // é€²å…¥ä¸‹ä¸€é—œ
  const nextLevel = () => {
    setCurrentLevel(currentLevel + 1);
    setCurrentQuestion(1);
    setScore(0);
    setGameStatus('playing');
    generateNewQuestion();
  };

  // é‡æ–°é–‹å§‹éŠæˆ²
  const restartGame = () => {
    setCurrentLevel(1);
    setCurrentQuestion(1);
    setScore(0);
    setTotalScore(0);
    setGameStatus('playing');
    setTimerActive(false);
    generateNewQuestion();
  };

  // åˆå§‹åŒ–éŠæˆ²
  useEffect(() => {
    generateNewQuestion();
  }, []);

  // ç²å–é—œå¡é¡è‰²
  const getLevelColor = (level) => {
    const colors = {
      1: 'bg-green-500',
      2: 'bg-blue-500',
      3: 'bg-purple-500'
    };
    return colors[level] || 'bg-gray-500';
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-indigo-100 to-purple-200 p-4">
      <div className="max-w-2xl mx-auto">
        {/* æ¨™é¡Œ */}
        <div className="text-center mb-6">
          <h1 className="text-4xl font-bold text-gray-800 mb-2">å€æ•¸åˆ¤æ–·é—–é—œéŠæˆ²</h1>
          <div className="flex justify-center items-center gap-4 mb-4">
            <div className="flex items-center gap-2">
              <Star className="text-yellow-500" size={20} />
              <span className="text-lg font-semibold">ç¸½åˆ†: {totalScore}</span>
            </div>
            <div className="flex items-center gap-2">
              <Trophy className="text-purple-500" size={20} />
              <span className="text-lg font-semibold">ç¬¬ {currentLevel} é—œ</span>
            </div>
          </div>
        </div>

        {/* é—œå¡é€²åº¦ */}
        <div className="flex justify-center mb-6">
          {[1, 2, 3].map((level) => (
            <div
              key={level}
              className={`w-12 h-12 rounded-full flex items-center justify-center mx-2 text-white font-bold ${
                level === currentLevel
                  ? getLevelColor(level)
                  : level < currentLevel
                  ? 'bg-green-400'
                  : 'bg-gray-300'
              }`}
            >
              {level}
            </div>
          ))}
        </div>

        {/* éŠæˆ²å€åŸŸ */}
        <div className="bg-white rounded-xl shadow-lg p-8">
          {gameStatus === 'playing' && (
            <>
              {/* é¡Œç›®è³‡è¨Š */}
              <div className="text-center mb-6">
                <div className="text-sm text-gray-600 mb-2">
                  ç¬¬ {currentLevel} é—œ - ç¬¬ {currentQuestion} é¡Œ / {gameConfig[currentLevel].questionsPerLevel} é¡Œ
                </div>
                <div className="text-sm text-gray-600 mb-4">
                  æœ¬é—œåˆ†æ•¸: {score} / {gameConfig[currentLevel].questionsPerLevel}
                </div>
                <div className="w-full bg-gray-200 rounded-full h-2 mb-4">
                  <div
                    className={`h-2 rounded-full ${getLevelColor(currentLevel)}`}
                    style={{
                      width: `${(currentQuestion / gameConfig[currentLevel].questionsPerLevel) * 100}%`
                    }}
                  ></div>
                </div>
                
                {/* è¨ˆæ™‚å™¨ */}
                <div className="mb-4">
                  <div className={`text-3xl font-bold mb-2 ${
                    timeLeft <= 3 ? 'text-red-500 animate-pulse' : 
                    timeLeft <= 5 ? 'text-orange-500' : 'text-green-500'
                  }`}>
                    {timeLeft} ç§’
                  </div>
                  <div className="w-full bg-gray-200 rounded-full h-3">
                    <div
                      className={`h-3 rounded-full transition-all duration-1000 ${
                        timeLeft <= 3 ? 'bg-red-500' : 
                        timeLeft <= 5 ? 'bg-orange-500' : 'bg-green-500'
                      }`}
                      style={{
                        width: `${(timeLeft / 10) * 100}%`
                      }}
                    ></div>
                  </div>
                </div>
              </div>

              {/* é¡Œç›® */}
              <div className="text-center mb-8">
                <div className="text-6xl font-mono font-bold text-gray-800 mb-4 p-4 bg-gray-50 rounded-lg">
                  {currentNumber}
                </div>
                <div className="text-2xl text-gray-700 mb-6">
                  é€™å€‹æ•¸å­—æ˜¯ <span className="font-bold text-blue-600">{currentMultiple}</span> çš„å€æ•¸å—ï¼Ÿ
                </div>

                {/* ç­”æ¡ˆæŒ‰éˆ• */}
                {!showFeedback && (
                  <div className="flex justify-center gap-6">
                    <button
                      onClick={() => checkAnswer(true)}
                      disabled={!timerActive}
                      className="bg-green-500 hover:bg-green-600 disabled:bg-gray-400 text-white font-bold py-4 px-8 rounded-lg text-xl transition-colors"
                    >
                      <CheckCircle className="inline mr-2" size={24} />
                      æ˜¯
                    </button>
                    <button
                      onClick={() => checkAnswer(false)}
                      disabled={!timerActive}
                      className="bg-red-500 hover:bg-red-600 disabled:bg-gray-400 text-white font-bold py-4 px-8 rounded-lg text-xl transition-colors"
                    >
                      <XCircle className="inline mr-2" size={24} />
                      ä¸æ˜¯
                    </button>
                  </div>
                )}

                {/* ç­”æ¡ˆåé¥‹ */}
                {showFeedback && (
                  <div className={`text-xl font-bold p-4 rounded-lg ${
                    feedback.includes('æ­£ç¢º') ? 'bg-green-100 text-green-800' : 
                    feedback.includes('æ™‚é–“åˆ°') ? 'bg-orange-100 text-orange-800' :
                    'bg-red-100 text-red-800'
                  }`}>
                    {feedback}
                  </div>
                )}
              </div>
            </>
          )}

          {/* é—œå¡å®Œæˆç•«é¢ */}
          {gameStatus === 'levelComplete' && (
            <div className="text-center">
              <Trophy className="mx-auto text-yellow-500 mb-4" size={64} />
              <h2 className="text-3xl font-bold text-gray-800 mb-4">ç¬¬ {currentLevel} é—œå®Œæˆï¼</h2>
              <div className="text-xl text-gray-600 mb-6">
                æœ¬é—œåˆ†æ•¸: {score} / {gameConfig[currentLevel].questionsPerLevel}
              </div>
              <button
                onClick={nextLevel}
                className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg text-xl transition-colors"
              >
                <ArrowRight className="inline mr-2" size={20} />
                é€²å…¥ç¬¬ {currentLevel + 1} é—œ
              </button>
            </div>
          )}

          {/* éŠæˆ²å®Œæˆç•«é¢ */}
          {gameStatus === 'completed' && (
            <div className="text-center">
              <div className="text-6xl mb-4">ğŸ‰</div>
              <h2 className="text-3xl font-bold text-gray-800 mb-4">æ­å–œå®Œæˆæ‰€æœ‰é—œå¡ï¼</h2>
              <div className="text-xl text-gray-600 mb-6">
                ç¸½åˆ†: {totalScore} / 18
              </div>
              <div className="text-lg text-gray-600 mb-6">
                æœ€çµ‚é—œå¡åˆ†æ•¸: {score} / {gameConfig[currentLevel].questionsPerLevel}
              </div>
              <button
                onClick={restartGame}
                className="bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg text-xl transition-colors"
              >
                <RefreshCw className="inline mr-2" size={20} />
                é‡æ–°é–‹å§‹
              </button>
            </div>
          )}
        </div>

        {/* éŠæˆ²èªªæ˜ */}
        <div className="mt-6 bg-white rounded-lg p-4 text-sm text-gray-600">
          <h3 className="font-bold mb-2">éŠæˆ²è¦å‰‡ï¼š</h3>
          <ul className="space-y-1">
            <li>â€¢ ç¬¬ä¸€é—œï¼š3ä½æ•¸ï¼Œ6é¡Œ</li>
            <li>â€¢ ç¬¬äºŒé—œï¼š4ä½æ•¸ï¼Œ6é¡Œ</li>
            <li>â€¢ ç¬¬ä¸‰é—œï¼š6ä½æ•¸ï¼Œ6é¡Œ</li>
            <li>â€¢ æ¯é¡Œé™æ™‚ 10 ç§’ä½œç­”</li>
            <li>â€¢ æ¯é¡Œéš¨æ©Ÿé¸æ“‡å€æ•¸ï¼š2, 4, 5, 8, 10, 11</li>
            <li>â€¢ åˆ¤æ–·æ•¸å­—æ˜¯å¦ç‚ºæŒ‡å®šå€æ•¸</li>
          </ul>
        </div>
      </div>
    </div>
  );
}
