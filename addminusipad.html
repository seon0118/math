<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ëß∏Â±èÂ∑¶Âè≥Â∞çÊà∞Ê≠£Ë≤†Êï∏ÈÅäÊà≤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: manipulation;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(90deg, #ff6b6b 0%, #4ecdc4 50%, #45b7d1 100%);
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        .game-container {
            display: flex;
            height: 100vh;
            position: relative;
        }

        .player-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            position: relative;
            transition: all 0.3s ease;
        }

        .player-left {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            border-right: 5px solid #fff;
        }

        .player-right {
            background: linear-gradient(135deg, #45b7d1, #3498db);
            border-left: 5px solid #fff;
            transform: rotate(180deg);
        }

        .player-right * {
            transform: rotate(180deg);
        }

        .player-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .player-name {
            font-size: 2.5em;
            color: white;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            margin-bottom: 10px;
        }

        .player-score {
            font-size: 3em;
            color: white;
            font-weight: bold;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 10px 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .question-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            margin: 20px 0;
            padding: 30px;
            backdrop-filter: blur(10px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }

        .question-type {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            padding: 8px 20px;
            border-radius: 25px;
            font-size: 1em;
            font-weight: bold;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .question {
            font-size: 2.5em;
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            line-height: 1.2;
        }

        .number-line {
            width: 100%;
            margin: 20px 0;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .number-line svg {
            width: 100%;
            height: 80px;
        }

        .answer-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            width: 100%;
            max-width: 300px;
            margin-top: 20px;
        }

        .answer-option {
            padding: 20px;
            border: none;
            border-radius: 15px;
            font-size: 2em;
            font-weight: bold;
            color: #333;
            background: rgba(255, 255, 255, 0.9);
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .answer-option:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.3);
            background: white;
        }

        .answer-option:active {
            transform: scale(0.95);
        }

        .answer-option.selected {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            transform: scale(1.05);
            box-shadow: 0 15px 40px rgba(52, 152, 219, 0.4);
        }

        .answer-option.correct {
            background: linear-gradient(45deg, #2ecc71, #27ae60);
            color: white;
            animation: correctAnswer 0.6s ease;
        }

        .answer-option.incorrect {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            animation: incorrectAnswer 0.6s ease;
        }

        @keyframes correctAnswer {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @keyframes incorrectAnswer {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .manual-input-toggle {
            margin-top: 15px;
            padding: 10px 20px;
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .manual-input-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.8);
        }

        .manual-input-area {
            display: none;
            width: 100%;
            max-width: 300px;
            margin-top: 20px;
            flex-direction: column;
            gap: 15px;
        }

        .manual-input-area.active {
            display: flex;
        }

        .answer-input {
            width: 100%;
            padding: 20px;
            border: none;
            border-radius: 15px;
            font-size: 2em;
            text-align: center;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            font-weight: bold;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .answer-input:focus {
            outline: none;
            background: white;
            transform: scale(1.05);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.3);
        }

        .submit-btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 15px;
            font-size: 1.5em;
            font-weight: bold;
            color: white;
            background: linear-gradient(45deg, #2ecc71, #27ae60);
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .submit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
        }

        .submit-btn:active {
            transform: translateY(0);
        }

        .center-divider {
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 10px;
            background: linear-gradient(180deg, #fff, #f0f0f0, #fff);
            transform: translateX(-50%);
            z-index: 10;
        }

        .game-controls {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            text-align: center;
        }

        .game-controls.hidden {
            display: none;
        }

        .control-title {
            font-size: 2.5em;
            color: #333;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .time-setting {
            margin: 20px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .time-setting label {
            font-size: 1.2em;
            color: #333;
            font-weight: bold;
        }

        .time-setting input {
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1.2em;
            width: 80px;
            text-align: center;
        }

        .control-btn {
            padding: 15px 30px;
            margin: 10px;
            border: none;
            border-radius: 15px;
            font-size: 1.5em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .btn-start {
            background: linear-gradient(45deg, #2ecc71, #27ae60);
            color: white;
        }

        .btn-reset {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
        }

        .control-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
        }

        .timer-display {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(231, 76, 60, 0.9);
            color: white;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.8em;
            font-weight: bold;
            z-index: 50;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            display: none;
        }

        .timer-display.active {
            display: block;
            animation: timerPulse 1s infinite;
        }

        @keyframes timerPulse {
            0%, 100% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(1.05); }
        }

        .feedback {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 30px;
            border-radius: 20px;
            font-size: 2em;
            font-weight: bold;
            color: white;
            text-align: center;
            z-index: 200;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            opacity: 0;
            transition: all 0.5s ease;
        }

        .feedback.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1.1);
        }

        .feedback.correct {
            background: linear-gradient(45deg, #2ecc71, #27ae60);
        }

        .feedback.incorrect {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }

        .winner-display {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 300;
            color: white;
            display: none;
        }

        .winner-display.show {
            display: flex;
            animation: winnerShow 0.8s ease-out;
        }

        @keyframes winnerShow {
            from {
                opacity: 0;
                transform: scale(0.5);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .winner-text {
            font-size: 4em;
            font-weight: bold;
            margin-bottom: 30px;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.5);
        }

        .winner-score {
            font-size: 2.5em;
            margin-bottom: 40px;
        }

        @media (max-width: 768px) {
            .player-name {
                font-size: 1.8em;
            }

            .player-score {
                font-size: 2.2em;
                padding: 8px 15px;
            }

            .question {
                font-size: 1.8em;
            }

            .answer-input {
                font-size: 2em;
                padding: 15px;
            }

            .submit-btn {
                font-size: 1.5em;
                padding: 15px;
            }

            .control-title {
                font-size: 2em;
            }
        }

        @media (orientation: portrait) {
            .game-container {
                flex-direction: column;
            }

            .player-right {
                transform: rotate(0deg);
                border-left: none;
                border-top: 5px solid #fff;
            }

            .player-right * {
                transform: rotate(0deg);
            }

            .center-divider {
                left: 0;
                right: 0;
                top: 50%;
                bottom: auto;
                width: auto;
                height: 10px;
                background: linear-gradient(90deg, #fff, #f0f0f0, #fff);
                transform: translateY(-50%);
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- Â∑¶ÂÅ¥Áé©ÂÆ∂ -->
        <div class="player-area player-left">
            <div class="player-header">
                <div class="player-name">Áé©ÂÆ∂ 1</div>
                <div class="player-score" id="leftScore">0</div>
            </div>
            <div class="question-area">
                <div class="question-type" id="leftQuestionType">Á≠âÂæÖÈñãÂßã</div>
                <div class="question" id="leftQuestion">Ê∫ñÂÇôÂ•Ω‰∫ÜÂóéÔºü</div>
                <div class="number-line" id="leftNumberLine" style="display: none;"></div>
                
                <!-- ÈªûÊìäÂºèÁ≠îÊ°àÈÅ∏È†Ö -->
                <div class="answer-options" id="leftOptions" style="display: none;">
                    <button class="answer-option" onclick="selectAnswer('left', 0)"></button>
                    <button class="answer-option" onclick="selectAnswer('left', 1)"></button>
                    <button class="answer-option" onclick="selectAnswer('left', 2)"></button>
                    <button class="answer-option" onclick="selectAnswer('left', 3)"></button>
                </div>
                
                <!-- ÊâãÂãïËº∏ÂÖ•ÂàáÊèõ -->
                <button class="manual-input-toggle" id="leftToggle" onclick="toggleInputMode('left')" style="display: none;">
                    ÊâãÂãïËº∏ÂÖ•
                </button>
                
                <!-- ÊâãÂãïËº∏ÂÖ•ÂçÄÂüü -->
                <div class="manual-input-area" id="leftManualInput">
                    <input type="number" class="answer-input" id="leftAnswer" placeholder="Á≠îÊ°à" disabled>
                    <button class="submit-btn" id="leftSubmit" disabled>Êèê‰∫§</button>
                </div>
            </div>
        </div>

        <!-- Âè≥ÂÅ¥Áé©ÂÆ∂ -->
        <div class="player-area player-right">
            <div class="player-header">
                <div class="player-name">Áé©ÂÆ∂ 2</div>
                <div class="player-score" id="rightScore">0</div>
            </div>
            <div class="question-area">
                <div class="question-type" id="rightQuestionType">Á≠âÂæÖÈñãÂßã</div>
                <div class="question" id="rightQuestion">Ê∫ñÂÇôÂ•Ω‰∫ÜÂóéÔºü</div>
                <div class="number-line" id="rightNumberLine" style="display: none;"></div>
                
                <!-- ÈªûÊìäÂºèÁ≠îÊ°àÈÅ∏È†Ö -->
                <div class="answer-options" id="rightOptions" style="display: none;">
                    <button class="answer-option" onclick="selectAnswer('right', 0)"></button>
                    <button class="answer-option" onclick="selectAnswer('right', 1)"></button>
                    <button class="answer-option" onclick="selectAnswer('right', 2)"></button>
                    <button class="answer-option" onclick="selectAnswer('right', 3)"></button>
                </div>
                
                <!-- ÊâãÂãïËº∏ÂÖ•ÂàáÊèõ -->
                <button class="manual-input-toggle" id="rightToggle" onclick="toggleInputMode('right')" style="display: none;">
                    ÊâãÂãïËº∏ÂÖ•
                </button>
                
                <!-- ÊâãÂãïËº∏ÂÖ•ÂçÄÂüü -->
                <div class="manual-input-area" id="rightManualInput">
                    <input type="number" class="answer-input" id="rightAnswer" placeholder="Á≠îÊ°à" disabled>
                    <button class="submit-btn" id="rightSubmit" disabled>Êèê‰∫§</button>
                </div>
            </div>
        </div>

        <!-- ‰∏≠Â§ÆÂàÜÈöîÁ∑ö -->
        <div class="center-divider"></div>

        <!-- ÈÅäÊà≤ÊéßÂà∂Èù¢Êùø -->
        <div class="game-controls" id="gameControls">
            <div class="control-title">Ëß∏Â±èÂ∞çÊà∞ÈÅäÊà≤</div>
            <div class="time-setting">
                <label>Á≠îÈ°åÊôÇÈñì:</label>
                <input type="number" id="timeLimit" value="15" min="5" max="60">
                <span>Áßí</span>
            </div>
            <div class="time-setting">
                <label>ÂãùÂà©ÂàÜÊï∏:</label>
                <input type="number" id="winScore" value="5" min="3" max="20">
                <span>ÂàÜ</span>
            </div>
            <button class="control-btn btn-start" onclick="startGame()">ÈñãÂßãÈÅäÊà≤</button>
            <button class="control-btn btn-reset" onclick="resetGame()">ÈáçÁΩÆÈÅäÊà≤</button>
        </div>

        <!-- Ë®àÊôÇÂô® -->
        <div class="timer-display" id="timerDisplay"></div>

        <!-- ÂõûÈ•ãÊèêÁ§∫ -->
        <div class="feedback" id="feedback"></div>

        <!-- ÂãùÂà©Áï´Èù¢ -->
        <div class="winner-display" id="winnerDisplay">
            <div class="winner-text" id="winnerText"></div>
            <div class="winner-score" id="winnerScore"></div>
            <button class="control-btn btn-start" onclick="resetGame()">ÂÜç‰æÜ‰∏ÄÂ±Ä</button>
        </div>
    </div>

    <script>
        let gameState = {
            active: false,
            leftScore: 0,
            rightScore: 0,
            winScore: 5,
            timeLimit: 15,
            timer: null,
            timeRemaining: 0,
            currentQuestions: {
                left: null,
                right: null
            },
            questionStartTime: 0,
            selectedAnswers: {
                left: null,
                right: null
            },
            inputModes: {
                left: 'options', // 'options' or 'manual'
                right: 'options'
            }
        };

        const questionTypes = [
            'Ê≠£Ë≤†Êï∏Âä†Ê≥ï',
            'Ê≠£Ë≤†Êï∏Ê∏õÊ≥ï', 
            'Âä†Ê≥ï‰∫§ÊèõÂæã',
            'Âä†Ê≥ïÁµêÂêàÂæã',
            'ÂéªÊã¨Ëôü',
            'Êï∏Á∑öË∑ùÈõ¢'
        ];

        function generateAnswerOptions(correctAnswer) {
            const options = [correctAnswer];
            
            // ÁîüÊàê3ÂÄãÈåØË™§ÈÅ∏È†Ö
            while (options.length < 4) {
                let wrongAnswer;
                const variation = Math.floor(Math.random() * 5) + 1;
                
                switch (Math.floor(Math.random() * 4)) {
                    case 0:
                        wrongAnswer = correctAnswer + variation;
                        break;
                    case 1:
                        wrongAnswer = correctAnswer - variation;
                        break;
                    case 2:
                        wrongAnswer = correctAnswer * -1; // Á¨¶ËôüÈåØË™§
                        break;
                    case 3:
                        wrongAnswer = Math.abs(correctAnswer) === correctAnswer ? 
                                     correctAnswer - (Math.floor(Math.random() * 3) + 1) :
                                     correctAnswer + (Math.floor(Math.random() * 3) + 1);
                        break;
                }
                
                // Á¢∫‰øù‰∏çÈáçË§á‰∏î‰∏çÁ≠âÊñºÊ≠£Á¢∫Á≠îÊ°à
                if (!options.includes(wrongAnswer) && wrongAnswer !== correctAnswer) {
                    options.push(wrongAnswer);
                }
            }
            
            // Èö®Ê©üÊéíÂ∫è
            return options.sort(() => Math.random() - 0.5);
        }

        function displayAnswerOptions(side, correctAnswer) {
            const options = generateAnswerOptions(correctAnswer);
            const optionsDiv = document.getElementById(side + 'Options');
            const buttons = optionsDiv.querySelectorAll('.answer-option');
            
            buttons.forEach((button, index) => {
                button.textContent = options[index];
                button.classList.remove('selected', 'correct', 'incorrect');
                button.disabled = false;
            });
            
            // ÂÑ≤Â≠òÈÅ∏È†ÖÂíåÊ≠£Á¢∫Á≠îÊ°àÁöÑÂ∞çÊáâ
            gameState.currentQuestions[side].options = options;
            gameState.currentQuestions[side].correctIndex = options.indexOf(correctAnswer);
        }

        function selectAnswer(side, optionIndex) {
            if (!gameState.active) return;
            
            const optionsDiv = document.getElementById(side + 'Options');
            const buttons = optionsDiv.querySelectorAll('.answer-option');
            
            // Ê∏ÖÈô§‰πãÂâçÁöÑÈÅ∏Êìá
            buttons.forEach(btn => btn.classList.remove('selected'));
            
            // Ê®ôË®òÁï∂ÂâçÈÅ∏Êìá
            buttons[optionIndex].classList.add('selected');
            gameState.selectedAnswers[side] = optionIndex;
            
            // Ëá™ÂãïÊèê‰∫§Á≠îÊ°àÔºàÂª∂ÈÅ≤‰∏ÄÈªûËÆìÁî®Êà∂ÁúãÂà∞ÈÅ∏ÊìáÊïàÊûúÔºâ
            setTimeout(() => {
                checkAnswer(side);
            }, 300);
        }

        function toggleInputMode(side) {
            const currentMode = gameState.inputModes[side];
            const newMode = currentMode === 'options' ? 'manual' : 'options';
            gameState.inputModes[side] = newMode;
            
            const optionsDiv = document.getElementById(side + 'Options');
            const manualDiv = document.getElementById(side + 'ManualInput');
            const toggleBtn = document.getElementById(side + 'Toggle');
            
            if (newMode === 'manual') {
                optionsDiv.style.display = 'none';
                manualDiv.classList.add('active');
                toggleBtn.textContent = 'ÈÅ∏È†ÖÊ®°Âºè';
                document.getElementById(side + 'Answer').focus();
            } else {
                optionsDiv.style.display = 'grid';
                manualDiv.classList.remove('active');
                toggleBtn.textContent = 'ÊâãÂãïËº∏ÂÖ•';
            }
        }

        function generateQuestion() {
            const type = Math.floor(Math.random() * 6);
            let question = '';
            let answer = 0;
            let questionType = '';
            let needsNumberLine = false;

            switch(type) {
                case 0: // Ê≠£Ë≤†Êï∏Âä†Ê≥ï
                    questionType = 'Ê≠£Ë≤†Êï∏Âä†Ê≥ï';
                    const a1 = Math.floor(Math.random() * 21) - 10;
                    const b1 = Math.floor(Math.random() * 21) - 10;
                    question = `${a1} + (${b1})`;
                    answer = a1 + b1;
                    break;

                case 1: // Ê≠£Ë≤†Êï∏Ê∏õÊ≥ï
                    questionType = 'Ê≠£Ë≤†Êï∏Ê∏õÊ≥ï';
                    const a2 = Math.floor(Math.random() * 21) - 10;
                    const b2 = Math.floor(Math.random() * 21) - 10;
                    question = `${a2} - (${b2})`;
                    answer = a2 - b2;
                    break;

                case 2: // Âä†Ê≥ï‰∫§ÊèõÂæã
                    questionType = 'Âä†Ê≥ï‰∫§ÊèõÂæã';
                    const a3 = Math.floor(Math.random() * 21) - 10;
                    const b3 = Math.floor(Math.random() * 21) - 10;
                    const showOriginal = Math.random() > 0.5;
                    if (showOriginal) {
                        question = `${a3} + (${b3}) = (${b3}) + ?`;
                        answer = a3;
                    } else {
                        question = `(${a3}) + ${b3} = ? + (${a3})`;
                        answer = b3;
                    }
                    break;

                case 3: // Âä†Ê≥ïÁµêÂêàÂæã
                    questionType = 'Âä†Ê≥ïÁµêÂêàÂæã';
                    const a4 = Math.floor(Math.random() * 11) - 5;
                    const b4 = Math.floor(Math.random() * 11) - 5;
                    const c4 = Math.floor(Math.random() * 11) - 5;
                    const leftAssoc = Math.random() > 0.5;
                    if (leftAssoc) {
                        question = `(${a4} + ${b4}) + (${c4}) = ${a4} + (${b4} + ?)`;
                        answer = c4;
                    } else {
                        question = `${a4} + (${b4} + ${c4}) = (${a4} + ?) + ${c4}`;
                        answer = b4;
                    }
                    break;

                case 4: // ÂéªÊã¨Ëôü
                    questionType = 'ÂéªÊã¨Ëôü';
                    const a5 = Math.floor(Math.random() * 11) - 5;
                    const b5 = Math.floor(Math.random() * 11) - 5;
                    const operation = Math.random() > 0.5 ? '+' : '-';
                    if (operation === '+') {
                        question = `${a5} + (${b5})`;
                        answer = a5 + b5;
                    } else {
                        question = `${a5} - (${b5})`;
                        answer = a5 - b5;
                    }
                    break;

                case 5: // Êï∏Á∑ö‰∏äÂÖ©ÈªûÈñìÁöÑË∑ùÈõ¢
                    questionType = 'Êï∏Á∑öË∑ùÈõ¢';
                    const p1 = Math.floor(Math.random() * 21) - 10;
                    const p2 = Math.floor(Math.random() * 21) - 10;
                    question = `Èªû ${p1} ËàáÈªû ${p2} ÁöÑË∑ùÈõ¢`;
                    answer = Math.abs(p1 - p2);
                    needsNumberLine = true;
                    break;
            }

            return {
                question,
                answer,
                type: questionType,
                needsNumberLine,
                p1: type === 5 ? p1 : null,
                p2: type === 5 ? p2 : null
            };
        }

        function drawNumberLine(container, p1, p2) {
            const min = Math.min(p1, p2, -10);
            const max = Math.max(p1, p2, 10);
            const range = max - min;
            const width = 300;
            const height = 80;
            const padding = 30;

            const svg = `
                <svg width="${width}" height="${height}" viewBox="0 0 ${width} ${height}">
                    <line x1="${padding}" y1="40" x2="${width - padding}" y2="40" stroke="#333" stroke-width="2"/>
                    ${generateTicks(min, max, width, padding)}
                    <circle cx="${padding + ((p1 - min) / range) * (width - 2 * padding)}" cy="40" r="4" fill="#e74c3c"/>
                    <text x="${padding + ((p1 - min) / range) * (width - 2 * padding)}" y="25" text-anchor="middle" fill="#e74c3c" font-weight="bold" font-size="12">${p1}</text>
                    <circle cx="${padding + ((p2 - min) / range) * (width - 2 * padding)}" cy="40" r="4" fill="#3498db"/>
                    <text x="${padding + ((p2 - min) / range) * (width - 2 * padding)}" y="60" text-anchor="middle" fill="#3498db" font-weight="bold" font-size="12">${p2}</text>
                </svg>
            `;
            
            container.innerHTML = svg;
            container.style.display = 'block';
        }

        function generateTicks(min, max, width, padding) {
            let ticks = '';
            const range = max - min;
            for (let i = min; i <= max; i++) {
                const x = padding + ((i - min) / range) * (width - 2 * padding);
                ticks += `<line x1="${x}" y1="35" x2="${x}" y2="45" stroke="#666" stroke-width="1"/>`;
                if (i % 2 === 0) {
                    ticks += `<text x="${x}" y="55" text-anchor="middle" font-size="10" fill="#666">${i}</text>`;
                }
            }
            return ticks;
        }

        function startGame() {
            gameState.active = true;
            gameState.leftScore = 0;
            gameState.rightScore = 0;
            gameState.winScore = parseInt(document.getElementById('winScore').value);
            gameState.timeLimit = parseInt(document.getElementById('timeLimit').value);

            document.getElementById('gameControls').classList.add('hidden');
            document.getElementById('winnerDisplay').classList.remove('show');
            
            updateScores();
            enableInputs();
            nextRound();
        }

        function nextRound() {
            if (!gameState.active) return;

            // ÈáçÁΩÆÈÅ∏ÊìáÁãÄÊÖã
            gameState.selectedAnswers.left = null;
            gameState.selectedAnswers.right = null;

            // ÁîüÊàêÊñ∞È°åÁõÆ
            gameState.currentQuestions.left = generateQuestion();
            gameState.currentQuestions.right = generateQuestion();

            // Êõ¥Êñ∞Â∑¶ÂÅ¥
            document.getElementById('leftQuestionType').textContent = gameState.currentQuestions.left.type;
            document.getElementById('leftQuestion').textContent = gameState.currentQuestions.left.question;
            document.getElementById('leftAnswer').value = '';
            document.getElementById('leftNumberLine').style.display = 'none';
            document.getElementById('leftOptions').style.display = 'none';
            document.getElementById('leftToggle').style.display = 'none';
            
            // Ê†πÊìöËº∏ÂÖ•Ê®°ÂºèÈ°ØÁ§∫Áõ∏ÊáâÁïåÈù¢
            if (gameState.inputModes.left === 'options') {
                document.getElementById('leftOptions').style.display = 'grid';
                document.getElementById('leftToggle').style.display = 'block';
                displayAnswerOptions('left', gameState.currentQuestions.left.answer);
            } else {
                document.getElementById('leftManualInput').classList.add('active');
                document.getElementById('leftToggle').style.display = 'block';
            }

            if (gameState.currentQuestions.left.needsNumberLine) {
                drawNumberLine(
                    document.getElementById('leftNumberLine'),
                    gameState.currentQuestions.left.p1,
                    gameState.currentQuestions.left.p2
                );
            }

            // Êõ¥Êñ∞Âè≥ÂÅ¥
            document.getElementById('rightQuestionType').textContent = gameState.currentQuestions.right.type;
            document.getElementById('rightQuestion').textContent = gameState.currentQuestions.right.question;
            document.getElementById('rightAnswer').value = '';
            document.getElementById('rightNumberLine').style.display = 'none';
            document.getElementById('rightOptions').style.display = 'none';
            document.getElementById('rightToggle').style.display = 'none';
            
            // Ê†πÊìöËº∏ÂÖ•Ê®°ÂºèÈ°ØÁ§∫Áõ∏ÊáâÁïåÈù¢
            if (gameState.inputModes.right === 'options') {
                document.getElementById('rightOptions').style.display = 'grid';
                document.getElementById('rightToggle').style.display = 'block';
                displayAnswerOptions('right', gameState.currentQuestions.right.answer);
            } else {
                document.getElementById('rightManualInput').classList.add('active');
                document.getElementById('rightToggle').style.display = 'block';
            }

            if (gameState.currentQuestions.right.needsNumberLine) {
                drawNumberLine(
                    document.getElementById('rightNumberLine'),
                    gameState.currentQuestions.right.p1,
                    gameState.currentQuestions.right.p2
                );
            }

            // ÈñãÂßãË®àÊôÇ
            startTimer();
        }

        function startTimer() {
            gameState.timeRemaining = gameState.timeLimit;
            gameState.questionStartTime = Date.now();
            
            const timerDisplay = document.getElementById('timerDisplay');
            timerDisplay.classList.add('active');
            
            if (gameState.timer) {
                clearInterval(gameState.timer);
            }
            
            gameState.timer = setInterval(() => {
                gameState.timeRemaining--;
                timerDisplay.textContent = `${gameState.timeRemaining} Áßí`;
                
                if (gameState.timeRemaining <= 0) {
                    clearInterval(gameState.timer);
                    timerDisplay.classList.remove('active');
                    showFeedback('ÊôÇÈñìÂà∞ÔºÅ', 'incorrect');
                    setTimeout(nextRound, 2000);
                }
            }, 1000);
        }

        function checkAnswer(side) {
            if (!gameState.active) return;

            let userAnswer;
            let isCorrect = false;

            if (gameState.inputModes[side] === 'options') {
                // ÈÅ∏È†ÖÊ®°Âºè
                const selectedIndex = gameState.selectedAnswers[side];
                if (selectedIndex === null) return;
                
                const correctIndex = gameState.currentQuestions[side].correctIndex;
                isCorrect = selectedIndex === correctIndex;
                userAnswer = gameState.currentQuestions[side].options[selectedIndex];
                
                // Ë¶ñË¶∫ÂõûÈ•ã
                const optionsDiv = document.getElementById(side + 'Options');
                const buttons = optionsDiv.querySelectorAll('.answer-option');
                
                if (isCorrect) {
                    buttons[selectedIndex].classList.add('correct');
                } else {
                    buttons[selectedIndex].classList.add('incorrect');
                    buttons[correctIndex].classList.add('correct');
                }
                
                // Á¶ÅÁî®ÊâÄÊúâÈÅ∏È†Ö
                buttons.forEach(btn => btn.disabled = true);
                
            } else {
                // ÊâãÂãïËº∏ÂÖ•Ê®°Âºè
                userAnswer = parseFloat(document.getElementById(side + 'Answer').value);
                const correctAnswer = gameState.currentQuestions[side].answer;
                isCorrect = Math.abs(userAnswer - correctAnswer) < 0.001;
            }

            if (isCorrect) {
                if (side === 'left') {
                    gameState.leftScore++;
                } else {
                    gameState.rightScore++;
                }
                
                updateScores();
                
                // ÂÅúÊ≠¢Ë®àÊôÇÂô®
                if (gameState.timer) {
                    clearInterval(gameState.timer);
                    document.getElementById('timerDisplay').classList.remove('active');
                }

                showFeedback(`${side === 'left' ? 'Áé©ÂÆ∂1' : 'Áé©ÂÆ∂2'} Á≠îÂ∞ç‰∫ÜÔºÅ`, 'correct');

                // Ê™¢Êü•ÊòØÂê¶ÊúâÁé©ÂÆ∂Áç≤Âãù
                if (gameState.leftScore >= gameState.winScore || gameState.rightScore >= gameState.winScore) {
                    setTimeout(showWinner, 1500);
                } else {
                    setTimeout(nextRound, 2000);
                }
            } else if (gameState.inputModes[side] === 'manual') {
                // Âè™ÊúâÊâãÂãïËº∏ÂÖ•Ê®°ÂºèÊâçÈ°ØÁ§∫ÈåØË™§ÊèêÁ§∫ÔºàÈÅ∏È†ÖÊ®°ÂºèÂ∑≤Á∂ìÊúâË¶ñË¶∫ÂõûÈ•ãÔºâ
                const correctAnswer = gameState.currentQuestions[side].answer;
                showFeedback(`Á≠îÈåØ‰∫ÜÔºÅÊ≠£Á¢∫Á≠îÊ°àÊòØ ${correctAnswer}`, 'incorrect');
            }
        }

        function showFeedback(message, type) {
            const feedback = document.getElementById('feedback');
            feedback.textContent = message;
            feedback.classList.remove('correct', 'incorrect');
            feedback.classList.add(type, 'show');
            
            setTimeout(() => {
                feedback.classList.remove('show');
            }, 1500);
        }

        function showWinner() {
            gameState.active = false;
            const winner = gameState.leftScore >= gameState.winScore ? 'Áé©ÂÆ∂ 1' : 'Áé©ÂÆ∂ 2';
            const winnerScore = Math.max(gameState.leftScore, gameState.rightScore);
            const loserScore = Math.min(gameState.leftScore, gameState.rightScore);

            document.getElementById('winnerText').textContent = `üéâ ${winner} Áç≤ÂãùÔºÅ üéâ`;
            document.getElementById('winnerScore').textContent = `ÊúÄÁµÇÊØîÂàÜ: ${winnerScore} : ${loserScore}`;
            document.getElementById('winnerDisplay').classList.add('show');

            disableInputs();
        }

        function updateScores() {
            document.getElementById('leftScore').textContent = gameState.leftScore;
            document.getElementById('rightScore').textContent = gameState.rightScore;
        }

        function enableInputs() {
            document.getElementById('leftAnswer').disabled = false;
            document.getElementById('rightAnswer').disabled = false;
            document.getElementById('leftSubmit').disabled = false;
            document.getElementById('rightSubmit').disabled = false;
            
            // ÂïüÁî®ÈÅ∏È†ÖÊåâÈàï
            const leftOptions = document.getElementById('leftOptions').querySelectorAll('.answer-option');
            const rightOptions = document.getElementById('rightOptions').querySelectorAll('.answer-option');
            leftOptions.forEach(btn => btn.disabled = false);
            rightOptions.forEach(btn => btn.disabled = false);
        }

        function disableInputs() {
            document.getElementById('leftAnswer').disabled = true;
            document.getElementById('rightAnswer').disabled = true;
            document.getElementById('leftSubmit').disabled = true;
            document.getElementById('rightSubmit').disabled = true;
            
            // Á¶ÅÁî®ÈÅ∏È†ÖÊåâÈàï
            const leftOptions = document.getElementById('leftOptions').querySelectorAll('.answer-option');
            const rightOptions = document.getElementById('rightOptions').querySelectorAll('.answer-option');
            leftOptions.forEach(btn => btn.disabled = true);
            rightOptions.forEach(btn => btn.disabled = true);
        }

        function resetGame() {
            gameState.active = false;
            gameState.leftScore = 0;
            gameState.rightScore = 0;
            gameState.selectedAnswers.left = null;
            gameState.selectedAnswers.right = null;
            gameState.inputModes.left = 'options';
            gameState.inputModes.right = 'options';

            if (gameState.timer) {
                clearInterval(gameState.timer);
            }

            document.getElementById('timerDisplay').classList.remove('active');
            document.getElementById('gameControls').classList.remove('hidden');
            document.getElementById('winnerDisplay').classList.remove('show');
            document.getElementById('feedback').classList.remove('show');

            // ÈáçÁΩÆÁïåÈù¢
            document.getElementById('leftQuestionType').textContent = 'Á≠âÂæÖÈñãÂßã';
            document.getElementById('leftQuestion').textContent = 'Ê∫ñÂÇôÂ•Ω‰∫ÜÂóéÔºü';
            document.getElementById('rightQuestionType').textContent = 'Á≠âÂæÖÈñãÂßã';
            document.getElementById('rightQuestion').textContent = 'Ê∫ñÂÇôÂ•Ω‰∫ÜÂóéÔºü';
            
            // Èö±ËóèÊâÄÊúâÁ≠îÈ°åÁïåÈù¢
            document.getElementById('leftNumberLine').style.display = 'none';
            document.getElementById('rightNumberLine').style.display = 'none';
            document.getElementById('leftOptions').style.display = 'none';
            document.getElementById('rightOptions').style.display = 'none';
            document.getElementById('leftToggle').style.display = 'none';
            document.getElementById('rightToggle').style.display = 'none';
            document.getElementById('leftManualInput').classList.remove('active');
            document.getElementById('rightManualInput').classList.remove('active');

            updateScores();
            disableInputs();

            // Ê∏ÖÁ©∫Ëº∏ÂÖ•Ê°Ü
            document.getElementById('leftAnswer').value = '';
            document.getElementById('rightAnswer').value = '';
        }

        // ‰∫ã‰ª∂Áõ£ËÅΩÂô®
        document.getElementById('leftSubmit').addEventListener('click', () => checkAnswer('left'));
        document.getElementById('rightSubmit').addEventListener('click', () => checkAnswer('right'));

        document.getElementById('leftAnswer').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && gameState.active) {
                checkAnswer('left');
            }
        });

        document.getElementById('rightAnswer').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && gameState.active) {
                checkAnswer('right');
            }
        });

        // Ëß∏Êë∏‰∫ã‰ª∂ÂÑ™Âåñ
        document.addEventListener('touchstart', function(e) {
            // Èò≤Ê≠¢ÈõôÊìäÁ∏ÆÊîæ
            if (e.touches.length > 1) {
                e.preventDefault();
            }
        });

        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(e) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                e.preventDefault();
            }
            lastTouchEnd = now;
        }, false);

        // ÂàùÂßãÂåñÈÅäÊà≤ÁãÄÊÖã
        updateScores();
        disableInputs();

        // Ëá™ÂãïËÅöÁÑ¶Ëº∏ÂÖ•Ê°ÜÔºàËß∏Â±èÂèãÂ•ΩÔºâ
        function focusInput(side) {
            if (gameState.inputModes[side] === 'manual') {
                const input = document.getElementById(side + 'Answer');
                if (!input.disabled) {
                    input.focus();
                    input.click();
                }
            }
        }

        // ÁÇ∫Ëß∏Â±èÂÑ™ÂåñÁöÑÈªûÊìä‰∫ã‰ª∂
        document.getElementById('leftAnswer').addEventListener('touchstart', () => {
            if (gameState.active && gameState.inputModes.left === 'manual') {
                focusInput('left');
            }
        });

        document.getElementById('rightAnswer').addEventListener('touchstart', () => {
            if (gameState.active && gameState.inputModes.right === 'manual') {
                focusInput('right');
            }
        });

        // Ê∑ªÂä†Ëß∏Êë∏ÂèçÈ•ã
        function addTouchFeedback() {
            const allButtons = document.querySelectorAll('.answer-option, .control-btn, .submit-btn, .manual-input-toggle');
            
            allButtons.forEach(button => {
                button.addEventListener('touchstart', function() {
                    this.style.transform = 'scale(0.95)';
                });
                
                button.addEventListener('touchend', function() {
                    setTimeout(() => {
                        this.style.transform = '';
                    }, 100);
                });
            });
        }

        // Èò≤Ê≠¢ÈÅ∏È†ÖÊåâÈàïÁöÑÈõôÊìäÊïàÊûú
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('answer-option')) {
                e.preventDefault();
            }
        });

        // Ê∑ªÂä†ÈúáÂãïÂèçÈ•ãÔºàÂ¶ÇÊûúË®≠ÂÇôÊîØÊåÅÔºâ
        function vibrate(pattern = [100]) {
            if ('vibrate' in navigator) {
                navigator.vibrate(pattern);
            }
        }

        // Âú®Á≠îÂ∞çÊàñÁ≠îÈåØÊôÇÊ∑ªÂä†ÈúáÂãïÂèçÈ•ã
        const originalCheckAnswer = checkAnswer;
        window.checkAnswer = function(side) {
            const result = originalCheckAnswer(side);
            
            // Ê†πÊìöÁµêÊûúÊèê‰æõ‰∏çÂêåÁöÑÈúáÂãïÂèçÈ•ã
            if (gameState.inputModes[side] === 'options') {
                const selectedIndex = gameState.selectedAnswers[side];
                const correctIndex = gameState.currentQuestions[side].correctIndex;
                
                if (selectedIndex === correctIndex) {
                    vibrate([100, 50, 100]); // Á≠îÂ∞çÔºöÁü≠ÈúáÂãïÂÖ©Ê¨°
                } else {
                    vibrate([200]); // Á≠îÈåØÔºöÈï∑ÈúáÂãï‰∏ÄÊ¨°
                }
            }
            
            return result;
        };

        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            addTouchFeedback();
            updateScores();
            disableInputs();
        });

        // Á¢∫‰øùÂú®ËºâÂÖ•ÂÆåÊàêÂæåÂàùÂßãÂåñ
        updateScores();
        disableInputs();
        addTouchFeedback();

        // ÈòªÊ≠¢È†ÅÈù¢ÊªæÂãïÂíåÁ∏ÆÊîæ
        document.addEventListener('touchmove', function(e) {
            e.preventDefault();
        }, { passive: false });

        // Ëû¢ÂπïÊñπÂêëÊîπËÆäÊôÇÁöÑËôïÁêÜ
        window.addEventListener('orientationchange', function() {
            setTimeout(function() {
                // ÈáçÊñ∞Ë™øÊï¥‰ΩàÂ±Ä
                document.body.style.height = window.innerHeight + 'px';
            }, 100);
        });

        // ÂÖ®Ëû¢ÂπïÊ®°ÂºèÊîØÊè¥
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(e => {
                    console.log('ÁÑ°Ê≥ïÈÄ≤ÂÖ•ÂÖ®Ëû¢ÂπïÊ®°Âºè');
                });
            } else {
                document.exitFullscreen();
            }
        }

        // ÈõôÊìäÈÄ≤ÂÖ•ÂÖ®Ëû¢ÂπïÔºàÂèØÈÅ∏ÂäüËÉΩÔºâ
        let clickCount = 0;
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('control-title')) {
                clickCount++;
                setTimeout(function() {
                    if (clickCount === 2) {
                        toggleFullscreen();
                    }
                    clickCount = 0;
                }, 300);
            }
        });
    </script>
</body>
</html>
