<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>函數大戰：最終修正版</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        :root {
            --red: #E52521; --green: #43B047; --blue: #5C94FC;
            --brown: #944200; --gold: #ffd700; --dark: #111;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Press Start 2P', cursive;
            margin: 0; padding: 0; background: #222; color: white;
            height: 100vh; overflow: hidden; display: flex; flex-direction: column;
        }

        /* === UI 元件 === */
        .btn { cursor: pointer; font-family: inherit; border: 2px solid #fff; transition: all 0.1s; }
        .btn:active { transform: translateY(3px); }
        
        /* === 1. 登入畫面 (預設顯示) === */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--blue); z-index: 1000; /* 最高層級 */
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        
        /* === 2. 等待與暫停畫面 (預設隱藏) === */
        #waiting-room, #paused-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--blue); z-index: 500;
            display: none; /* 修正：預設隱藏 */
            flex-direction: column; align-items: center; justify-content: center;
        }
        #paused-overlay { background: rgba(0,0,0,0.85); z-index: 600; }
        
        .login-card {
            background: rgba(0,0,0,0.8); padding: 30px; border-radius: 15px;
            text-align: center; width: 90%; max-width: 500px; border: 5px solid #fff;
        }
        input { width: 100%; padding: 15px; margin: 10px 0; font-family: inherit; text-align: center; font-size: 18px; }
        
        /* 角色切換 */
        .role-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { background: #555; border: 2px solid #fff; color: #fff; padding: 12px; flex: 1; cursor: pointer; }
        .tab-btn.active { background: var(--gold); color: #000; }

        /* 座號 */
        .seat-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-top: 15px; }
        .seat-btn { padding: 10px 0; font-size: 12px; cursor: pointer; background: var(--brown); color: white; border: 2px solid #fff; }
        .seat-btn.selected { background: var(--gold); color: #000; border-color: red; transform: scale(1.1); }
        .seat-btn.disabled { background: #555; color: #888; cursor: not-allowed; border-color: #555; pointer-events: none; }
        
        /* 遊戲區 */
        #game-interface { display: none; height: 100%; flex-direction: column; background: var(--blue); align-items: center; }
        .app-container { width: 100%; max-width: 800px; height: 100%; display: flex; flex-direction: column; border-left: 5px solid #000; border-right: 5px solid #000; background: var(--blue); }
        .hud { background: #000; padding: 10px 20px; display: flex; justify-content: space-between; font-size: 12px; }
        .q-box { background: var(--brown); border: 4px solid #000; margin: 10px; padding: 15px; text-align: center; font-size: 14px; color: #fff; }
        .main-canvas-area { flex-grow: 1; background: #fff; position: relative; margin: 0 10px; border: 4px solid #000; min-height: 200px; }
        canvas { width: 100%; height: 100%; display: block; }
        .controls { background: #000; padding: 15px; border-top: 4px solid #fff; }
        .numpad { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .btn-pad { background: #fff; padding: 20px 0; font-family: inherit; cursor: pointer; border: 4px solid #555; font-size: 18px; border-radius: 8px; }
        #input-display { background: #fff; color: #000; text-align: center; padding: 15px; margin-bottom: 10px; font-size: 24px; border: 4px solid var(--gold); }

        /* 結算區 */
        #analysis-room { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(20, 20, 20, 0.98); z-index: 700; display: none; flex-direction: column; padding: 20px; overflow-y: auto; align-items: center; }
        .analysis-container { width: 100%; max-width: 600px; background: #222; border: 2px solid #fff; margin-top: 20px; padding: 15px; text-align: left; }
        .analysis-item { border-bottom: 1px solid #555; padding: 10px 0; font-size: 12px; line-height: 1.6; color: #fff; }
        .tag-correct { color: var(--green); } .tag-wrong { color: var(--red); }

        /* 老師控制台 */
        #teacher-dashboard { display: none; height: 100%; flex-direction: column; background: #1a1a1a; }
        .dashboard-header { padding: 10px 20px; background: #000; display: flex; justify-content: space-between; align-items: center; border-bottom: 4px solid var(--gold); }
        .ctrl-group { display: flex; gap: 10px; }
        
        .btn-start { background: var(--green); color: white; padding: 10px 20px; }
        .btn-pause { background: #ff9800; color: white; padding: 10px 20px; }
        .btn-resume { background: #2196f3; color: white; padding: 10px 20px; }
        .btn-end { background: var(--red); color: white; padding: 10px 20px; }
        
        #view-screens { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; padding: 15px; overflow-y: auto; height: 100%; }
        .student-card { background: #333; border: 2px solid #555; padding: 5px; font-size: 10px; display: flex; flex-direction: column; aspect-ratio: 3/4; }
        .student-card.active { border-color: var(--green); }
        .mini-canvas { background: #fff; width: 100%; flex-grow: 1; margin-top: 5px; }

        @media (max-width: 1200px) { #view-screens { grid-template-columns: repeat(5, 1fr); } }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-card">
            <h1 style="color: var(--gold); margin-bottom: 30px;">MATH WAR ROOM</h1>
            <div class="role-tabs">
                <div class="tab-btn active" onclick="switchRole('student')">學生</div>
                <div class="tab-btn" onclick="switchRole('teacher')">老師</div>
            </div>
            
            <div id="form-student">
                <input type="text" id="s-code" placeholder="教室代碼" onkeyup="this.value = this.value.toUpperCase();">
                <input type="text" id="s-name" placeholder="你的暱稱" maxlength="8">
                <div class="seat-grid" id="seat-container"></div>
                <button class="btn" style="width:100%; margin-top:30px; background:var(--green); color:white; padding: 15px;" onclick="studentLogin()">準備戰鬥</button>
            </div>

            <div id="form-teacher" style="display:none;">
                <input type="text" id="t-code" placeholder="設定教室代碼" onkeyup="this.value = this.value.toUpperCase();">
                <input type="password" id="t-pass" placeholder="輸入密碼">
                <button class="btn" style="width:100%; margin-top:30px; background:var(--red); color:white; padding: 15px;" onclick="teacherLogin()">開啟戰情室</button>
            </div>
        </div>
    </div>

    <div id="waiting-room">
        <h1 style="font-size: 32px; color:var(--green);">READY?</h1>
        <p style="margin-top:15px; font-size:12px; color:#fff;">等待老師開始...</p>
    </div>

    <div id="paused-overlay">
        <h1 style="font-size: 32px; color: #ff9800; animation: blink 1s infinite;">PAUSED</h1>
        <p>老師講解中，請看大螢幕</p>
    </div>

    <div id="game-interface">
        <div class="app-container">
            <div class="hud">
                <span><span id="g-name">P</span> (#<span id="g-seat">?</span>)</span>
                <span>SCORE: <span id="g-score">0</span></span>
            </div>
            <div class="q-box" id="q-text">Loading...</div>
            <div class="main-canvas-area" id="s-canvas-wrap">
                <canvas id="s-canvas"></canvas>
                <div id="feedback" style="position:absolute; bottom:10px; left:10px; font-size:16px; font-weight:bold; color:black;"></div>
            </div>
            <div class="controls">
                <div id="input-display">?</div>
                <div class="numpad">
                    <button class="btn-pad" onclick="inputNum('1')">1</button>
                    <button class="btn-pad" onclick="inputNum('2')">2</button>
                    <button class="btn-pad" onclick="inputNum('3')">3</button>
                    <button class="btn-pad" onclick="inputNum('C')" style="background:#ddd;">C</button>
                    <button class="btn-pad" onclick="inputNum('4')">4</button>
                    <button class="btn-pad" onclick="inputNum('5')">5</button>
                    <button class="btn-pad" onclick="inputNum('6')">6</button>
                    <button class="btn-pad" onclick="inputNum('-')" style="background:var(--blue); color:#fff;">-</button>
                    <button class="btn-pad" onclick="inputNum('7')">7</button>
                    <button class="btn-pad" onclick="inputNum('8')">8</button>
                    <button class="btn-pad" onclick="inputNum('9')">9</button>
                    <button class="btn-pad" onclick="inputNum('0')">0</button>
                    <button class="btn-pad" onclick="submitAnswer()" style="grid-column: span 4; background: var(--red); color: white;">FIRE!</button>
                </div>
            </div>
        </div>
    </div>

    <div id="analysis-room">
        <h2 style="color:var(--green); font-size:24px;">MISSION COMPLETE</h2>
        <p>最終分數: <span id="final-score" style="color:var(--gold); font-size:32px;">0</span></p>
        <p>完成度: <span id="final-rate" style="color:var(--blue); font-size:20px;">0%</span></p>
        
        <div style="margin-top: 15px; border: 1px solid #555; padding: 10px; border-radius: 5px;">
            <p id="upload-status" style="font-size:12px; color:#aaa;">資料準備上傳...</p>
            <button class="btn" id="retry-btn" style="display:none; font-size:10px; padding:5px; margin-top:5px;" onclick="retryUpload()">重試上傳</button>
        </div>

        <div class="analysis-container" id="student-error-list"></div>
        <button class="btn" style="margin-top:30px; width:250px;" onclick="location.reload()">重新登入</button>
    </div>

    <div id="teacher-dashboard">
        <div class="dashboard-header">
            <div style="font-size: 14px;">ROOM: <span id="dash-code" style="color:var(--gold)">--</span></div>
            <div class="ctrl-group" id="t-controls">
                <button class="btn btn-start" onclick="sendSignal('START')">開始遊戲</button>
            </div>
        </div>
        <div id="view-screens"></div>
    </div>

<script>
    // ======================================================
    // 您的 Google Apps Script 網址 (請確認)
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyLHDpz-954-g7062_j-jkk6QNs30E4DDPx9iQxtwoHheZKBxZhRWfw8KXe224yX0yhAw/exec";
    // ======================================================

    // 
    const PASSWORD_HASH = "94cd2e23b72c91350a5170cfd037a342372c3d9050d26989439c2794776b9777";

    async function checkPassword(input) {
        const encoder = new TextEncoder();
        const data = encoder.encode(input);
        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        return hashHex === PASSWORD_HASH;
    }

    const MQTT_BROKER = 'wss://broker.hivemq.com:8884/mqtt';
    const TARGET_SCORE = 2000;

    let client = null, myRole = '', classCode = '', selectedSeat = null, maxSeats = 35;
    let playerData = { name: '', score: 0, currentInput: '', q: {}, lastLine: null, history: [] };
    let classState = {}, questionStats = {}, gameState = 'WAITING';

    // 初始化按鈕
    const seatContainer = document.getElementById('seat-container');
    for(let i=1; i<=35; i++){
        let b = document.createElement('div');
        b.className = 'seat-btn'; b.innerText = i;
        b.onclick = () => {
            document.querySelectorAll('.seat-btn').forEach(el=>el.classList.remove('selected'));
            b.classList.add('selected'); selectedSeat = i;
        }
        seatContainer.appendChild(b);
    }

    function switchRole(role) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById('form-student').style.display = role === 'student' ? 'block' : 'none';
        document.getElementById('form-teacher').style.display = role === 'teacher' ? 'block' : 'none';
    }

    // MQTT
    function connectMQTT(code, onConnect) {
        client = mqtt.connect(MQTT_BROKER);
        client.on('connect', onConnect);
        client.on('message', (topic, msg) => handleMessage(topic, msg.toString()));
    }

    function handleMessage(topic, payload) {
        const parts = topic.split('/'); const type = parts[2];
        
        if (myRole === 'student') {
            if (type === 'status') {
                if(payload === 'START') {
                    document.getElementById('waiting-room').style.display = 'none';
                    document.getElementById('paused-overlay').style.display = 'none';
                    document.getElementById('game-interface').style.display = 'flex';
                    if(playerData.history.length === 0) { resizeStudentCanvas(); newQuestion(); }
                } else if (payload === 'PAUSE') {
                    document.getElementById('paused-overlay').style.display = 'flex';
                } else if (payload === 'RESUME') {
                    document.getElementById('paused-overlay').style.display = 'none';
                } else if (payload === 'STOP') {
                    endGameForStudent();
                }
            }
        } else if (myRole === 'teacher') {
            if (type === 'data') updateTeacherScreen(parts[3], JSON.parse(payload));
        }
    }

    // 老師端
    async function teacherLogin() {
        const code = document.getElementById('t-code').value.trim().toUpperCase();
        const pass = document.getElementById('t-pass').value.trim();
        
        if (!code) return alert("請設定代碼");
        if (!await checkPassword(pass)) return alert("密碼錯誤");

        myRole = 'teacher'; classCode = code;
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('teacher-dashboard').style.display = 'flex';
        document.getElementById('dash-code').innerText = code;

        initMonitorGrid();
        connectMQTT(code, () => {
            client.subscribe(`game/${code}/data/+`);
        });
        updateControlButtons('WAITING');
    }

    function initMonitorGrid() {
        const screenDiv = document.getElementById('view-screens');
        screenDiv.innerHTML = "";
        for(let i=1; i<=maxSeats; i++){
            let card = document.createElement('div');
            card.className = 'student-card'; card.id = `card-${i}`;
            card.innerHTML = `<div style="display:flex;justify-content:space-between;"><span style="color:var(--gold)">#${i}</span><span id="name-${i}">...</span></div><div>SCR: <span id="score-${i}">0</span></div><canvas class="mini-canvas" id="mini-${i}"></canvas>`;
            screenDiv.appendChild(card);
        }
    }

    function updateTeacherScreen(id, data) {
        document.getElementById(`card-${id}`).classList.add('active');
        document.getElementById(`name-${id}`).innerText = data.name;
        document.getElementById(`score-${id}`).innerText = data.score;
        const cvs = document.getElementById(`mini-${id}`);
        if(cvs && cvs.width > 0) drawScene(cvs.getContext('2d'), cvs.width, cvs.height, data.q, data.input, null);
    }

    function sendSignal(sig) {
        client.publish(`game/${classCode}/status`, sig);
        if(sig === 'START') gameState = 'RUNNING';
        else if(sig === 'PAUSE') gameState = 'PAUSED';
        else if(sig === 'RESUME') gameState = 'RUNNING';
        else if(sig === 'STOP') gameState = 'ENDED';
        updateControlButtons(gameState);
    }

    function updateControlButtons(state) {
        const div = document.getElementById('t-controls'); div.innerHTML = '';
        if(state === 'WAITING') div.innerHTML = `<button class="btn btn-start" onclick="sendSignal('START')">開始遊戲</button>`;
        else if (state === 'RUNNING') div.innerHTML = `<button class="btn btn-pause" onclick="sendSignal('PAUSE')">暫停</button><button class="btn btn-end" onclick="confirmEnd()">強制結束</button>`;
        else if (state === 'PAUSED') div.innerHTML = `<button class="btn btn-resume" onclick="sendSignal('RESUME')">繼續</button><button class="btn btn-end" onclick="confirmEnd()">強制結束</button>`;
        else if (state === 'ENDED') div.innerHTML = `<button class="btn" style="background:#555">遊戲已結束</button>`;
    }
    function confirmEnd() { if(confirm("確定要結束並進行結算嗎？")) sendSignal('STOP'); }

    // 學生端
    function studentLogin() {
        const code = document.getElementById('s-code').value.trim().toUpperCase();
        const name = document.getElementById('s-name').value.trim();
        if(!code || !name || !selectedSeat) return alert("請填寫完整");
        myRole='student'; classCode=code; playerData.name=name;
        document.getElementById('login-screen').style.display='none';
        document.getElementById('waiting-room').style.display='flex';
        document.getElementById('g-name').innerText=name; document.getElementById('g-seat').innerText=selectedSeat;
        
        connectMQTT(code, ()=>{
            client.subscribe(`game/${code}/status`);
            setInterval(sendStudentData, 1000);
        });
    }

    function sendStudentData() {
        if(myRole!=='student'||!client) return;
        client.publish(`game/${classCode}/data/${selectedSeat}`, JSON.stringify({
            name:playerData.name, score:playerData.score, q:playerData.q, input:playerData.currentInput
        }));
    }

    function endGameForStudent() {
        document.getElementById('game-interface').style.display = 'none';
        document.getElementById('paused-overlay').style.display = 'none';
        document.getElementById('analysis-room').style.display = 'flex';
        
        const completion = Math.min((playerData.score / TARGET_SCORE) * 100, 100).toFixed(0);
        document.getElementById('final-score').innerText = playerData.score;
        document.getElementById('final-rate').innerText = completion + "%";

        const list = document.getElementById('student-error-list');
        const wrongs = playerData.history.filter(h => !h.isCorrect);
        list.innerHTML = "";
        
        if (wrongs.length === 0) list.innerHTML = "<div style='color:#4caf50;text-align:center'>全對！太棒了！</div>";
        else wrongs.forEach(w => list.innerHTML += `<div class="analysis-item"><div style="color:#aaa;">${w.qText}</div><div><span class="tag-wrong">答:${w.input}</span> <span class="tag-correct">正:${w.ans}</span></div></div>`);

        uploadToGoogle(completion, wrongs);
    }

    function retryUpload() {
        const completion = document.getElementById('final-rate').innerText.replace('%','');
        const wrongs = playerData.history.filter(h => !h.isCorrect);
        uploadToGoogle(completion, wrongs);
    }

    function uploadToGoogle(completion, wrongs) {
        const statusEl = document.getElementById('upload-status');
        const retryBtn = document.getElementById('retry-btn');
        statusEl.innerText = "正在上傳至雲端..."; statusEl.style.color = "#aaa"; retryBtn.style.display = "none";

        const mistakes = wrongs.map(h => ({ q: h.qText, input: h.input, ans: h.ans }));
        
        fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: playerData.name, seat: selectedSeat, score: playerData.score, completion: completion, mistakes: mistakes })
        }).then(() => {
            statusEl.innerText = "✅ 上傳成功！"; statusEl.style.color = "#4caf50";
        }).catch(err => {
            console.error(err); statusEl.innerText = "❌ 上傳失敗，請重試"; statusEl.style.color = "#ff5252"; retryBtn.style.display = "inline-block";
        });
    }

    function newQuestion() {
        const isC = Math.random() < 0.2;
        let s, b, x, qStr;
        if(isC) { s=0; b=Math.floor(Math.random()*9)-4; x=Math.floor(Math.random()*9)-4; qStr=`常數函數 y=${b}, x=${x}`; playerData.q={slope:0,b,x,ans:b}; } 
        else { s=Math.floor(Math.random()*5)-2||1; b=Math.floor(Math.random()*9)-4; x=Math.floor(Math.random()*9)-4; let sign = b>=0?'+':''; qStr=`y=${s}x${sign}${b}, x=${x}`; playerData.q={slope:s,b,x,ans:s*x+b}; }
        playerData.qStr = qStr;
        document.getElementById('q-text').innerHTML = `${qStr} <br> y = ?`;
        playerData.currentInput=""; document.getElementById('input-display').innerText="?";
        drawStudentScene();
    }

    function inputNum(v) {
        if(v==='C') playerData.currentInput=""; else if(playerData.currentInput.length<5) playerData.currentInput+=v;
        document.getElementById('input-display').innerText = playerData.currentInput||"?";
        drawStudentScene(); sendStudentData();
    }

    function submitAnswer() {
        let v = parseInt(playerData.currentInput); if(isNaN(v)) return;
        const isCorrect = (v===playerData.q.ans);
        playerData.history.push({ qText: playerData.qStr, ans: playerData.q.ans, input: v, isCorrect: isCorrect });

        if(isCorrect) { playerData.score+=100; playerData.lastLine={slope:playerData.q.slope,b:playerData.q.b,color:"green"}; document.getElementById('feedback').innerText="BINGO!"; document.getElementById('feedback').style.color="green"; setTimeout(newQuestion,1000); } 
        else { playerData.score=Math.max(0,playerData.score-50); playerData.lastLine={slope:playerData.q.slope,b:playerData.q.b,color:"red",errY:v}; document.getElementById('feedback').innerText="MISS!"; document.getElementById('feedback').style.color="red"; }
        document.getElementById('g-score').innerText = playerData.score;
        drawStudentScene(); sendStudentData();
    }

    function drawScene(ctx, w, h, q, input, lastLine) {
        const cx=w/2, cy=h/2, scale=w/18;
        ctx.clearRect(0,0,w,h);
        ctx.strokeStyle="#ccc"; ctx.lineWidth=1;
        ctx.beginPath(); ctx.moveTo(0,cy); ctx.lineTo(w,cy); ctx.stroke(); ctx.beginPath(); ctx.moveTo(cx,0); ctx.lineTo(cx,h); ctx.stroke();
        
        if(q && q.x !== undefined) {
            const tx=cx+q.x*scale, ty=cy-q.ans*scale;
            ctx.fillStyle="red"; ctx.beginPath(); ctx.arc(tx,ty,w/40,0,Math.PI*2); ctx.fill();
            if(input && !isNaN(input)) {
                let v = parseInt(input); let tb = v - q.slope*q.x;
                ctx.strokeStyle="blue"; ctx.lineWidth=1; ctx.setLineDash([4,2]);
                ctx.beginPath(); let x1=-10, y1=q.slope*x1+tb, x2=10, y2=q.slope*x2+tb;
                ctx.moveTo(cx+x1*scale, cy-y1*scale); ctx.lineTo(cx+x2*scale, cy-y2*scale); ctx.stroke(); ctx.setLineDash([]);
            }
        }
        if(lastLine) {
            ctx.strokeStyle=lastLine.color; ctx.lineWidth=3;
            ctx.beginPath(); let x1=-10, y1=lastLine.slope*x1+lastLine.b, x2=10, y2=lastLine.slope*x2+lastLine.b;
            ctx.moveTo(cx+x1*scale, cy-y1*scale); ctx.lineTo(cx+x2*scale, cy-y2*scale); ctx.stroke();
            if(lastLine.color==="red") { ctx.fillStyle="black"; ctx.beginPath(); ctx.arc(cx+q.x*scale, cy-lastLine.errY*scale, 4,0,Math.PI*2); ctx.fill(); }
        }
    }
    function drawStudentScene() { const cvs=document.getElementById('s-canvas'); drawScene(cvs.getContext('2d'),cvs.width,cvs.height,playerData.q,playerData.currentInput,playerData.lastLine); }
    function resizeStudentCanvas() { const w = document.getElementById('s-canvas-wrap'); const c = document.getElementById('s-canvas'); c.width=w.clientWidth; c.height=w.clientHeight; drawStudentScene(); }
    window.addEventListener('resize', resizeStudentCanvas);
    
    // Style for blink
    const style = document.createElement('style');
    style.innerHTML = `@keyframes blink { 50% { opacity: 0; } }`;
    document.head.appendChild(style);

</script>
</body>
</html>
