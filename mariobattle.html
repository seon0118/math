<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å‡½æ•¸å¤§å†’éšªï¼šé›²ç«¯é€£ç·šç‰ˆ</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        :root {
            --mario-red: #E52521;
            --luigi-green: #43B047;
            --sky-blue: #5C94FC;
            --brick-brown: #944200;
            --gold: #ffd700;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Press Start 2P', cursive;
            margin: 0; padding: 0;
            background-color: #333; color: white;
            display: flex; flex-direction: column; align-items: center;
            height: 100vh; overflow: hidden;
        }

        /* --- ç™»å…¥ä»‹é¢ --- */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--sky-blue); z-index: 200;
            display: flex; flex-direction: column; align-items: center; padding: 20px;
            overflow-y: auto;
        }
        .login-box {
            background: rgba(0,0,0,0.5); padding: 20px; border-radius: 10px;
            text-align: center; margin-bottom: 20px;
        }
        input {
            padding: 10px; font-family: 'Press Start 2P'; font-size: 14px;
            border: 3px solid #000; margin-bottom: 10px; width: 100%; max-width: 300px;
            text-transform: uppercase;
        }
        .room-grid {
            display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; 
            max-width: 500px; width: 100%; padding-bottom: 50px;
        }
        .room-btn {
            aspect-ratio: 1/1; background: var(--brick-brown); color: white;
            border: 3px solid #000; cursor: pointer; font-size: 10px;
            font-family: 'Press Start 2P'; border-radius: 5px;
        }
        .room-btn:hover { background: var(--luigi-green); transform: scale(1.05); }

        /* --- è€å¸«ç›£æ§ä»‹é¢ (F2) --- */
        #admin-panel {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 300;
            display: none; padding: 20px; overflow-y: auto;
        }
        .monitor-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px;
        }
        .monitor-card {
            border: 2px solid #555; padding: 10px; background: #222; font-size: 8px; line-height: 1.4;
            transition: all 0.3s;
        }
        .monitor-card.active { border-color: var(--gold); background: #5d4037; }
        .monitor-card.winner { border-color: #00ff00; background: #1b5e20; }

        /* --- éŠæˆ²ç•«é¢ --- */
        .app-container {
            width: 100%; max-width: 550px; height: 100%;
            display: flex; flex-direction: column; background: var(--sky-blue);
            border: 4px solid #000; position: relative;
        }
        .hud { background: #000; padding: 10px; display: flex; justify-content: space-between; font-size: 8px; }
        .hud span { color: var(--gold); }
        .conn-status { width: 10px; height: 10px; border-radius: 50%; background: red; display: inline-block;}
        .conn-ok { background: #00ff00; box-shadow: 0 0 5px #00ff00; }

        .question-box { 
            background: var(--brick-brown); border: 4px solid #000; 
            margin: 5px 10px; padding: 12px; text-align: center; font-size: 10px; line-height: 1.6;
        }
        .canvas-area { flex-grow: 1; background: #fff; position: relative; overflow: hidden; border: 4px solid #000; margin: 0 10px;}
        canvas { width: 100%; height: 100%; display: block; }

        /* --- æ§åˆ¶å€ --- */
        .controls { background: #000; padding: 10px; border-top: 4px solid #fff; }
        .num-pad { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; }
        .btn { 
            background: #fff; border: 3px solid #555; padding: 12px 0; 
            font-family: 'Press Start 2P'; font-size: 12px; cursor: pointer;
        }
        .btn:active { transform: translateY(2px); background: #ddd; }

        #input-view {
            background: #fff; color: #000; padding: 8px; margin-bottom: 8px;
            text-align: center; font-size: 20px; height: 40px; border: 3px solid var(--gold);
        }

        .admin-trigger { position: fixed; bottom: 5px; right: 5px; font-size: 8px; color: #666; cursor: pointer; z-index: 50; }
    </style>
</head>
<body>

    <div id="login-screen">
        <h1 style="font-size: 20px; color: #fff; text-shadow: 3px 3px 0 #000;">ONLINE BATTLE</h1>
        
        <div class="login-box">
            <p style="font-size: 10px; margin-bottom: 10px; color:#ffd700;">STEP 1: è¨­å®šæ•™å®¤ä»£ç¢¼</p>
            <input type="text" id="class-code-input" placeholder="ä¾‹å¦‚: MATH802" value="MATH101">
            <p style="font-size: 8px; color:#ccc;">(å…¨ç­éœ€è¼¸å…¥ç›¸åŒä»£ç¢¼)</p>
        </div>

        <div class="login-box">
            <p style="font-size: 10px; margin-bottom: 10px; color:#ffd700;">STEP 2: ä½ çš„è³‡æ–™</p>
            <input type="text" id="nickname-input" placeholder="ä½ çš„åå­—" maxlength="8">
            <p style="font-size: 10px; margin-bottom: 10px;">STEP 3: é¸æ“‡åº§è™Ÿ</p>
        </div>

        <div class="room-grid" id="room-btns"></div>
    </div>

    <div id="admin-panel">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h1 style="color: var(--gold); font-size: 16px;">CLASS MONITOR ( <span id="monitor-class-id"></span> )</h1>
            <button onclick="toggleAdmin()" style="padding: 5px;">CLOSE</button>
        </div>
        <p style="font-size: 8px; color:#ccc; margin-bottom:10px;">è³‡æ–™ç´„æœ‰ 1-2 ç§’å»¶é²ï¼Œè«‹ä¿æŒç¶²è·¯æš¢é€š</p>
        <div class="monitor-grid" id="monitor-content"></div>
    </div>

    <div class="app-container">
        <div class="hud">
            <div>
                NAME: <span id="p-name">?</span><br>
                ROOM: <span id="p-room">?</span>
            </div>
            <div style="text-align:center;">
                SCORE<br><span id="p-score">000000</span>
            </div>
            <div style="text-align:right;">
                TIME: <span id="p-timer">120</span><br>
                LINK: <span class="conn-status" id="conn-icon"></span>
            </div>
        </div>

        <div class="question-box" id="q-area">CONNECTING TO SERVER...</div>

        <div class="canvas-area" id="c-wrap">
            <canvas id="mainCanvas"></canvas>
            <div id="feedback" style="position:absolute; bottom:10px; left:10px; font-size:10px; color:#000; font-weight:bold; pointer-events:none;"></div>
        </div>

        <div class="controls">
            <div id="input-view">?</div>
            <div class="num-pad">
                <button class="btn" onclick="press('1')">1</button>
                <button class="btn" onclick="press('2')">2</button>
                <button class="btn" onclick="press('3')">3</button>
                <button class="btn" style="background:#ddd;" onclick="press('C')">C</button>
                <button class="btn" onclick="press('4')">4</button>
                <button class="btn" onclick="press('5')">5</button>
                <button class="btn" onclick="press('6')">6</button>
                <button class="btn" style="background:var(--sky-blue); color:white;" onclick="press('-')">-</button>
                <button class="btn" onclick="press('7')">7</button>
                <button class="btn" onclick="press('8')">8</button>
                <button class="btn" onclick="press('9')">9</button>
                <button class="btn" onclick="press('0')">0</button>
                <button class="btn" style="grid-column: span 4; background: var(--mario-red); color:white;" onclick="checkAnswer()">SHOOT! (Enter)</button>
            </div>
        </div>
    </div>

    <div class="admin-trigger" onclick="toggleAdmin()">Teacher Panel (F2)</div>

<script>
    // === éŠæˆ²è®Šæ•¸ ===
    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d');
    
    let user = {
        name: "", room: null, score: 0, timeLeft: 120,
        currentInput: "", classCode: "",
        q: { slope: 0, b: 0, x: 0, ans: 0 },
        lastLine: null
    };

    // ç›£æ§æ•¸æ“š (è€å¸«ç«¯ç”¨)
    let classData = {}; 

    // MQTT å®¢æˆ¶ç«¯
    let client; 
    const MQTT_BROKER = 'wss://broker.hivemq.com:8884/mqtt'; // å…¬é–‹çš„ WebSocket Broker

    // === åˆå§‹åŒ–æˆ¿è™ŸæŒ‰éˆ• ===
    const roomContainer = document.getElementById('room-btns');
    for(let i=1; i<=35; i++) {
        const btn = document.createElement('button');
        btn.className = 'room-btn';
        btn.innerText = i;
        btn.onclick = () => joinGame(i);
        roomContainer.appendChild(btn);
    }

    function joinGame(n) {
        const nick = document.getElementById('nickname-input').value.trim();
        const code = document.getElementById('class-code-input').value.trim();
        
        if(!nick) { alert("è«‹è¼¸å…¥åå­—ï¼"); return; }
        if(!code) { alert("è«‹è¼¸å…¥æ•™å®¤ä»£ç¢¼ï¼"); return; }
        
        user.name = nick;
        user.room = n;
        user.classCode = code.toUpperCase(); // çµ±ä¸€è½‰å¤§å¯«
        
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('p-name').innerText = nick;
        document.getElementById('p-room').innerText = n;
        document.getElementById('monitor-class-id').innerText = user.classCode;

        initNetwork();
        startGame();
    }

    // === ç¶²è·¯é€£ç·š (MQTT) ===
    function initNetwork() {
        const clientId = 'mario_student_' + Math.random().toString(16).substr(2, 8);
        console.log("Connecting to MQTT...");
        
        client = mqtt.connect(MQTT_BROKER);

        client.on('connect', function () {
            console.log("Connected!");
            document.getElementById('conn-icon').classList.add('conn-ok');
            
            // è¨‚é–±å…¨ç­çš„é »é“ (è€å¸«ç«¯éœ€è¦æ”¶è½ï¼Œå­¸ç”Ÿç«¯é›–ç„¶ä¸»è¦åªç™¼é€ï¼Œä½†è¨‚é–±å¯åšæ“´å……)
            // Topic çµæ§‹: game/mario_math/{classCode}/player/{roomID}
            const topic = `game/mario_math/${user.classCode}/player/+`;
            client.subscribe(topic);
        });

        client.on('message', function (topic, message) {
            // è§£ææ”¶åˆ°çš„è¨Šæ¯ (è€å¸«ç«¯ç›£æ§ç”¨)
            try {
                // topic ç¯„ä¾‹: game/mario_math/MATH101/player/5
                const parts = topic.split('/');
                const roomID = parts[parts.length - 1]; // å–å¾—æˆ¿è™Ÿ
                const data = JSON.parse(message.toString());
                
                // æ›´æ–°æœ¬åœ°çš„ç›£æ§è³‡æ–™
                classData[roomID] = data;
                classData[roomID].lastSeen = Date.now();

                // å¦‚æœç›£æ§é¢æ¿é–‹è‘—ï¼Œå°±åˆ·æ–°
                if(document.getElementById('admin-panel').style.display === 'block') {
                    renderMonitorCard(roomID);
                }

            } catch(e) { console.error(e); }
        });

        // æ¯ 2 ç§’å»£æ’­ä¸€æ¬¡è‡ªå·±çš„ç‹€æ…‹
        setInterval(broadcastStatus, 2000);
    }

    function broadcastStatus() {
        if(!client || !client.connected) return;
        const topic = `game/mario_math/${user.classCode}/player/${user.room}`;
        const payload = JSON.stringify({
            name: user.name,
            score: user.score,
            time: user.timeLeft
        });
        client.publish(topic, payload); // å‚³é€!
    }

    // === éŠæˆ²é‚è¼¯ ===

    function startGame() {
        newQuestion();
        setInterval(() => { 
            if(user.timeLeft > 0) user.timeLeft--; 
            document.getElementById('p-timer').innerText = user.timeLeft; 
        }, 1000);
        
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();
    }

    function newQuestion() {
        // å‡ºé¡Œé‚è¼¯ï¼šå¶çˆ¾å‡ºå¸¸æ•¸å‡½æ•¸
        const isConstant = Math.random() < 0.2;
        let slope, b, x;

        if (isConstant) {
            slope = 0;
            b = Math.floor(Math.random() * 9) - 4;
            x = Math.floor(Math.random() * 9) - 4;
            user.q = { slope, b, x, ans: b };
            document.getElementById('q-area').innerHTML = `å¸¸æ•¸å‡½æ•¸ y = ${b}<br>ç•¶ x = ${x} æ™‚ï¼Œy = ?`;
        } else {
            slope = Math.floor(Math.random() * 5) - 2 || 1; 
            b = Math.floor(Math.random() * 9) - 4;
            x = Math.floor(Math.random() * 9) - 4;
            user.q = { slope, b, x, ans: (slope * x + b) };
            let sign = b >= 0 ? "+" : "";
            document.getElementById('q-area').innerHTML = `ä¸€æ¬¡å‡½æ•¸ y = ${slope}x ${sign}${b}<br>ç•¶ x = ${x} æ™‚ï¼Œy = ?`;
        }
        user.currentInput = "";
        document.getElementById('input-view').innerText = "?";
        drawScene();
    }

    function press(v) {
        if(v === 'C') user.currentInput = "";
        else if(user.currentInput.length < 5) user.currentInput += v;
        document.getElementById('input-view').innerText = user.currentInput || "?";
    }

    function checkAnswer() {
        const val = parseInt(user.currentInput);
        if(isNaN(val)) return;

        if(val === user.q.ans) {
            user.score += 100;
            user.lastLine = { slope: user.q.slope, b: user.q.b, color: "#00c853", status: "HIT!" }; // Green
            showFeedback("BINGO!", "#00c853");
            broadcastStatus(); // ç­”å°ç«‹åˆ»å»£æ’­æ›´æ–°åˆ†æ•¸
            setTimeout(newQuestion, 1000);
        } else {
            user.score = Math.max(0, user.score - 50);
            user.lastLine = { slope: user.q.slope, b: user.q.b, color: "#d50000", status: "MISS!", errY: val }; // Red
            showFeedback(`WRONG! æ­£ç¢ºæ˜¯ ${user.q.ans}`, "#d50000");
        }
        document.getElementById('p-score').innerText = user.score.toString().padStart(6, '0');
        drawScene();
    }

    function showFeedback(txt, col) {
        const f = document.getElementById('feedback');
        f.innerText = txt; f.style.color = col;
    }

    // === ç¹ªåœ– ===
    
    function drawScene() {
        const w = canvas.width, h = canvas.height;
        const cx = w/2, cy = h/2, scale = w/18;
        ctx.clearRect(0, 0, w, h);
        
        // ç¶²æ ¼èˆ‡è»¸
        ctx.strokeStyle = "#eee"; ctx.lineWidth = 1;
        for(let i=-10; i<=10; i++) {
            ctx.beginPath(); ctx.moveTo(cx + i*scale, 0); ctx.lineTo(cx + i*scale, h); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(0, cy + i*scale); ctx.lineTo(w, cy + i*scale); ctx.stroke();
        }
        ctx.strokeStyle = "#999"; ctx.lineWidth = 2;
        ctx.beginPath(); ctx.moveTo(0, cy); ctx.lineTo(w, cy); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(cx, 0); ctx.lineTo(cx, h); ctx.stroke();

        // ç›®æ¨™é»
        const tx = cx + user.q.x * scale;
        const ty = cy - user.q.ans * scale;
        ctx.fillStyle = "red"; ctx.beginPath(); ctx.arc(tx, ty, 6, 0, Math.PI*2); ctx.fill();

        // å‡½æ•¸ç·š
        if(user.lastLine) {
            ctx.strokeStyle = user.lastLine.color; ctx.lineWidth = 3;
            ctx.beginPath();
            const x1 = -10, y1 = user.lastLine.slope * x1 + user.lastLine.b;
            const x2 = 10, y2 = user.lastLine.slope * x2 + user.lastLine.b;
            ctx.moveTo(cx + x1*scale, cy - y1*scale);
            ctx.lineTo(cx + x2*scale, cy - y2*scale);
            ctx.stroke();
            
            // æ¨™ç¤ºéŒ¯èª¤é»
            if(user.lastLine.color === "#d50000") {
                ctx.fillStyle = "black";
                ctx.beginPath(); ctx.arc(tx, cy - user.lastLine.errY*scale, 4, 0, Math.PI*2); ctx.fill();
            }
        }
    }

    // === è€å¸«ç«¯ç›£æ§ä»‹é¢é‚è¼¯ ===
    function toggleAdmin() {
        const p = document.getElementById('admin-panel');
        p.style.display = (p.style.display === 'block') ? 'none' : 'block';
        if(p.style.display === 'block') initMonitorGrid();
    }

    function initMonitorGrid() {
        const container = document.getElementById('monitor-content');
        container.innerHTML = "";
        for(let i=1; i<=35; i++) {
            const div = document.createElement('div');
            div.id = `card-${i}`;
            div.className = 'monitor-card';
            div.innerHTML = `<span style="color:#666">#${i} WAITING...</span>`;
            container.appendChild(div);
            // å¦‚æœå·²ç¶“æœ‰è³‡æ–™ï¼Œç«‹åˆ»æ¸²æŸ“
            if(classData[i]) renderMonitorCard(i);
        }
    }

    function renderMonitorCard(id) {
        const card = document.getElementById(`card-${id}`);
        if(!card) return; // ä»‹é¢å¯èƒ½é‚„æ²’é–‹

        const data = classData[id];
        const isOnline = (Date.now() - data.lastSeen < 10000); // 10ç§’å…§æœ‰è¨Šè™Ÿç®—åœ¨ç·š
        
        card.className = `monitor-card ${isOnline ? 'active' : ''}`;
        if(data.score >= 1000) card.classList.add('winner'); // ç°¡å–®çš„é«˜åˆ†ç‰¹æ•ˆ

        card.innerHTML = `
            <span style="color:var(--gold)">#${id}</span> <b>${data.name}</b><br>
            SCORE: <span style="color:${isOnline?'#fff':'#666'}">${data.score}</span><br>
            TIME: ${data.time} <span style="font-size:8px">${isOnline?'ğŸŸ¢':'ğŸ”´'}</span>
        `;
    }

    function resizeCanvas() {
        const wrap = document.getElementById('c-wrap');
        canvas.width = wrap.clientWidth;
        canvas.height = wrap.clientHeight;
        drawScene();
    }

    window.addEventListener('keydown', (e) => { 
        if(e.key === 'F2') toggleAdmin(); 
        if(e.key === 'Enter') checkAnswer();
    });

</script>
</body>
</html>
