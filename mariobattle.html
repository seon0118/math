<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>函數堡壘：老師遠端監控版</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --mario-red: #E52521; --luigi-green: #43B047; --sky-blue: #5C94FC;
            --brick-brown: #944200; --gold: #ffd700;
        }
        * { box-sizing: border-box; }
        body {
            font-family: 'Press Start 2P', cursive; margin: 0; background: #333; color: white;
            display: flex; flex-direction: column; align-items: center; height: 100vh; overflow: hidden;
        }

        /* --- 老師監控介面升級 --- */
        #admin-panel {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 300; display: none; padding: 20px;
        }
        .admin-layout { display: flex; gap: 20px; height: 85%; }
        .monitor-grid {
            flex: 1; display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
            gap: 8px; overflow-y: auto; padding-right: 10px;
        }
        .monitor-card {
            border: 2px solid #555; padding: 8px; background: #222; font-size: 7px; cursor: pointer;
        }
        .monitor-card.active { border-color: var(--luigi-green); background: #1a331a; }
        .monitor-card.selected { border-color: var(--gold); box-shadow: 0 0 10px var(--gold); }

        /* 學生畫面預覽區 */
        .student-preview {
            width: 300px; background: #444; border: 4px solid var(--gold);
            display: flex; flex-direction: column; padding: 10px;
        }
        .preview-canvas-wrap { width: 100%; aspect-ratio: 4/3; background: #fff; margin-top: 10px; }
        #previewCanvas { width: 100%; height: 100%; }

        /* --- 遊戲介面 --- */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--sky-blue); z-index: 200; display: flex; flex-direction: column; align-items: center; padding: 20px;
        }
        .room-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; width: 100%; max-width: 400px; }
        .room-btn { aspect-ratio: 1/1; background: var(--brick-brown); color: #fff; border: 3px solid #000; font-size: 10px; font-family: 'Press Start 2P'; cursor: pointer; }
        
        .app-container { width: 100%; max-width: 500px; height: 100%; display: flex; flex-direction: column; background: var(--sky-blue); border: 4px solid #000; }
        .hud { background: #000; padding: 10px; display: flex; justify-content: space-between; font-size: 8px; }
        .question-box { background: var(--brick-brown); border: 4px solid #000; margin: 5px; padding: 10px; text-align: center; font-size: 9px; }
        .canvas-area { flex-grow: 1; background: #fff; position: relative; margin: 0 5px; border: 2px solid #000; }
        canvas { width: 100%; height: 100%; display: block; }
        .controls { background: #000; padding: 10px; border-top: 4px solid #fff; }
        .num-pad { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; }
        .btn { background: #fff; border: 2px solid #555; padding: 12px 0; font-family: 'Press Start 2P'; font-size: 10px; cursor: pointer; }
        #input-view { background: #fff; color: #000; padding: 5px; margin-bottom: 5px; text-align: center; font-size: 18px; border: 3px solid var(--gold); }
    </style>
</head>
<body>

    <div id="login-screen">
        <h2 style="font-size:16px;">STUDENT LOGIN</h2>
        <input type="text" id="nick-in" placeholder="NAME" maxlength="8" style="padding:10px; margin-bottom:15px; font-family:'Press Start 2P';">
        <div class="room-grid" id="room-btns"></div>
    </div>

    <div id="admin-panel">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 style="color:var(--gold); font-size:14px;">TEACHER MONITORING</h2>
            <button onclick="toggleAdmin()" style="font-family:'Press Start 2P'; padding:5px;">CLOSE</button>
        </div>
        <div class="admin-layout">
            <div class="monitor-grid" id="monitor-content"></div>
            <div class="student-preview">
                <div style="font-size:10px; color:var(--gold); border-bottom:1px solid #666; padding-bottom:5px;">LIVE PREVIEW</div>
                <div id="preview-info" style="font-size:8px; margin-top:10px; line-height:1.5;">請點擊左側房號查看學生畫面</div>
                <div class="preview-canvas-wrap">
                    <canvas id="previewCanvas"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="app-container">
        <div class="hud">
            <div>NAME:<span id="p-name">?</span> RM:<span id="p-room">?</span></div>
            <div>SCORE:<br><span id="p-score">000000</span></div>
            <div>TIME:<br><span id="p-timer">120</span></div>
        </div>
        <div class="question-box" id="q-area">LOADING...</div>
        <div class="canvas-area" id="c-wrap">
            <canvas id="mainCanvas"></canvas>
        </div>
        <div class="controls">
            <div id="input-view">?</div>
            <div class="num-pad">
                <button class="btn" onclick="press('1')">1</button><button class="btn" onclick="press('2')">2</button><button class="btn" onclick="press('3')">3</button><button class="btn" onclick="press('C')">C</button>
                <button class="btn" onclick="press('4')">4</button><button class="btn" onclick="press('5')">5</button><button class="btn" onclick="press('6')">6</button><button class="btn" onclick="press('-')">-</button>
                <button class="btn" onclick="press('7')">7</button><button class="btn" onclick="press('8')">8</button><button class="btn" onclick="press('9')">9</button><button class="btn" onclick="press('0')">0</button>
                <button class="btn" style="grid-column:span 4; background:var(--mario-red); color:#fff;" onclick="checkAnswer()">FIRE!</button>
            </div>
        </div>
    </div>

<script>
    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d');
    const preCanvas = document.getElementById('previewCanvas');
    const preCtx = preCanvas.getContext('2d');

    let user = { name: "", room: null, score: 0, timeLeft: 120, currentInput: "", q: { slope: 0, b: 0, x: 0, ans: 0 }, lastLine: null };
    let selectedStudentRoom = null;

    // 初始化房間按鈕
    const roomContainer = document.getElementById('room-btns');
    for(let i=1; i<=35; i++) {
        const btn = document.createElement('button');
        btn.className = 'room-btn'; btn.innerText = i;
        btn.onclick = () => {
            const nick = document.getElementById('nick-in').value.trim();
            if(!nick) return alert("請輸入姓名！");
            user.name = nick; user.room = i;
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('p-name').innerText = nick;
            document.getElementById('p-room').innerText = i;
            startGame();
        };
        roomContainer.appendChild(btn);
    }

    function startGame() {
        newQuestion();
        setInterval(tick, 1000);
        setInterval(syncData, 1500); // 縮短同步時間，讓畫面更即時
        window.addEventListener('resize', () => { resize(canvas); });
        resize(canvas);
    }

    function tick() { if(user.timeLeft > 0) user.timeLeft--; document.getElementById('p-timer').innerText = user.timeLeft; }

    function newQuestion() {
        const slope = Math.floor(Math.random() * 5) - 2 || 1;
        const b = Math.floor(Math.random() * 9) - 4;
        const x = Math.floor(Math.random() * 9) - 4;
        user.q = { slope, b, x, ans: (slope * x + b) };
        user.currentInput = "";
        document.getElementById('input-view').innerText = "?";
        document.getElementById('q-area').innerHTML = `y = ${slope}x + (${b})<br>當 x = ${x} 時, y = ?`;
        draw(ctx, canvas, user);
    }

    function press(v) {
        if(v === 'C') user.currentInput = "";
        else if(user.currentInput.length < 5) user.currentInput += v;
        document.getElementById('input-view').innerText = user.currentInput || "?";
    }

    function checkAnswer() {
        const val = parseInt(user.currentInput);
        if(isNaN(val)) return;
        if(val === user.q.ans) {
            user.score += 100;
            user.lastLine = { slope: user.q.slope, b: user.q.b, color: "green" };
            setTimeout(newQuestion, 1200);
        } else {
            user.score = Math.max(0, user.score - 50);
            user.lastLine = { slope: user.q.slope, b: user.q.b, color: "red", errY: val, errX: user.q.x };
        }
        document.getElementById('p-score').innerText = user.score.toString().padStart(6, '0');
        draw(ctx, canvas, user);
    }

    function draw(targetCtx, targetCanvas, data) {
        const w = targetCanvas.width, h = targetCanvas.height;
        const cx = w/2, cy = h/2, scale = w/18;
        targetCtx.clearRect(0,0,w,h);
        // 座標軸
        targetCtx.strokeStyle = "#ccc"; targetCtx.beginPath();
        targetCtx.moveTo(0,cy); targetCtx.lineTo(w,cy); targetCtx.moveTo(cx,0); targetCtx.lineTo(cx,h); targetCtx.stroke();
        // 目標點
        targetCtx.fillStyle = "red"; targetCtx.beginPath();
        targetCtx.arc(cx + data.q.x*scale, cy - data.q.ans*scale, 5, 0, Math.PI*2); targetCtx.fill();
        // 函數線
        if(data.lastLine) {
            targetCtx.strokeStyle = data.lastLine.color; targetCtx.lineWidth = 3;
            targetCtx.beginPath();
            const x1 = -10, y1 = data.lastLine.slope * x1 + data.lastLine.b;
            const x2 = 10, y2 = data.lastLine.slope * x2 + data.lastLine.b;
            targetCtx.moveTo(cx + x1*scale, cy - y1*scale); targetCtx.lineTo(cx + x2*scale, cy - y2*scale);
            targetCtx.stroke();
        }
    }

    // --- 監控同步邏輯 ---
    function syncData() {
        let server = JSON.parse(localStorage.getItem('mario_monitor_v2') || "{}");
        server[user.room] = { ...user, active: Date.now() };
        localStorage.setItem('mario_monitor_v2', JSON.stringify(server));
    }

    function toggleAdmin() {
        const p = document.getElementById('admin-panel');
        p.style.display = (p.style.display === 'block') ? 'none' : 'block';
        if(p.style.display === 'block') { refreshMonitor(); resize(preCanvas); }
    }

    function refreshMonitor() {
        const container = document.getElementById('monitor-content');
        container.innerHTML = "";
        let server = JSON.parse(localStorage.getItem('mario_monitor_v2') || "{}");
        for(let i=1; i<=35; i++) {
            const d = server[i];
            const online = d && (Date.now() - d.active < 10000);
            const card = document.createElement('div');
            card.className = `monitor-card ${online ? 'active' : ''} ${selectedStudentRoom == i ? 'selected' : ''}`;
            card.innerHTML = `RM${i} ${d?d.name:'--'}<br>SCORE:${d?d.score:0}`;
            card.onclick = () => { selectedStudentRoom = i; };
            container.appendChild(card);
        }
        if(selectedStudentRoom) {
            const d = server[selectedStudentRoom];
            if(d) {
                document.getElementById('preview-info').innerHTML = `學生: ${d.name}<br>題目: y = ${d.q.slope}x + ${d.q.b}<br>當前分數: ${d.score}`;
                draw(preCtx, preCanvas, d);
            }
        }
        if(document.getElementById('admin-panel').style.display === 'block') setTimeout(refreshMonitor, 1000);
    }

    function resize(c) {
        c.width = c.parentElement.clientWidth;
        c.height = c.parentElement.clientHeight;
        if(c === canvas) draw(ctx, canvas, user);
    }

    window.addEventListener('keydown', (e) => { if(e.key === 'F2') toggleAdmin(); });
</script>
</body>
</html>
