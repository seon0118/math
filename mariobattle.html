<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å‡½æ•¸å¤§æˆ°ï¼šæˆ°æƒ…ä¸­å¿ƒç‰ˆ</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        :root {
            --red: #E52521; --green: #43B047; --blue: #5C94FC;
            --brown: #944200; --gold: #ffd700; --dark: #111;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Press Start 2P', cursive;
            margin: 0; padding: 0; background: #222; color: white;
            height: 100vh; overflow: hidden; display: flex; flex-direction: column;
        }

        /* === ç™»å…¥å€ === */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--blue); z-index: 500;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .login-card {
            background: rgba(0,0,0,0.8); padding: 20px; border-radius: 10px;
            text-align: center; width: 90%; max-width: 400px;
            border: 4px solid #fff; box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        }
        input {
            width: 100%; padding: 12px; margin: 8px 0;
            font-family: inherit; text-align: center; font-size: 14px;
        }
        .role-tabs { display: flex; gap: 10px; margin-bottom: 20px; justify-content: center; }
        .tab-btn {
            background: #555; border: 2px solid #fff; color: #fff; padding: 10px; cursor: pointer; flex: 1;
        }
        .tab-btn.active { background: var(--gold); color: #000; }
        
        /* åº§è™Ÿé¸æ“‡ */
        .seat-grid {
            display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 10px;
        }
        .seat-btn {
            padding: 8px 0; font-size: 10px; cursor: pointer; background: var(--brown); color: white; border: 1px solid #fff;
        }
        .seat-btn:hover { background: var(--green); }
        .seat-btn.selected { background: var(--gold); color: #000; transform: scale(1.1); border-color: red;}
        .seat-btn.disabled { background: #555; color: #888; cursor: not-allowed; border-color: #555; pointer-events: none; }

        /* === å­¸ç”ŸéŠæˆ²ä»‹é¢ === */
        #waiting-room {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 400;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; color: var(--gold);
        }
        #game-interface { display: none; height: 100%; flex-direction: column; background: var(--blue); }
        .hud { background: #000; padding: 5px 10px; display: flex; justify-content: space-between; font-size: 10px; }
        .q-box { background: var(--brown); border: 2px solid #000; margin: 5px; padding: 10px; text-align: center; font-size: 10px; }
        .main-canvas-area { flex-grow: 1; background: #fff; position: relative; margin: 0 5px; border: 2px solid #000;}
        canvas { width: 100%; height: 100%; display: block; }
        .controls { background: #000; padding: 10px; }
        .numpad { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; }
        .btn { background: #fff; padding: 15px 0; font-family: inherit; cursor: pointer; border: 3px solid #555; }
        .btn:active { transform: translateY(2px); background: #ccc; }
        #input-display { background: #fff; color: #000; text-align: center; padding: 10px; margin-bottom: 5px; font-size: 20px; }

        /* === è€å¸«æˆ°æƒ…å®¤ === */
        #teacher-dashboard {
            display: none; height: 100%; flex-direction: column; background: #1a1a1a;
        }
        .dashboard-header {
            padding: 15px; background: #000; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 3px solid var(--gold);
        }
        .view-switch { display: flex; gap: 10px; }
        .view-btn { padding: 8px 15px; font-family: inherit; cursor: pointer; border: 2px solid #555; background: #333; color: #fff; }
        .view-btn.active { border-color: var(--gold); background: #555; }

        /* æ¨¡å¼ A: å³æ™‚ç•«é¢ */
        #view-screens { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; 
            padding: 10px; overflow-y: auto; height: 100%;
        }
        .student-card {
            background: #333; border: 2px solid #555; padding: 5px; font-size: 10px;
            display: flex; flex-direction: column; height: 130px;
        }
        .student-card.active { border-color: var(--green); box-shadow: 0 0 5px var(--green); }
        .mini-canvas { background: #fff; width: 100%; flex-grow: 1; margin-top: 5px; border: 1px solid #999; }

        /* æ¨¡å¼ B: æˆ°æ³æ’è¡Œæ¦œ */
        #view-leaderboard {
            display: none; flex-direction: column; padding: 20px; overflow-y: auto; height: 100%;
        }
        .leader-row {
            display: flex; align-items: center; margin-bottom: 8px; 
            background: #333; padding: 10px; border-radius: 5px; transition: top 0.5s;
        }
        .rank-num { font-size: 20px; color: var(--gold); width: 50px; text-align: center;}
        .rank-bar-container { flex-grow: 1; margin: 0 20px; height: 20px; background: #000; border-radius: 10px; overflow: hidden; }
        .rank-bar { height: 100%; background: var(--green); width: 0%; transition: width 1s; }
        .rank-name { width: 100px; text-align: right; font-size: 12px; white-space: nowrap; overflow: hidden; }
        .rank-score { width: 80px; text-align: right; color: var(--gold); font-size: 14px; }

        /* è€å¸«æ§åˆ¶æŒ‰éˆ• */
        .start-btn {
            background: var(--red); color: white; font-family: inherit; padding: 10px 20px;
            font-size: 14px; cursor: pointer; border: 2px solid #fff; animation: pulse 1.5s infinite;
        }
        .start-btn:disabled { background: #555; animation: none; cursor: not-allowed; opacity: 0.7;}
        
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-card">
            <h1 style="font-size: 18px; color: var(--gold); margin-bottom: 20px;">MATH BATTLE ROOM</h1>
            
            <div class="role-tabs">
                <div class="tab-btn active" onclick="switchRole('student')">å­¸ç”Ÿ Student</div>
                <div class="tab-btn" onclick="switchRole('teacher')">è€å¸« Teacher</div>
            </div>

            <div id="form-student">
                <input type="text" id="s-code" placeholder="æ•™å®¤ä»£ç¢¼" onkeyup="this.value = this.value.toUpperCase();">
                <input type="text" id="s-name" placeholder="ä½ çš„æš±ç¨±" maxlength="8">
                <p style="font-size: 10px; margin-top:15px; color:#ccc;">é¸æ“‡ä½ çš„åº§è™Ÿ:</p>
                <div class="seat-grid" id="seat-container"></div>
                <button class="btn" style="width:100%; margin-top:20px; background:var(--green); color:white; border-color:white;" onclick="studentLogin()">åŠ å…¥æˆ°å±€</button>
            </div>

            <div id="form-teacher" style="display:none;">
                <input type="text" id="t-code" placeholder="è¨­å®šæ•™å®¤ä»£ç¢¼" onkeyup="this.value = this.value.toUpperCase();">
                <input type="password" id="t-pass" placeholder="è¼¸å…¥æ•™å¸«å¯†ç¢¼">
                <div style="display:flex; align-items:center; justify-content:center; margin-top:10px;">
                    <label style="font-size:10px; margin-right:10px;">äººæ•¸ä¸Šé™:</label>
                    <input type="number" id="t-limit" value="35" min="1" max="35" style="width:60px;">
                </div>
                <button class="btn" style="width:100%; margin-top:20px; background:var(--red); color:white; border-color:white;" onclick="teacherLogin()">é–‹è¨­æˆ¿é–“</button>
            </div>
        </div>
    </div>

    <div id="waiting-room">
        <h1 style="font-size: 24px; color:var(--green);">READY?</h1>
        <p style="margin-top:10px;">ç­‰å¾…è€å¸«é–‹å§‹...</p>
        <p id="wait-info" style="font-size: 10px; margin-top: 30px; color: #aaa;"></p>
    </div>

    <div id="game-interface">
        <div class="hud">
            <span><span id="g-name">Player</span> (#<span id="g-seat">?</span>)</span>
            <span>SCORE: <span id="g-score">0</span></span>
        </div>
        <div class="q-box" id="q-text">é¡Œç›®è¼‰å…¥ä¸­...</div>
        <div class="main-canvas-area" id="s-canvas-wrap">
            <canvas id="s-canvas"></canvas>
            <div id="feedback" style="position:absolute; bottom:5px; left:5px; font-size:12px; font-weight:bold; color:black;"></div>
        </div>
        <div class="controls">
            <div id="input-display">?</div>
            <div class="numpad">
                <button class="btn" onclick="inputNum('1')">1</button>
                <button class="btn" onclick="inputNum('2')">2</button>
                <button class="btn" onclick="inputNum('3')">3</button>
                <button class="btn" onclick="inputNum('C')" style="background:#ddd;">C</button>
                <button class="btn" onclick="inputNum('4')">4</button>
                <button class="btn" onclick="inputNum('5')">5</button>
                <button class="btn" onclick="inputNum('6')">6</button>
                <button class="btn" onclick="inputNum('-')" style="background:var(--blue); color:#fff;">-</button>
                <button class="btn" onclick="inputNum('7')">7</button>
                <button class="btn" onclick="inputNum('8')">8</button>
                <button class="btn" onclick="inputNum('9')">9</button>
                <button class="btn" onclick="inputNum('0')">0</button>
                <button class="btn" onclick="submitAnswer()" style="grid-column: span 4; background: var(--red); color: white;">FIRE!</button>
            </div>
        </div>
    </div>

    <div id="teacher-dashboard">
        <div class="dashboard-header">
            <div style="font-size: 12px;">
                CODE: <span id="dash-code" style="color:var(--gold)">---</span> | 
                <span id="dash-online">0</span> ONLINE
            </div>
            <div class="view-switch">
                <div class="view-btn active" id="btn-view-screens" onclick="switchView('screens')">ğŸ“º ç›£æ§</div>
                <div class="view-btn" id="btn-view-leaderboard" onclick="switchView('leaderboard')">ğŸ† æˆ°æ³</div>
            </div>
            <button id="start-btn" class="start-btn" onclick="broadcastStart()">START GAME</button>
        </div>
        
        <div id="view-screens"></div>
        
        <div id="view-leaderboard"></div>
    </div>

<script>
    // === è¨­å®šèˆ‡è®Šæ•¸ ===
    const MQTT_BROKER = 'wss://broker.hivemq.com:8884/mqtt';
    let client = null;
    let myRole = ''; 
    let classCode = '';
    let selectedSeat = null;
    let maxSeats = 35; // é è¨­

    // å­¸ç”Ÿç«¯ç‹€æ…‹
    let playerData = { name: '', score: 0, currentInput: '', q: {}, lastLine: null };
    
    // è€å¸«ç«¯ç‹€æ…‹
    let classState = {}; 
    let currentView = 'screens';

    // === åˆå§‹åŒ–åº§è™ŸæŒ‰éˆ• (35å€‹) ===
    const seatContainer = document.getElementById('seat-container');
    for(let i=1; i<=35; i++){
        let b = document.createElement('div');
        b.id = `seat-btn-${i}`;
        b.className = 'seat-btn';
        b.innerText = i;
        b.onclick = () => {
            if(b.classList.contains('disabled')) return;
            document.querySelectorAll('.seat-btn').forEach(el=>el.classList.remove('selected'));
            b.classList.add('selected');
            selectedSeat = i;
        }
        seatContainer.appendChild(b);
    }

    function switchRole(role) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById('form-student').style.display = role === 'student' ? 'block' : 'none';
        document.getElementById('form-teacher').style.display = role === 'teacher' ? 'block' : 'none';
    }

    // === MQTT é€£ç·š ===
    function connectMQTT(code, onConnect) {
        const clientId = 'mario_' + Math.random().toString(16).substr(2, 8);
        client = mqtt.connect(MQTT_BROKER);
        client.on('connect', () => { onConnect(); });
        client.on('message', (topic, msg) => { handleMessage(topic, msg.toString()); });
    }

    function handleMessage(topic, payload) {
        const parts = topic.split('/'); // game/{code}/{type}/{id?}
        const type = parts[2]; 
        
        if (myRole === 'student') {
            if (type === 'config') {
                // æ”¶åˆ°è€å¸«çš„è¨­å®š (äººæ•¸ä¸Šé™)
                const config = JSON.parse(payload);
                updateSeatLimit(config.maxSeats);
            }
            if (type === 'status') {
                if (payload === 'START') {
                    document.getElementById('waiting-room').style.display = 'none';
                    document.getElementById('game-interface').style.display = 'flex';
                    resizeStudentCanvas();
                    newQuestion();
                }
            }
        } 
        else if (myRole === 'teacher') {
            if (type === 'data') {
                const seatId = parts[3];
                const data = JSON.parse(payload);
                updateClassState(seatId, data);
            }
        }
    }

    // === è€å¸«ç«¯åŠŸèƒ½ ===
    function teacherLogin() {
        const code = document.getElementById('t-code').value.trim().toUpperCase();
        const pass = document.getElementById('t-pass').value.trim();
        const limit = parseInt(document.getElementById('t-limit').value);
        
        if (!code) return alert("è«‹è¨­å®šä»£ç¢¼");
        // *** å¯†ç¢¼æª¢æŸ¥é‚è¼¯ ***
        if (pass !== "8888") return alert("å¯†ç¢¼éŒ¯èª¤ (é è¨­: 8888)");

        myRole = 'teacher';
        classCode = code;
        maxSeats = limit;
        
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('teacher-dashboard').style.display = 'flex';
        document.getElementById('dash-code').innerText = code;

        // åˆå§‹åŒ–ç›£æ§ç•«é¢
        initMonitorGrid();
        
        connectMQTT(code, () => {
            client.subscribe(`game/${code}/data/+`);
            // å»£æ’­é…ç½®
            setInterval(() => {
                client.publish(`game/${code}/config`, JSON.stringify({ maxSeats: maxSeats }));
            }, 2000);
        });
    }

    function initMonitorGrid() {
        const screenDiv = document.getElementById('view-screens');
        const leaderDiv = document.getElementById('view-leaderboard');
        screenDiv.innerHTML = "";
        leaderDiv.innerHTML = "";

        for(let i=1; i<=maxSeats; i++){
            // 1. å»ºç«‹å°ç•«é¢å¡ç‰‡
            let card = document.createElement('div');
            card.className = 'student-card';
            card.id = `card-${i}`;
            card.innerHTML = `
                <div style="display:flex; justify-content:space-between;">
                    <span style="color:var(--gold)">#${i}</span> 
                    <span id="name-${i}">...</span>
                </div>
                <div>åˆ†: <span id="score-${i}">0</span></div>
                <canvas class="mini-canvas" id="mini-${i}"></canvas>
            `;
            screenDiv.appendChild(card);

            // 2. å»ºç«‹æ’è¡Œæ¦œåˆ—
            let row = document.createElement('div');
            row.className = 'leader-row';
            row.id = `rank-row-${i}`;
            row.style.display = 'none'; // æœ‰è³‡æ–™æ‰é¡¯ç¤º
            row.innerHTML = `
                <div class="rank-num" id="rank-pos-${i}">-</div>
                <div style="font-size:10px; color:#ccc;">#${i}</div>
                <div class="rank-name" id="rank-name-${i}">Player</div>
                <div class="rank-bar-container">
                    <div class="rank-bar" id="rank-bar-${i}"></div>
                </div>
                <div class="rank-score" id="rank-score-${i}">0</div>
            `;
            leaderDiv.appendChild(row);
        }
    }

    function updateClassState(id, data) {
        if(id > maxSeats) return; // å¿½ç•¥è¶…å‡ºåº§è™Ÿçš„è³‡æ–™
        classState[id] = data;
        classState[id].lastUpdate = Date.now();

        // æ›´æ–° UI
        if(currentView === 'screens') updateScreenView(id, data);
        updateLeaderboard(); // æ¯æ¬¡æ•¸æ“šé€²ä¾†éƒ½é‡ç®—æ’å
        updateOnlineCount();
    }

    function updateScreenView(id, data) {
        document.getElementById(`card-${id}`).classList.add('active');
        document.getElementById(`name-${id}`).innerText = data.name;
        document.getElementById(`score-${id}`).innerText = data.score;
        
        // ç¹ªè£½å°åœ–
        const cvs = document.getElementById(`mini-${id}`);
        if(cvs && cvs.offsetParent !== null) { // åªæœ‰é¡¯ç¤ºæ™‚æ‰ç•«
            if(cvs.width !== cvs.clientWidth) { cvs.width = cvs.clientWidth; cvs.height = cvs.clientHeight; }
            drawMiniScene(cvs, data);
        }
    }

    function updateLeaderboard() {
        // å°‡ classState è½‰ç‚ºé™£åˆ—ä¸¦æ’åº
        let players = [];
        for(let id in classState) {
            players.push({id: id, ...classState[id]});
        }
        players.sort((a,b) => b.score - a.score);

        // æ‰¾å‡ºæœ€é«˜åˆ†åšæ¯”ä¾‹å°º
        const maxScore = players.length > 0 ? Math.max(players[0].score, 100) : 100;

        players.forEach((p, index) => {
            const row = document.getElementById(`rank-row-${p.id}`);
            if(row) {
                row.style.display = 'flex';
                row.style.order = index; // Flexbox order æ’åº
                document.getElementById(`rank-pos-${p.id}`).innerText = index + 1;
                document.getElementById(`rank-name-${p.id}`).innerText = p.name;
                document.getElementById(`rank-score-${p.id}`).innerText = p.score;
                
                const percent = Math.min((p.score / maxScore) * 100, 100);
                document.getElementById(`rank-bar-${p.id}`).style.width = percent + "%";
            }
        });
    }

    function switchView(mode) {
        currentView = mode;
        document.getElementById('view-screens').style.display = mode === 'screens' ? 'grid' : 'none';
        document.getElementById('view-leaderboard').style.display = mode === 'leaderboard' ? 'flex' : 'none';
        
        document.getElementById('btn-view-screens').classList.toggle('active', mode === 'screens');
        document.getElementById('btn-view-leaderboard').classList.toggle('active', mode === 'leaderboard');
    }

    function broadcastStart() {
        if(!client) return;
        client.publish(`game/${classCode}/status`, 'START');
        document.getElementById('start-btn').innerText = "éŠæˆ²é€²è¡Œä¸­";
        document.getElementById('start-btn').disabled = true;
    }

    function updateOnlineCount() {
        const now = Date.now();
        let count = 0;
        for(let k in classState) {
            if(now - classState[k].lastUpdate < 8000) count++;
            else document.getElementById(`card-${k}`).classList.remove('active');
        }
        document.getElementById('dash-online').innerText = count;
    }

    // === å­¸ç”Ÿç«¯é‚è¼¯ ===
    function studentLogin() {
        const code = document.getElementById('s-code').value.trim().toUpperCase();
        const name = document.getElementById('s-name').value.trim();
        
        if (!code || !name || !selectedSeat) return alert("è«‹å®Œæ•´å¡«å¯«");

        myRole = 'student';
        classCode = code;
        playerData.name = name;

        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('waiting-room').style.display = 'flex';
        document.getElementById('wait-info').innerText = `${name} | åº§è™Ÿ ${selectedSeat} | ${code}`;
        document.getElementById('g-name').innerText = name;
        document.getElementById('g-seat').innerText = selectedSeat;

        connectMQTT(code, () => {
            client.subscribe(`game/${code}/status`);
            client.subscribe(`game/${code}/config`); // è½å–äººæ•¸è¨­å®š
            setInterval(sendStudentData, 1000); 
        });
    }

    function updateSeatLimit(limit) {
        // æ ¹æ“šè€å¸«è¨­å®šï¼ŒæŠŠè¶…éçš„åº§è™ŸæŒ‰éˆ•è®Šç°
        for(let i=1; i<=35; i++) {
            const btn = document.getElementById(`seat-btn-${i}`);
            if(i > limit) btn.classList.add('disabled');
            else btn.classList.remove('disabled');
        }
    }

    function sendStudentData() {
        if(myRole !== 'student' || !client) return;
        const topic = `game/${classCode}/data/${selectedSeat}`;
        const payload = JSON.stringify({
            name: playerData.name,
            score: playerData.score,
            q: playerData.q, 
            input: playerData.currentInput
        });
        client.publish(topic, payload);
    }

    // === éŠæˆ²é‚è¼¯ (èˆ‡ä¹‹å‰ç›¸åŒ) ===
    function newQuestion() {
        const slope = Math.floor(Math.random() * 5) - 2 || 1; 
        const b = Math.floor(Math.random() * 9) - 4;
        const x = Math.floor(Math.random() * 9) - 4;
        playerData.q = { slope, b, x, ans: (slope * x + b) };
        playerData.currentInput = "";
        let sign = b >= 0 ? "+" : "";
        document.getElementById('q-text').innerHTML = `å‡½æ•¸ y = ${slope}x ${sign}${b}ï¼Œç•¶ x = ${x}ï¼Œy = ?`;
        document.getElementById('input-display').innerText = "?";
        drawStudentScene();
    }

    function inputNum(v) {
        if(v === 'C') playerData.currentInput = "";
        else if(playerData.currentInput.length < 5) playerData.currentInput += v;
        document.getElementById('input-display').innerText = playerData.currentInput || "?";
        drawStudentScene();
        sendStudentData(); 
    }

    function submitAnswer() {
        const val = parseInt(playerData.currentInput);
        if(isNaN(val)) return;
        if(val === playerData.q.ans) {
            playerData.score += 100;
            playerData.lastLine = { slope: playerData.q.slope, b: playerData.q.b, color: "green" };
            showFeedback("BINGO!", "green");
            setTimeout(newQuestion, 1000);
        } else {
            playerData.score = Math.max(0, playerData.score - 50);
            playerData.lastLine = { slope: playerData.q.slope, b: playerData.q.b, color: "red", errY: val };
            showFeedback("MISS!", "red");
        }
        document.getElementById('g-score').innerText = playerData.score;
        drawStudentScene();
        sendStudentData();
    }

    function showFeedback(txt, col) {
        const f = document.getElementById('feedback');
        f.innerText = txt; f.style.color = col;
    }

    // ç¹ªåœ–å‡½æ•¸ (å­¸ç”Ÿç«¯å¤§åœ– & è€å¸«ç«¯å°åœ–å…±ç”¨é‚è¼¯)
    function drawScene(ctx, w, h, q, input, lastLine) {
        const cx = w/2, cy = h/2, scale = w/18;
        ctx.clearRect(0, 0, w, h);
        
        ctx.strokeStyle = "#ccc"; ctx.lineWidth = 1;
        ctx.beginPath(); ctx.moveTo(0, cy); ctx.lineTo(w, cy); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(cx, 0); ctx.lineTo(cx, h); ctx.stroke();

        if(q && q.x !== undefined) {
            const tx = cx + q.x * scale;
            const ty = cy - q.ans * scale;
            ctx.fillStyle = "red"; ctx.beginPath(); ctx.arc(tx, ty, w/40, 0, Math.PI*2); ctx.fill();

            // ç•«å‡ºå­¸ç”Ÿæ­£åœ¨è¼¸å…¥çš„å³æ™‚è»Œè·¡ (è—è‰²é è¦½)
            if(input && !isNaN(input)) {
                let val = parseInt(input);
                ctx.strokeStyle = "blue"; ctx.lineWidth = 1;
                ctx.setLineDash([2, 2]);
                ctx.beginPath(); 
                // é€†æ¨ä¸€å€‹å‡æƒ³çš„ b ä¾†ç•«é€šéè©²é»çš„å¹³è¡Œç·š
                let tempB = val - q.slope * q.x;
                let x1=-10, y1=q.slope*x1+tempB;
                let x2=10, y2=q.slope*x2+tempB;
                ctx.moveTo(cx+x1*scale, cy-y1*scale); ctx.lineTo(cx+x2*scale, cy-y2*scale);
                ctx.stroke();
                ctx.setLineDash([]);
            }
        }

        if(lastLine) {
            ctx.strokeStyle = lastLine.color; ctx.lineWidth = 2;
            ctx.beginPath();
            let x1=-10, y1=lastLine.slope*x1+lastLine.b;
            let x2=10, y2=lastLine.slope*x2+lastLine.b;
            ctx.moveTo(cx+x1*scale, cy-y1*scale); ctx.lineTo(cx+x2*scale, cy-y2*scale);
            ctx.stroke();
        }
    }

    function drawStudentScene() {
        const cvs = document.getElementById('s-canvas');
        drawScene(cvs.getContext('2d'), cvs.width, cvs.height, playerData.q, playerData.currentInput, playerData.lastLine);
    }

    function drawMiniScene(cvs, d) {
        drawScene(cvs.getContext('2d'), cvs.width, cvs.height, d.q, d.input, null); // è€å¸«ç«¯æš«ä¸é¡¯ç¤ºä¸Šä¸€é¡Œçµæœï¼Œåªé¡¯ç¤ºç•¶å‰å‹•æ…‹
    }

    function resizeStudentCanvas() {
        const wrap = document.getElementById('s-canvas-wrap');
        const cvs = document.getElementById('s-canvas');
        cvs.width = wrap.clientWidth; cvs.height = wrap.clientHeight;
        drawStudentScene();
    }
    
    // å¿«æ·éµ
    window.addEventListener('keydown', (e) => { 
        if(e.key === 'F2') { 
            const p = document.getElementById('admin-panel');
            if(p.style.display==='block') p.style.display='none'; 
        } 
    });

</script>
</body>
</html>
