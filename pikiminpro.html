<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>çš®å…‹æ•å¤§æœæŸ¥ï¼šæ•¸å­¸æ¢éšª</title>
    <link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        :root {
            /* === çš®å…‹æ•å…¨å®¶æ—é…è‰² === */
            --red: #ea4e3d;    /* ç´… (ç«) */
            --blue: #4da6ff;   /* è— (æ°´) */
            --yellow: #f2d636; /* é»ƒ (é›») */
            --purple: #8e44ad; /* ç´« (å¤§åŠ›å£« - ç”¨æ–¼æ¦œå–®) */
            --pink: #e91e63;   /* ç²‰ (ç¾½ç¿… - ç”¨æ–¼ç™¼é€) */
            --grey: #7f8c8d;   /* ç° (å²©çŸ³ - ç”¨æ–¼éµç›¤) */
            --white: #ecf0f1;  /* ç™½ (é€Ÿåº¦ - ç”¨æ–¼è¼¸å…¥) */
            
            --green: #76c043;  /* è‰åœ°ç¶  */
            --dark: #2c3e50;
            --bg-gradient: linear-gradient(135deg, #a8e063 0%, #56ab2f 100%);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Varela Round', sans-serif;
            margin: 0; padding: 0; 
            background: var(--bg-gradient); 
            color: var(--dark);
            height: 100vh; overflow: hidden; display: flex; flex-direction: column;
        }

        /* === å…±ç”¨å…ƒä»¶ === */
        .btn { 
            cursor: pointer; font-family: inherit; border: none; 
            transition: all 0.1s; border-radius: 20px; font-weight: bold; 
            box-shadow: 0 4px 0 rgba(0,0,0,0.2);
        }
        .btn:active { transform: translateY(3px); box-shadow: 0 1px 0 rgba(0,0,0,0.2); }
        
        /* ç™»å…¥èˆ‡ç­‰å¾… */
        #login-screen, #waiting-room, #paused-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-gradient); z-index: 1000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        #waiting-room, #paused-overlay { display: none; z-index: 500; background: rgba(0,0,0,0.9); color: #fff; }
        
        .login-card {
            background: rgba(255,255,255,0.95); padding: 30px; border-radius: 30px;
            text-align: center; width: 90%; max-width: 450px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); border: 5px solid #fff;
        }
        input { 
            width: 100%; padding: 12px; margin: 10px 0; font-family: inherit; 
            text-align: center; font-size: 18px; text-transform: uppercase; 
            border: 2px solid #ddd; border-radius: 12px; background: #fff;
        }
        
        .role-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { 
            background: #eee; border: none; color: #888; padding: 10px; flex: 1; 
            cursor: pointer; border-radius: 15px; font-weight: bold;
        }
        .tab-btn.active { background: var(--green); color: #fff; transform: scale(1.05); }

        .seat-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-top: 15px; }
        .seat-btn { 
            padding: 10px 0; font-size: 12px; cursor: pointer; 
            background: #fff; color: var(--dark); border: 2px solid #ddd; border-radius: 50%;
            aspect-ratio: 1/1; display: flex; align-items: center; justify-content: center;
        }
        .seat-btn.selected { background: var(--purple); color: #fff; border-color: #fff; transform: scale(1.1); font-weight: bold;}
        .seat-btn.disabled { background: #ddd; color: #aaa; cursor: not-allowed; pointer-events: none; }
        
        /* ç‹€æ…‹ç‡ˆ */
        .status-dot { width: 15px; height: 15px; border-radius: 50%; background: #ff6b6b; margin: 10px auto; border: 2px solid #fff; }
        .status-connected { background: #51cf66; box-shadow: 0 0 10px #51cf66; }

        /* éŠæˆ²å€ */
        #game-interface { display: none; height: 100%; flex-direction: column; background: #e0f7fa; align-items: center; }
        .app-container { width: 100%; max-width: 800px; height: 100%; display: flex; flex-direction: column; background: #fff; }
        
        /* HUDï¼šä½¿ç”¨ç´«çš®å…‹æ•é…è‰² */
        .hud { 
            background: var(--purple); padding: 10px 20px; display: flex; 
            justify-content: space-between; font-size: 16px; align-items: center; color: white; font-weight: bold;
            border-bottom: 4px solid #6c3483;
        }
        .q-box { 
            background: #fff8e1; border: 3px solid var(--yellow); border-radius: 15px;
            margin: 10px; padding: 15px; text-align: center; font-size: 18px; color: var(--dark); font-weight: bold;
        }
        .main-canvas-area { flex-grow: 1; background: #fff; position: relative; margin: 0 10px; border: 2px solid #eee; border-radius: 10px; min-height: 200px; overflow: hidden;}
        canvas { width: 100%; height: 100%; display: block; }
        
        .controls { background: #ecf0f1; padding: 15px; border-radius: 20px 20px 0 0; }
        .numpad { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        
        /* æ•¸å­—éµç›¤ï¼šå²©çŸ³çš®å…‹æ•é¢¨æ ¼ (ç°è‰²) */
        .btn-pad { 
            background: #fff; padding: 15px 0; font-family: inherit; cursor: pointer; 
            border: none; border-bottom: 4px solid var(--grey); font-size: 20px; border-radius: 12px; color: var(--dark);
        }
        .btn-pad:active { transform: translateY(4px); border-bottom: 0; margin-bottom: 4px; }
        
        /* ç™¼å°„æŒ‰éˆ•ï¼šç¾½ç¿…çš®å…‹æ•é¢¨æ ¼ (ç²‰ç´…) */
        .btn-submit {
            grid-column: span 4; background: var(--pink); color: white; 
            border-bottom: 4px solid #c2185b;
        }

        #input-display { 
            background: #fff; color: var(--dark); text-align: center; padding: 10px; 
            margin-bottom: 10px; font-size: 24px; border: 3px solid var(--blue); border-radius: 10px; 
        }

        /* çµç®—å€ */
        #analysis-room { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.98); z-index: 700; display: none; flex-direction: column; padding: 20px; overflow-y: auto; align-items: center; }
        .analysis-container { width: 100%; max-width: 600px; background: #fff; border: 2px solid #eee; border-radius: 15px; margin-top: 20px; padding: 15px; text-align: left; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .analysis-item { border-bottom: 1px solid #eee; padding: 10px 0; font-size: 14px; line-height: 1.6; color: #555; }
        .tag-correct { color: var(--green); font-weight: bold; } .tag-wrong { color: var(--red); font-weight: bold; }

        /* === è€å¸«æˆ°æƒ…å®¤ (éšŠé•·é¢æ¿) === */
        #teacher-dashboard { display: none; height: 100%; flex-direction: column; background: #f0f4f8; }
        
        .dashboard-header { 
            background: #fff; border-bottom: 4px solid #ddd; padding: 10px 20px;
            display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; gap: 10px;
        }
        
        .header-left { justify-self: start; display: flex; align-items: center; gap: 15px; }
        .room-info { font-size: 18px; color: var(--dark); font-weight: bold; background: #eee; padding: 5px 10px; border-radius: 8px;}
        .view-switch { display: flex; gap: 5px; }
        .view-btn { padding: 8px 12px; border: 2px solid transparent; background: #e0e0e0; color: #666; font-size: 14px; cursor: pointer; border-radius: 8px; transition: 0.3s;}
        .view-btn.active { background: var(--purple); color: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        .header-center { justify-self: center; text-align: center; }
        .timer-input-group { display: flex; align-items: center; gap: 5px; font-size: 14px; color: #666; background: #f9f9f9; padding: 5px 15px; border-radius: 20px; border:1px solid #ddd;}
        .timer-input { width: 50px; padding: 5px; font-size: 16px; text-align: center; background: #fff; border: 1px solid #ccc; border-radius: 5px; margin: 0;}
        .live-timer { font-size: 48px; color: var(--red); font-weight: 800; font-family: monospace; letter-spacing: -2px; display: none;}

        .header-right { justify-self: end; }
        .btn-ctrl { padding: 10px 20px; font-size: 16px; color: white; cursor: pointer; display: none; border-radius: 30px;}
        .btn-start { background: var(--green); display: block; box-shadow: 0 4px 0 #5aa02c; } 
        .btn-pause { background: var(--yellow); color: #555; box-shadow: 0 4px 0 #d4b616;}
        .btn-resume { background: var(--blue); box-shadow: 0 4px 0 #2a70b8;}
        .btn-end { background: var(--red); box-shadow: 0 4px 0 #c0392b;}
        
        /* ç›£æ§ç‰†ï¼šåŠ å…¥å½©è‰²é‚Šæ¡†é‚è¼¯ */
        #view-screens { display: flex; height: 100%; overflow: hidden; padding: 15px; gap: 15px; }
        .monitor-wall { 
            flex: 3; display: grid; grid-template-columns: repeat(4, 1fr); 
            gap: 12px; overflow-y: auto; align-content: start; 
        }
        .student-card { 
            background: #fff; border: 3px solid #eee; padding: 8px; border-radius: 12px;
            display: flex; flex-direction: column; aspect-ratio: 1/1; transition: 0.3s;
        }
        .student-card.active { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        
        .mini-hud { color: var(--dark); font-size: 18px; margin-bottom: 5px; font-weight: bold; display: flex; justify-content: space-between;}
        .mini-canvas { background: #fafafa; width: 100%; flex-grow: 1; display: block; border-radius: 8px;}
        .mini-input-preview { background: #eee; color: #555; text-align: center; font-size: 14px; margin-top: 4px; border-radius: 4px; height: 20px;}

        /* æ’è¡Œæ¦œï¼šç´«çš®å…‹æ•é¢¨æ ¼ (é‡é‡ç´š) */
        .leaderboard-sidebar { 
            flex: 1; min-width: 280px;
            background: #fff; border-radius: 15px; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.05); border: 2px solid var(--purple);
        }
        .lb-title { text-align: center; color: var(--purple); border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 15px; font-size: 22px; font-weight: 800;}
        .lb-row { 
            display: flex; align-items: center; margin-bottom: 10px; background: #f8f9fa; padding: 12px; 
            font-size: 18px; border-radius: 10px; 
        }
        .lb-bar-bg { flex-grow: 1; height: 12px; background: #eee; margin: 0 10px; border-radius: 10px; overflow: hidden;}
        .lb-bar { height: 100%; background: linear-gradient(90deg, var(--purple), #be93d4); width: 0%; border-radius: 10px; transition: width 0.5s; }

        /* å°æ±ºæ¨¡å¼ */
        #view-versus { display: none; height: 100%; padding: 20px; background: #f0f4f8; }
        .versus-container { display: flex; height: 100%; align-items: center; justify-content: center; gap: 40px;}
        .vs-card { width: 45%; height: 90%; background: #fff; border-radius: 20px; display: flex; flex-direction: column; padding: 20px; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 5px solid #eee;}
        .vs-card.p1 { border-color: var(--red); }
        .vs-card.p2 { border-color: var(--blue); }
        .hp-bar { height: 100%; width: 0%; transition: width 0.5s; }
        .vs-canvas { flex-grow: 1; background: #fafafa; width: 100%; border-radius: 10px; }

        /* æª¢è¨æ¨¡å¼ */
        #view-review { display: none; height: 100%; flex-direction: column; padding: 20px; overflow-y: auto; background: #f0f4f8; }
        .error-card { background: #fff; border-left: 8px solid var(--grey); padding: 20px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; color: #444; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);}
        .bar-fill { height: 100%; background: var(--grey); border-radius: 5px; }

        @media (max-width: 1400px) { .monitor-wall { grid-template-columns: repeat(3, 1fr); } }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-card">
            <h1 style="color: var(--green); margin-bottom: 20px;">ğŸŒ± çš®å…‹æ•æ•¸å­¸æ¢éšª</h1>
            <div class="role-tabs">
                <div class="tab-btn active" onclick="switchRole('student')">çš®å…‹æ•éšŠå“¡ (å­¸ç”Ÿ)</div>
                <div class="tab-btn" onclick="switchRole('teacher')">æ­åŠ›é¦¬éšŠé•· (è€å¸«)</div>
            </div>
            
            <div id="form-student">
                <input type="text" id="s-code" placeholder="è¼¸å…¥æ¢éšªä»£ç¢¼" oninput="this.value = this.value.toUpperCase();">
                <input type="text" id="s-name" placeholder="ä½ çš„åå­—" maxlength="8">
                <p style="color:#888; font-size:12px; margin-top:10px;">é¸æ“‡ç·¨è™Ÿï¼š</p>
                <div class="seat-grid" id="seat-container"></div>
                <button class="btn" style="width:100%; margin-top:30px; background:var(--blue); color:white; padding: 15px; font-size: 18px;" onclick="studentLogin()">åŠ å…¥æ¢éšªéšŠ</button>
            </div>

            <div id="form-teacher" style="display:none;">
                <input type="text" id="t-code" placeholder="è¨­å®šæ¢éšªä»£ç¢¼" oninput="this.value = this.value.toUpperCase();">
                <input type="password" id="t-pass" placeholder="éšŠé•·å¯†ç¢¼ (0118)">
                <div style="display:flex; align-items:center; justify-content:center; margin-top:20px; font-size:16px;">
                    <label style="margin-right:10px; color:#666;">éšŠä¼äººæ•¸:</label>
                    <input type="number" id="t-limit" value="35" min="1" max="35" style="width:80px; padding:5px; font-size:16px;">
                </div>
                <button class="btn" id="t-login-btn" style="width:100%; margin-top:30px; background:var(--red); color:white; padding: 15px; font-size: 18px;" onclick="teacherLogin()">é–‹å•ŸæŒ‡æ®ä¸­å¿ƒ</button>
            </div>
        </div>
    </div>

    <div id="waiting-room">
        <h1 style="font-size: 32px; color:var(--yellow);">ğŸŒ± æº–å‚™ç™¼èŠ½</h1>
        <p style="margin-top:15px; font-size:18px;">ç­‰å¾…éšŠé•·å¹å“¨...</p>
        <div id="s-status-dot" class="status-dot"></div>
        <p id="s-status-text" style="font-size:12px; color:#ccc;">æ­£åœ¨é€£çµæ¯è‰¦...</p>
    </div>

    <div id="paused-overlay">
        <h1 style="font-size: 40px; color: var(--yellow);">â¸ï¸ é›†åˆä¸€ä¸‹</h1>
        <p style="font-size: 20px;">è½éšŠé•·è¬›è§£</p>
    </div>

    <div id="game-interface">
        <div class="app-container">
            <div class="hud">
                <span>ğŸŒ± <span id="g-name">P</span> (#<span id="g-seat">?</span>)</span>
                <span id="g-timer" style="background:#fff; color:var(--red); padding:2px 8px; border-radius:10px;">05:00</span>
                <span>ğŸŒ¸ <span id="g-score">0</span></span>
            </div>
            <div class="q-box" id="q-text">Loading...</div>
            <div class="main-canvas-area" id="s-canvas-wrap">
                <canvas id="s-canvas"></canvas>
                <div id="feedback" style="position:absolute; bottom:10px; left:10px; font-size:24px; font-weight:bold; color:black; text-shadow: 2px 2px 0 #fff;"></div>
            </div>
            <div class="controls">
                <div id="input-display">?</div>
                <div class="numpad">
                    <button class="btn-pad" onclick="inputNum('1')">1</button><button class="btn-pad" onclick="inputNum('2')">2</button><button class="btn-pad" onclick="inputNum('3')">3</button><button class="btn-pad" onclick="inputNum('C')" style="background:#e0e0e0; color:var(--red);">C</button>
                    <button class="btn-pad" onclick="inputNum('4')">4</button><button class="btn-pad" onclick="inputNum('5')">5</button><button class="btn-pad" onclick="inputNum('6')">6</button><button class="btn-pad" onclick="inputNum('-')" style="background:#e0e0e0;color:var(--blue);"><b>-</b></button>
                    <button class="btn-pad" onclick="inputNum('7')">7</button><button class="btn-pad" onclick="inputNum('8')">8</button><button class="btn-pad" onclick="inputNum('9')">9</button><button class="btn-pad" onclick="inputNum('0')">0</button>
                    <button class="btn-pad btn-submit" onclick="submitAnswer()">ğŸŒ¸ ç™¼å°„!</button>
                </div>
            </div>
        </div>
    </div>

    <div id="analysis-room">
        <h2 style="color:var(--green); font-size:28px;">ğŸŒ¸ æ¢éšªå®Œæˆ!</h2>
        <p style="color:#666;">æ¡é›†èŠ±æœµ: <span id="final-score" style="color:var(--red); font-size:32px; font-weight:bold;">0</span></p>
        <p style="color:#666;">å®Œæˆåº¦: <span id="final-rate" style="color:var(--blue); font-size:20px; font-weight:bold;">0%</span></p>
        <div style="margin-top: 15px; border: 1px solid #eee; padding: 15px; border-radius: 10px; background:#fafafa; width:100%; max-width:400px;">
            <p id="upload-status" style="font-size:14px; color:#888;">ğŸ“¦ è³‡æ–™å‚³é€å›æ¯è‰¦ä¸­...</p>
            <button class="btn" id="retry-btn" style="display:none; font-size:12px; padding:8px; margin-top:5px; background:var(--dark); color:#fff;" onclick="retryUpload()">é‡è©¦å‚³é€</button>
        </div>
        <div class="analysis-container" id="student-error-list"></div>
        <button class="btn" style="margin-top:30px; width:200px; background:var(--blue); color:#fff; padding:12px;" onclick="location.reload()">å†æ¬¡æ¢éšª</button>
    </div>

    <div id="teacher-dashboard">
        <div class="dashboard-header">
            <div class="header-left">
                <div class="room-info">ä»£ç¢¼: <span id="dash-code" style="color:var(--blue)">--</span></div>
                <div class="view-switch">
                    <div class="view-btn active" id="btn-screens" onclick="switchView('screens')">å…¨æ™¯</div>
                    <div class="view-btn" id="btn-versus" onclick="switchView('versus')">å°æ±º</div>
                    <div class="view-btn" id="btn-review" onclick="switchView('review')">æª¢è¨</div>
                </div>
            </div>
            
            <div class="header-center">
                <div class="timer-input-group" id="t-timer-setup">
                    â³ å€’æ•¸: <input type="number" id="t-input-min" class="timer-input" value="5"> åˆ†
                </div>
                <div class="live-timer" id="t-live-timer">05:00</div>
            </div>

            <div class="header-right">
                <button id="btn-c-start" class="btn btn-ctrl btn-start" onclick="sendSignal('START')">ğŸš© å‡ºç™¼!</button>
                <div id="running-controls" style="display:none; gap:10px;">
                    <button id="btn-c-pause" class="btn btn-ctrl btn-pause" onclick="sendSignal('PAUSE')">â¸ï¸ æš«åœ</button>
                    <button id="btn-c-resume" class="btn btn-ctrl btn-resume" style="display:none;" onclick="sendSignal('RESUME')">â–¶ï¸ ç¹¼çºŒ</button>
                    <button id="btn-c-end" class="btn btn-ctrl btn-end" onclick="confirmEnd()">ğŸ çµæŸ</button>
                </div>
            </div>
        </div>
        
        <div id="view-screens">
            <div class="monitor-wall" id="monitor-wall"></div>
            <div class="leaderboard-sidebar">
                <div class="lb-title">ğŸ† æ¡é›†æ’è¡Œæ¦œ</div>
                <div id="lb-content"></div>
            </div>
        </div>
        
        <div id="view-versus">
            <div class="versus-container">
                <div class="vs-card p1"><div class="vs-header"><select id="sel-p1" class="vs-selector" onchange="updateVersusSelection()"></select></div><div class="hp-container"><div class="hp-bar" id="hp-p1" style="background:linear-gradient(90deg,#ff9999,var(--red))"></div><div class="hp-text"><span id="score-p1">0</span> ğŸŒ¸</div></div><canvas class="vs-canvas" id="canvas-p1"></canvas></div>
                <div class="vs-center" style="font-size:60px; color:var(--dark);">VS</div>
                <div class="vs-card p2"><div class="vs-header"><select id="sel-p2" class="vs-selector" onchange="updateVersusSelection()"></select></div><div class="hp-container"><div class="hp-bar" id="hp-p2" style="background:linear-gradient(90deg,#99ccff,var(--blue))"></div><div class="hp-text"><span id="score-p2">0</span> ğŸŒ¸</div></div><canvas class="vs-canvas" id="canvas-p2"></canvas></div>
            </div>
        </div>

        <div id="view-review"><div style="text-align:center;color:#999;margin-top:20px;">ç­‰å¾…è³‡æ–™å‚³å›æ¯è‰¦...</div></div>
    </div>

<script>
    // ======================================================
    // æ‚¨çš„ Google Apps Script ç¶²å€
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwfhsDnhuEOcot-1nVxTKNxES0RJOorsnvYWeOZtuCzGyXBxbHnT82KzEXmD1WEj0I5Eg/exec";
    // ======================================================

    const PASSWORD_HASH = "94cd2e23b72c91350a5170cfd037a342372c3d9050d26989439c2794776b9777";
    async function checkPassword(input) { return input === "0118"; }

    const MQTT_BROKER = 'wss://broker.hivemq.com:8884/mqtt';
    const TARGET_SCORE = 2000;
    
    // çš®å…‹æ•é¡è‰²åº« (ä¾›éš¨æ©Ÿåˆ†é…)
    const PIKMIN_COLORS = ['#ea4e3d', '#4da6ff', '#f2d636', '#8e44ad', '#e91e63', '#7f8c8d', '#ecf0f1'];

    let client = null, myRole = '', classCode = '', selectedSeat = null, maxSeats = 35;
    let playerData = { name: '', score: 0, currentInput: '', q: {}, lastLine: null, history: [], color: '#ea4e3d' };
    let classState = {}, questionStats = {}, gameState = 'WAITING';
    let currentView = 'screens', versusP1 = 1, versusP2 = 2;
    let timerInterval = null, remainingTime = 300;

    const seatContainer = document.getElementById('seat-container');
    for(let i=1; i<=35; i++){
        let b = document.createElement('div'); b.className = 'seat-btn'; b.innerText = i;
        b.onclick = () => { document.querySelectorAll('.seat-btn').forEach(el=>el.classList.remove('selected')); b.classList.add('selected'); selectedSeat = i; }
        seatContainer.appendChild(b);
    }

    function switchRole(role) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById('form-student').style.display = role === 'student' ? 'block' : 'none';
        document.getElementById('form-teacher').style.display = role === 'teacher' ? 'block' : 'none';
    }

    function connectMQTT(code, onConnect) {
        const clientId = 'pikmin_' + Math.random().toString(16).substr(2, 8);
        client = mqtt.connect(MQTT_BROKER, { clientId: clientId });
        client.on('connect', () => {
            if(myRole === 'student') {
                document.getElementById('s-status-dot').classList.add('status-connected');
                document.getElementById('s-status-text').innerText = "å·²é€£çµæ¯è‰¦";
                document.getElementById('s-status-text').style.color = "#51cf66";
            }
            onConnect();
        });
        client.on('message', (topic, msg) => handleMessage(topic, msg.toString()));
    }

    function handleMessage(topic, payload) {
        const parts = topic.split('/'); const type = parts[2];
        if (myRole === 'student') {
            if (type === 'status') {
                let cmd = {}; try { cmd = JSON.parse(payload); } catch(e) { cmd = { action: payload }; }
                if(cmd.action === 'START') {
                    if(cmd.duration) remainingTime = cmd.duration;
                    document.getElementById('waiting-room').style.display = 'none'; 
                    document.getElementById('paused-overlay').style.display = 'none'; 
                    document.getElementById('game-interface').style.display = 'flex';
                    if(playerData.history.length === 0) { resizeStudentCanvas(); newQuestion(); }
                    startLocalTimer();
                } else if (cmd.action === 'PAUSE') { clearInterval(timerInterval); document.getElementById('paused-overlay').style.display = 'flex';
                } else if (cmd.action === 'RESUME') { document.getElementById('paused-overlay').style.display = 'none'; startLocalTimer();
                } else if (cmd.action === 'STOP') { clearInterval(timerInterval); endGameForStudent(); }
            } else if (type === 'config') { updateSeatLimit(JSON.parse(payload).maxSeats); }
        } else if (myRole === 'teacher') {
            if (type === 'data') updateTeacherScreen(parts[3], JSON.parse(payload));
            if (type === 'log') recordAnswerLog(JSON.parse(payload));
        }
    }

    function startLocalTimer() {
        if(timerInterval) clearInterval(timerInterval);
        updateTimerDisplay(); 
        timerInterval = setInterval(() => {
            if(remainingTime > 0) { remainingTime--; updateTimerDisplay(); }
            else { clearInterval(timerInterval); if(myRole === 'teacher') sendSignal('STOP'); }
        }, 1000);
    }

    function updateTimerDisplay() {
        const m = Math.floor(remainingTime / 60).toString().padStart(2, '0');
        const s = (remainingTime % 60).toString().padStart(2, '0');
        const str = `${m}:${s}`;
        if(myRole === 'student') document.getElementById('g-timer').innerText = str;
        if(myRole === 'teacher') document.getElementById('t-live-timer').innerText = str;
    }

    // === è€å¸«ç«¯ ===
    async function teacherLogin() {
        const code = document.getElementById('t-code').value.trim().toUpperCase();
        const pass = document.getElementById('t-pass').value.trim();
        const limitVal = document.getElementById('t-limit').value;
        maxSeats = parseInt(limitVal) || 35;

        if (!code) return alert("è«‹è¨­å®šä»£ç¢¼");
        if (!await checkPassword(pass)) return alert("å¯†ç¢¼éŒ¯èª¤");

        myRole = 'teacher'; classCode = code;
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('teacher-dashboard').style.display = 'flex';
        document.getElementById('dash-code').innerText = code;

        initTeacherUI();
        connectMQTT(code, () => {
            client.subscribe(`game/${code}/data/+`); client.subscribe(`game/${code}/log`);
            setInterval(() => client.publish(`game/${code}/config`, JSON.stringify({ maxSeats }), {retain: true}), 2000);
        });
        updateControlButtons('WAITING');
    }

    function initTeacherUI() {
        const wall = document.getElementById('monitor-wall'); wall.innerHTML = "";
        const lbContent = document.getElementById('lb-content'); lbContent.innerHTML = "";
        const s1 = document.getElementById('sel-p1'), s2 = document.getElementById('sel-p2'); s1.innerHTML=""; s2.innerHTML="";

        for(let i=1; i<=maxSeats; i++){
            let card = document.createElement('div'); card.className = 'student-card'; card.id = `card-${i}`;
            card.innerHTML = `<div class="mini-hud"><span style="color:#666">#${i}</span><span id="name-${i}" style="color:var(--blue)">...</span><span id="score-${i}" style="color:var(--red)">0</span></div><canvas class="mini-canvas" id="mini-${i}"></canvas><div class="mini-input-preview" id="input-${i}">?</div>`;
            wall.appendChild(card);
            
            let row = document.createElement('div'); row.className = 'lb-row'; row.id = `lb-row-${i}`; row.style.display = 'none';
            row.innerHTML = `<span style="width:30px;color:var(--purple);font-weight:bold;" id="lb-pos-${i}">-</span><span style="width:80px;overflow:hidden;white-space:nowrap" id="lb-name-${i}">...</span><div class="lb-bar-bg"><div class="lb-bar" id="lb-bar-${i}"></div></div><span id="lb-score-${i}">0</span>`;
            lbContent.appendChild(row);

            let op1 = document.createElement('option'); op1.value=i; op1.innerText=`#${i}`; s1.appendChild(op1);
            let op2 = document.createElement('option'); op2.value=i; op2.innerText=`#${i}`; s2.appendChild(op2);
        }
        s1.value=1; s2.value=2; updateVersusSelection();
    }

    function sendSignal(action) {
        let payload = { action: action };
        if(action === 'START') {
            const mins = parseInt(document.getElementById('t-input-min').value) || 5;
            remainingTime = mins * 60; payload.duration = remainingTime;
            gameState = 'RUNNING'; startLocalTimer();
        } 
        else if (action === 'PAUSE') { gameState = 'PAUSED'; clearInterval(timerInterval); } 
        else if (action === 'RESUME') { gameState = 'RUNNING'; startLocalTimer(); } 
        else if (action === 'STOP') { gameState = 'ENDED'; clearInterval(timerInterval); switchView('review'); }

        client.publish(`game/${classCode}/status`, JSON.stringify(payload), { retain: true });
        updateControlButtons(gameState);
    }

    function updateControlButtons(state) {
        const btnStart = document.getElementById('btn-c-start');
        const runningGroup = document.getElementById('running-controls');
        const btnPause = document.getElementById('btn-c-pause');
        const btnResume = document.getElementById('btn-c-resume');
        const timerSetup = document.getElementById('t-timer-setup');
        const liveTimer = document.getElementById('t-live-timer');

        if(state === 'WAITING') {
            btnStart.style.display = 'block'; runningGroup.style.display = 'none';
            timerSetup.style.display = 'flex'; liveTimer.style.display = 'none';
        } else {
            btnStart.style.display = 'none'; runningGroup.style.display = 'flex';
            timerSetup.style.display = 'none'; liveTimer.style.display = 'block';
            if(state === 'RUNNING') { btnPause.style.display = 'block'; btnResume.style.display = 'none'; } 
            else if (state === 'PAUSED') { btnPause.style.display = 'none'; btnResume.style.display = 'block'; }
        }
    }
    function confirmEnd() { if(confirm("ç¢ºå®šçµæŸä¸¦çµç®—ï¼Ÿ")) sendSignal('STOP'); }

    function switchView(mode) {
        currentView = mode;
        ['screens', 'versus', 'review'].forEach(v => {
            document.getElementById(`view-${v}`).style.display = (v === mode) ? (v==='screens'?'flex':'block') : 'none';
            if(document.getElementById(`btn-${v}`)) document.getElementById(`btn-${v}`).classList.toggle('active', v === mode);
        });
        if(mode === 'versus') updateVersusSelection();
        if(mode === 'review') renderReview();
    }

    function updateTeacherScreen(id, data) {
        if(id > maxSeats) return;
        classState[id] = data; 
        document.getElementById(`card-${id}`).classList.add('active');
        const card = document.getElementById(`card-${id}`);
        
        // æ ¹æ“šå­¸ç”Ÿé¡è‰²æ”¹è®Šå¡ç‰‡é‚Šæ¡†
        if(data.color) card.style.borderColor = data.color;

        document.getElementById(`name-${id}`).innerText = data.name;
        document.getElementById(`score-${id}`).innerText = data.score;
        document.getElementById(`input-${id}`).innerText = data.input || "?";
        const cvs = document.getElementById(`mini-${id}`);
        if(cvs && cvs.offsetParent !== null) { if(cvs.width !== cvs.clientWidth) { cvs.width = cvs.clientWidth; cvs.height = cvs.clientHeight; } drawScene(cvs.getContext('2d'), cvs.width, cvs.height, data.q, data.input, null, data.color); }
        if(currentView === 'versus' && (parseInt(id)===versusP1 || parseInt(id)===versusP2)) updateVersusSelection();
        updateLeaderboard();
    }

    function updateVersusSelection() {
        versusP1 = parseInt(document.getElementById('sel-p1').value);
        versusP2 = parseInt(document.getElementById('sel-p2').value);
        [versusP1, versusP2].forEach((pid, idx) => {
            const data = classState[pid];
            if(data) {
                const slot = idx+1;
                document.getElementById(`sel-p${slot}`).options[document.getElementById(`sel-p${slot}`).selectedIndex].text = `#${pid} ${data.name}`;
                const hp = Math.min((data.score / TARGET_SCORE) * 100, 100);
                document.getElementById(`hp-p${slot}`).style.width = hp + "%";
                document.getElementById(`score-p${slot}`).innerText = data.score;
                const cvs = document.getElementById(`canvas-p${slot}`);
                if(cvs) { cvs.width = cvs.clientWidth; cvs.height = cvs.clientHeight; drawScene(cvs.getContext('2d'), cvs.width, cvs.height, data.q, data.input, null, data.color); }
            }
        });
    }

    function updateLeaderboard() {
        let players = []; for(let id in classState) players.push({id:id, ...classState[id]});
        players.sort((a,b) => b.score - a.score);
        players.forEach((p, index) => {
            const row = document.getElementById(`lb-row-${p.id}`);
            if(row) {
                row.style.display = 'flex'; row.style.order = index;
                document.getElementById(`lb-pos-${p.id}`).innerText = index+1;
                document.getElementById(`lb-name-${p.id}`).innerText = p.name;
                document.getElementById(`lb-score-${p.id}`).innerText = p.score;
                document.getElementById(`lb-bar-${p.id}`).style.width = Math.min((p.score/TARGET_SCORE)*100, 100) + "%";
            }
        });
    }

    function recordAnswerLog(data) {
        if (!questionStats[data.qId]) questionStats[data.qId] = { text: data.qText, ans: data.ans, correct: 0, wrong: 0, wrongAns: {} };
        if (data.isCorrect) questionStats[data.qId].correct++;
        else { questionStats[data.qId].wrong++; const w = data.input; if(!questionStats[data.qId].wrongAns[w]) questionStats[data.qId].wrongAns[w]=0; questionStats[data.qId].wrongAns[w]++; }
    }

    function renderReview() {
        const container = document.getElementById('view-review'); container.innerHTML = "<h2 style='text-align:center;color:#444'>ğŸ“‹ æ¢éšªå ±å‘Š</h2>";
        let arr = []; for(let k in questionStats) { let item = questionStats[k]; let total = item.correct + item.wrong; if(total>0) { item.errRate = (item.wrong/total)*100; arr.push(item); } }
        arr.sort((a,b) => b.errRate - a.errRate);
        if(arr.length === 0) { container.innerHTML += "<p style='text-align:center'>æš«ç„¡æ•¸æ“š</p>"; return; }
        arr.forEach((item, idx) => {
            let wList = Object.entries(item.wrongAns).sort((a,b)=>b[1]-a[1]); let wText = wList.length > 0 ? `(èª¤ç­”: ${wList[0][0]})` : "";
            container.innerHTML += `<div class="error-card"><div class="error-info"><div style="color:var(--dark); margin-bottom:5px;">#${idx+1}: ${item.text}</div><div style="font-size:16px; color:#888;">æ­£è§£: <span style="color:var(--green)">${item.ans}</span> <span style="color:var(--red); margin-left:10px;">${wText}</span></div><div class="bar-bg"><div class="bar-fill" style="width:${item.errRate}%"></div></div></div><div class="error-stat"><div style="font-size:24px; color:var(--red)">${Math.round(item.errRate)}%</div><div style="font-size:12px">éŒ¯èª¤ç‡</div></div></div>`;
        });
    }

    // === å­¸ç”Ÿ ===
    function studentLogin() {
        const codeInput = document.getElementById('s-code').value.trim();
        const code = codeInput.toUpperCase(); 
        const name = document.getElementById('s-name').value.trim();
        if(!code || !name || !selectedSeat) return alert("è«‹å¡«å¯«å®Œæ•´");
        
        myRole='student'; classCode=code; playerData.name=name;
        // éš¨æ©ŸæŒ‡æ´¾é¡è‰²
        playerData.color = PIKMIN_COLORS[Math.floor(Math.random() * PIKMIN_COLORS.length)];

        document.getElementById('login-screen').style.display='none'; 
        document.getElementById('waiting-room').style.display='flex';
        
        connectMQTT(code, ()=>{
            client.subscribe(`game/${code}/status`);
            client.subscribe(`game/${code}/config`);
            setInterval(sendStudentData, 800);
        });
    }
    
    function updateSeatLimit(limit) {
        for(let i=1; i<=35; i++) { const btn = document.getElementById(`seat-btn-${i}`); if(i>limit) btn.classList.add('disabled'); else btn.classList.remove('disabled'); }
    }

    function sendStudentData() {
        if(myRole!=='student'||!client) return;
        client.publish(`game/${classCode}/data/${selectedSeat}`, JSON.stringify({ 
            name:playerData.name, score:playerData.score, q:playerData.q, input:playerData.currentInput, color: playerData.color 
        }));
    }

    function endGameForStudent() {
        document.getElementById('game-interface').style.display = 'none'; document.getElementById('paused-overlay').style.display = 'none'; document.getElementById('analysis-room').style.display = 'flex';
        const completion = Math.min((playerData.score / TARGET_SCORE) * 100, 100).toFixed(0);
        document.getElementById('final-score').innerText = playerData.score; document.getElementById('final-rate').innerText = completion + "%";
        const list = document.getElementById('student-error-list'); list.innerHTML = "";
        const wrongs = playerData.history.filter(h => !h.isCorrect);
        if (wrongs.length === 0) list.innerHTML = "<div style='color:var(--green);text-align:center'>ğŸŒŸ å®Œç¾ï¼å…¨å°ï¼</div>";
        else wrongs.forEach(w => list.innerHTML += `<div class="analysis-item"><div style="color:#888;">${w.qText}</div><div><span class="tag-wrong">ç­”:${w.input}</span> <span class="tag-correct">æ­£:${w.ans}</span></div></div>`);
        uploadToGoogle(completion, wrongs);
    }

    function retryUpload() {
        const completion = document.getElementById('final-rate').innerText.replace('%','');
        const wrongs = playerData.history.filter(h => !h.isCorrect);
        uploadToGoogle(completion, wrongs);
    }

    function uploadToGoogle(completion, wrongs) {
        const statusEl = document.getElementById('upload-status'); const retryBtn = document.getElementById('retry-btn');
        statusEl.innerText = "ğŸš€ å‚³é€è³‡æ–™å›æ¯è‰¦..."; statusEl.style.color = "#aaa"; retryBtn.style.display = "none";
        const mistakes = wrongs.map(h => ({ q: h.qText, input: h.input, ans: h.ans }));
        const dataObj = { name: playerData.name, seat: selectedSeat, score: playerData.score, completion: completion, mistakes: mistakes };
        
        fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain' },
            body: JSON.stringify(dataObj)
        }).then(() => {
            statusEl.innerText = "âœ… å‚³é€æˆåŠŸï¼"; statusEl.style.color = "#4caf50";
        }).catch(err => {
            console.error(err); statusEl.innerText = "âŒ å‚³é€å¤±æ•—"; statusEl.style.color = "#ff5252"; retryBtn.style.display = "inline-block";
        });
    }

    function newQuestion() {
        const isC = Math.random() < 0.2; let s, b, x, qStr;
        if(isC) { s=0; b=Math.floor(Math.random()*9)-4; x=Math.floor(Math.random()*9)-4; qStr=`å¸¸æ•¸å‡½æ•¸ y=${b}, x=${x}`; playerData.q={slope:0,b,x,ans:b}; } 
        else { s=Math.floor(Math.random()*5)-2||1; b=Math.floor(Math.random()*9)-4; x=Math.floor(Math.random()*9)-4; let sign = b>=0?'+':''; qStr=`y=${s}x${sign}${b}, x=${x}`; playerData.q={slope:s,b,x,ans:s*x+b}; }
        playerData.qStr = qStr; document.getElementById('q-text').innerHTML = `${qStr} <br> y = ?`; playerData.currentInput=""; document.getElementById('input-display').innerText="?"; drawStudentScene();
    }

    function inputNum(v) { if(v==='C') playerData.currentInput=""; else if(playerData.currentInput.length<5) playerData.currentInput+=v; document.getElementById('input-display').innerText = playerData.currentInput||"?"; drawStudentScene(); sendStudentData(); }

    function submitAnswer() {
        let v = parseInt(playerData.currentInput); if(isNaN(v)) return;
        const isCorrect = (v===playerData.q.ans);
        playerData.history.push({ qText: playerData.qStr, ans: playerData.q.ans, input: v, isCorrect: isCorrect });
        if(client) client.publish(`game/${classCode}/log`, JSON.stringify({ qId: playerData.qStr, qText: playerData.qStr, ans: playerData.q.ans, input: v, isCorrect: isCorrect }));
        if(isCorrect) { playerData.score+=100; playerData.lastLine={slope:playerData.q.slope,b:playerData.q.b,color:"#76c043"}; document.getElementById('feedback').innerText="ğŸŒ¸ é–‹èŠ±!"; document.getElementById('feedback').style.color="#76c043"; setTimeout(newQuestion,1000); } 
        else { playerData.score=Math.max(0,playerData.score-50); playerData.lastLine={slope:playerData.q.slope,b:playerData.q.b,color:"#ea4e3d",errY:v}; document.getElementById('feedback').innerText="ğŸ‚ å“å‘€!"; document.getElementById('feedback').style.color="#ea4e3d"; }
        document.getElementById('g-score').innerText = playerData.score; drawStudentScene(); sendStudentData();
    }

    function drawScene(ctx, w, h, q, input, lastLine, colorOverride) {
        const cx=w/2, cy=h/2, scale=w/18; ctx.clearRect(0,0,w,h); 
        ctx.strokeStyle="#ddd"; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(0,cy); ctx.lineTo(w,cy); ctx.stroke(); ctx.beginPath(); ctx.moveTo(cx,0); ctx.lineTo(cx,h); ctx.stroke();
        
        // ä½¿ç”¨æŒ‡æ´¾çš„çš®å…‹æ•é¡è‰²ï¼Œè‹¥ç„¡å‰‡é è¨­ç´…
        const pikminColor = colorOverride || playerData.color || "#ea4e3d";

        if(q && q.x !== undefined) {
            const tx=cx+q.x*scale, ty=cy-q.ans*scale; ctx.fillStyle=pikminColor; ctx.beginPath(); ctx.arc(tx,ty,w/40,0,Math.PI*2); ctx.fill();
            if(input && !isNaN(input)) { let v = parseInt(input); let tb = v - q.slope*q.x; ctx.strokeStyle="#4da6ff"; ctx.lineWidth=2; ctx.setLineDash([4,2]); ctx.beginPath(); let x1=-10, y1=q.slope*x1+tb, x2=10, y2=q.slope*x2+tb; ctx.moveTo(cx+x1*scale, cy-y1*scale); ctx.lineTo(cx+x2*scale, cy-y2*scale); ctx.stroke(); ctx.setLineDash([]); }
        }
        if(lastLine) {
            ctx.strokeStyle=lastLine.color; ctx.lineWidth=4; ctx.beginPath(); let x1=-10, y1=lastLine.slope*x1+lastLine.b, x2=10, y2=lastLine.slope*x2+lastLine.b; ctx.moveTo(cx+x1*scale, cy-y1*scale); ctx.lineTo(cx+x2*scale, cy-y2*scale); ctx.stroke();
            if(lastLine.color==="#ea4e3d") { ctx.fillStyle="#444"; ctx.beginPath(); ctx.arc(cx+q.x*scale, cy-lastLine.errY*scale, 6,0,Math.PI*2); ctx.fill(); }
        }
    }
    function drawStudentScene() { const cvs=document.getElementById('s-canvas'); drawScene(cvs.getContext('2d'),cvs.width,cvs.height,playerData.q,playerData.currentInput,playerData.lastLine); }
    function resizeStudentCanvas() { const w = document.getElementById('s-canvas-wrap'); const c = document.getElementById('s-canvas'); c.width=w.clientWidth; c.height=w.clientHeight; drawStudentScene(); }
    window.addEventListener('resize', resizeStudentCanvas);
    window.addEventListener('keydown', (e)=>{ if(e.key==='F2') document.getElementById('teacher-dashboard').style.display='flex'; });
</script>
</body>
</html>
